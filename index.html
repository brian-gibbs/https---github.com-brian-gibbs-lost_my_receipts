<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Recreator | Lost Receipts Instantly Generated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/marked@4.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4F4FBD',
                        dark: '#1a1b23',
                        darker: '#13141a',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #1a1b23;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .price-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .price-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .receipt-preview {
            position: relative;
        }
        .receipt-preview.basic::after {
            content: "PREVIEW";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 4rem;
            font-weight: bold;
            color: rgba(255, 0, 0, 0.2);
            pointer-events: none;
        }
        .step-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 24px;
        }
        .btn-primary {
            background-color: #5D5CDE;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #4F4FBD;
        }
        .gradient-bg {
            background: linear-gradient(to bottom, rgba(26,27,35,0.9) 0%, rgba(26,27,35,1) 100%);
        }
        .receipt-text {
            color: #000 !important;
            font-weight: normal !important;
        }
        
        .download-receipt img, .download-receipt canvas {
            color: #000 !important;
        }
        
        /* Premium receipt styles */
        .uber-receipt {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .hilton-receipt {
            font-family: 'Georgia', serif;
        }
        
        .marriott-receipt {
            font-family: 'Arial', sans-serif;
        }
        
        .avis-receipt {
            font-family: 'Helvetica', sans-serif;
        }
        
        .toll-receipt {
            font-family: 'Arial', sans-serif;
        }
        
        /* Enhanced Premium Receipt Styles - Based on real examples */
        
        /* Base receipt style */
        .premium-receipt {
            font-family: 'Courier New', monospace;
            padding: 15px;
            line-height: 1.3;
            position: relative;
            color: #000 !important;
        }
        
        /* Restaurant receipt style (Jack Stack) */
        .restaurant-receipt {
            font-family: 'Courier New', monospace;
            padding: 10px;
            line-height: 1.2;
            text-align: left;
            max-width: 350px;
            margin: 0 auto;
            color: #000 !important;
        }
        
        .restaurant-receipt .header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .restaurant-receipt .divider {
            border-top: 1px dashed #aaa;
            margin: 8px 0;
        }
        
        /* Uber Eats receipt style */
        .uber-eats-receipt {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            background-color: #e9ffe9;
            border-radius: 8px;
            max-width: 400px;
            margin: 0 auto;
            color: #000 !important;
        }
        
        .uber-eats-receipt .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .uber-eats-receipt .title {
            font-size: 24px;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .uber-eats-receipt .item {
            margin-bottom: 15px;
        }
        
        .uber-eats-receipt .divider {
            border-top: 1px solid #ddd;
            margin: 15px 0;
        }
        
        .uber-eats-receipt .payment-method {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        /* Uber ride receipt style */
        .uber-receipt {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 20px;
            background-color: #f0f5f9;
            border-radius: 8px;
            max-width: 400px;
            margin: 0 auto;
            color: #000 !important;
        }
        
        .uber-receipt .header {
            margin-bottom: 30px;
        }
        
        .uber-receipt .title {
            font-size: 28px;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .uber-receipt .car-icon {
            float: right;
            width: 100px;
            height: auto;
            margin-top: 20px;
        }
        
        /* Hotel receipt (Marriott) style */
        .marriott-receipt {
            font-family: Arial, sans-serif;
            padding: 25px;
            border: 1px solid #ddd;
            max-width: 750px;
            margin: 0 auto;
            color: #000 !important;
        }
        
        .marriott-receipt .logo {
            max-width: 200px;
            margin-bottom: 20px;
        }
        
        .marriott-receipt .header {
            margin-bottom: 30px;
        }
        
        .marriott-receipt .guest-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            margin-bottom: 20px;
        }
        
        .marriott-receipt .charges {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        
        .marriott-receipt .charges th, 
        .marriott-receipt .charges td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        /* Hotel receipt (Hilton) style */
        .hilton-receipt {
            font-family: Georgia, serif;
            padding: 20px;
            color: #000 !important;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .hilton-receipt .guest-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .hilton-receipt h3 {
            color: #004080 !important;
            margin-bottom: 10px;
        }
        
        /* Car rental receipt (Avis) style */
        .avis-receipt {
            font-family: Helvetica, Arial, sans-serif;
            color: #000 !important;
            border: 1px solid #cd0000;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .avis-receipt .header {
            background-color: #cd0000;
            color: white !important;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .avis-receipt .section {
            border: 1px solid #ddd;
            margin: 10px;
            padding: 10px;
        }
        
        .avis-receipt .section-header {
            background-color: #cd0000;
            color: white !important;
            padding: 8px;
            font-weight: bold;
        }
        
        .avis-receipt .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 10px;
        }
        
        /* Toll/Mileage receipts */
        .toll-receipt {
            font-family: Arial, sans-serif;
            color: #000 !important;
            max-width: 600px;
            margin: 0 auto;
            border: 1px solid #ddd;
            padding: 20px;
        }
        
        .toll-receipt .header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .mileage-receipt {
            font-family: Arial, sans-serif;
            color: #000 !important;
            max-width: 700px;
            margin: 0 auto;
            border: 1px solid #ddd;
            padding: 20px;
        }
        
        .mileage-receipt table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }
        
        .mileage-receipt th,
        .mileage-receipt td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .mileage-receipt th {
            background-color: #f5f5f5;
        }

        /* Custom slider styles */
        .custom-range {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #4a4a5e;
            outline: none;
            border-radius: 10px;
        }

        .custom-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: #5D5CDE;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }

        .custom-range::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: #5D5CDE;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <!-- Header/Nav -->
    <header class="border-b border-gray-800 bg-dark sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="#" class="text-primary font-bold text-2xl">Receipt Recreator</a>
            <div class="flex items-center space-x-4">
                <span id="authStatus" class="text-sm">Not signed in</span>
                <button id="signInButton" class="text-xs bg-secondary hover:bg-primary text-white px-3 py-1 rounded-md">Sign In</button>
                <button id="signOutButton" class="text-xs bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md hidden">Sign Out</button>
                <span id="creditDisplay" class="text-sm">Credits: <span id="creditCount">0</span></span>
                <button id="buyCreditsButton" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-md text-sm">Buy Credits</button>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="py-16 gradient-bg">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Lost a Receipt? Recreate It Instantly.</h1>
            <p class="text-xl md:text-2xl mb-8 max-w-3xl mx-auto text-gray-300">Perfect for expense reports (Concur, etc.), tax deductions (IRS), or personal records. Fast, simple, and accurate.</p>
            <a href="#generator" class="btn-primary font-bold py-3 px-8 rounded-md text-lg inline-block transition">Get Started Now</a>
        </div>
    </section>

    <!-- How It Works Section -->
    <section class="py-16 bg-gray-900">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">Simple Receipt Generation</h2>
            
            <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                <div class="text-center">
                    <div class="step-icon bg-primary rounded-full">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">1. Input Data</h3>
                    <p class="text-gray-400">Paste details from Concur/notes OR use our manual entry form.</p>
                </div>
                
                <div class="text-center">
                    <div class="step-icon bg-primary rounded-full">
                        <i class="fas fa-cog"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">2. Set Defaults</h3>
                    <p class="text-gray-400">Configure optional allowances and a default tax rate.</p>
                </div>
                
                <div class="text-center">
                    <div class="step-icon bg-primary rounded-full">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">3. Generate</h3>
                    <p class="text-gray-400">Create realistic receipts and download as PNG or PDF.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Generator Tool Section -->
    <section id="generator" class="py-12 bg-dark">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8">Receipt Generator Tool</h2>
            <p id="creditInfo" class="text-center mb-6">You have <span id="availableCredits">0</span> credit(s) remaining. 1 credit is used per basic receipt, 2 credits for premium receipts.</p>
            
            <div class="grid md:grid-cols-5 gap-6 max-w-6xl mx-auto">
                <!-- Left Panel (20%) -->
                <div class="md:col-span-1 bg-gray-800 rounded-lg shadow-md p-4">
                    <h3 class="font-semibold text-lg border-b border-gray-700 pb-2 mb-4">Optional Defaults & Settings</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Default Name</label>
                            <input type="text" id="customerName" placeholder="Your name" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Default Tax Location</label>
                            <select id="stateSelect" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm mb-2">
                                <option value="">Select State</option>
                                <option value="CA">California</option>
                                <option value="TX">Texas</option>
                                <option value="NY">New York</option>
                                <option value="FL">Florida</option>
                                <option value="IL">Illinois</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="OH">Ohio</option>
                                <option value="GA">Georgia</option>
                                <option value="NC">North Carolina</option>
                                <option value="MI">Michigan</option>
                                <option value="MO">Missouri</option>
                                <option value="KS">Kansas</option>
                            </select>
                            
                            <select id="citySelect" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm">
                                <option value="">Select City</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Tax Rate (%)</label>
                            <input type="number" id="taxRate" value="8.25" min="0" max="20" step="0.01" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Payment Method</label>
                            <select id="paymentCardType" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm mb-2">
                                <option value="AMEX">American Express</option>
                                <option value="VISA">Visa</option>
                                <option value="MC">MasterCard</option>
                                <option value="DISC">Discover</option>
                                <option value="Apple Pay">Apple Pay</option>
                                <option value="Corporate Card">Corporate Card</option>
                                <option value="Cash">Cash</option>
                            </select>
                            <div class="flex items-center">
                                <input type="text" id="paymentLastFour" placeholder="Last 4 digits" maxlength="4" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm" 
                                       pattern="[0-9]{4}" title="Please enter 4 digits only">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Loyalty Programs</label>
                            <div class="grid grid-cols-2 gap-2 mb-2">
                                <select id="loyaltyProgram1" class="w-full rounded-md border-gray-600 bg-gray-700 text-xs">
                                    <option value="">Select Program</option>
                                    <option value="Hilton Honors">Hilton Honors</option>
                                    <option value="Marriott Bonvoy">Marriott Bonvoy</option>
                                    <option value="IHG One">IHG One Rewards</option>
                                    <option value="World of Hyatt">World of Hyatt</option>
                                    <option value="AAdvantage">American AAdvantage</option>
                                    <option value="Delta SkyMiles">Delta SkyMiles</option>
                                    <option value="Avis Preferred">Avis Preferred</option>
                                    <option value="Hertz Gold">Hertz Gold Plus</option>
                                    <option value="Enterprise Plus">Enterprise Plus</option>
                                    <option value="Other">Other</option>
                                </select>
                                <input type="text" id="loyaltyNumber1" placeholder="Number" class="w-full rounded-md border-gray-600 bg-gray-700 text-xs">
                            </div>
                            <div id="otherLoyaltyProgram1" class="hidden mb-2">
                                <input type="text" id="otherLoyaltyName1" placeholder="Program name" class="w-full rounded-md border-gray-600 bg-gray-700 text-xs mb-1">
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <select id="loyaltyProgram2" class="w-full rounded-md border-gray-600 bg-gray-700 text-xs">
                                    <option value="">Select Program</option>
                                    <option value="Hilton Honors">Hilton Honors</option>
                                    <option value="Marriott Bonvoy">Marriott Bonvoy</option>
                                    <option value="IHG One">IHG One Rewards</option>
                                    <option value="World of Hyatt">World of Hyatt</option>
                                    <option value="AAdvantage">American AAdvantage</option>
                                    <option value="Delta SkyMiles">Delta SkyMiles</option>
                                    <option value="Avis Preferred">Avis Preferred</option>
                                    <option value="Hertz Gold">Hertz Gold Plus</option>
                                    <option value="Enterprise Plus">Enterprise Plus</option>
                                    <option value="Other">Other</option>
                                </select>
                                <input type="text" id="loyaltyNumber2" placeholder="Number" class="w-full rounded-md border-gray-600 bg-gray-700 text-xs">
                            </div>
                            <div id="otherLoyaltyProgram2" class="hidden mt-1">
                                <input type="text" id="otherLoyaltyName2" placeholder="Program name" class="w-full rounded-md border-gray-600 bg-gray-700 text-xs">
                            </div>
                        </div>
                        
                        <div class="space-y-2 pt-2 border-t border-gray-700">
                            <details>
                                <summary class="text-sm font-medium cursor-pointer">Trip & Toll/Mileage Details</summary>
                                <div class="pt-2 space-y-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs">Home Base</label>
                                            <input type="text" id="homeBase" class="w-full text-xs rounded-md border-gray-600 bg-gray-700" 
                                                   placeholder="Your office/home city">
                                        </div>
                                        <div>
                                            <label class="block text-xs">End Odometer</label>
                                            <input type="number" id="endOdometer" min="0" class="w-full text-xs rounded-md border-gray-600 bg-gray-700"
                                                   placeholder="Current mileage">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs">Vehicle Make</label>
                                            <input type="text" id="vehicleMake" placeholder="Toyota, Ford, etc." class="w-full text-xs rounded-md border-gray-600 bg-gray-700">
                                        </div>
                                        <div>
                                            <label class="block text-xs">Vehicle Model</label>
                                            <input type="text" id="vehicleModel" placeholder="Camry, F-150, etc." class="w-full text-xs rounded-md border-gray-600 bg-gray-700">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs">Toll Pass System</label>
                                        <select id="tollPassSystem" class="w-full text-xs rounded-md border-gray-600 bg-gray-700">
                                            <option value="E-ZPass">E-ZPass (Eastern US)</option>
                                            <option value="SunPass">SunPass (FL, GA, NC)</option>
                                            <option value="FasTrak">FasTrak (California)</option>
                                            <option value="TxTag">TxTag (TX, KS, OK)</option>
                                            <option value="I-Pass">I-Pass (Illinois)</option>
                                            <option value="PeachPass">PeachPass (Georgia)</option>
                                            <option value="NC Quick Pass">NC Quick Pass (North Carolina)</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </details>
                            
                            <details class="pt-1">
                                <summary class="text-sm font-medium cursor-pointer">Receipt Quality</summary>
                                <div class="pt-2 space-y-2">
                                    <div class="flex items-center">
                                        <input type="radio" name="receiptQuality" id="basicQuality" value="basic" checked class="h-4 w-4 text-primary">
                                        <label for="basicQuality" class="ml-2 text-xs">Basic (1 credit)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" name="receiptQuality" id="proQuality" value="pro" class="h-4 w-4 text-primary">
                                        <label for="proQuality" class="ml-2 text-xs">Premium (2 credits)</label>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Premium quality offers enhanced details and branded receipt templates</p>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
                
                <!-- Right Panel (80%) -->
                <div class="md:col-span-4 bg-gray-800 rounded-lg shadow-md p-4">
                    <div>
                        <ul class="flex border-b border-gray-700">
                            <li class="mr-1">
                                <a href="#" id="pasteTabLink" class="inline-block px-4 py-2 border-l border-t border-r rounded-t font-medium text-primary bg-gray-800">Paste Data</a>
                            </li>
                            <li class="mr-1">
                                <a href="#" id="manualTabLink" class="inline-block px-4 py-2 border-l border-t border-r rounded-t text-gray-400 hover:text-primary">Manual Entry</a>
                            </li>
                            <li class="mr-1">
                                <a href="#" id="mileageTabLink" class="inline-block px-4 py-2 border-l border-t border-r rounded-t text-gray-400 hover:text-primary">Mileage & Tolls</a>
                            </li>
                        </ul>
                        
                        <!-- Paste Tab Content -->
                        <div id="pasteTabContent" class="mt-4">
                            <div class="mb-4">
                                <label for="expenseInput" class="block mb-1 font-medium">Paste Concur Expense Data</label>
                                <textarea id="expenseInput" rows="8" placeholder="Paste your Concur expense data here..." class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary"></textarea>
                            </div>
                            
                            <div class="mb-4">
                                <button id="parseButton" class="bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded">
                                    Parse Expenses
                                </button>
                            </div>
                        </div>
                        
                        <!-- Manual Entry Tab Content -->
                        <div id="manualTabContent" class="mt-4 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="manualVendor" class="block mb-1 font-medium">Vendor/Merchant</label>
                                    <input type="text" id="manualVendor" placeholder="e.g., Uber, Hilton, Avis" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label for="manualLocation" class="block mb-1 font-medium">Location</label>
                                    <input type="text" id="manualLocation" placeholder="e.g., Kansas City, Missouri" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label for="manualDate" class="block mb-1 font-medium">Date</label>
                                    <input type="date" id="manualDate" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label for="manualAmount" class="block mb-1 font-medium">Amount</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="text-gray-400">$</span>
                                        </div>
                                        <input type="number" id="manualAmount" placeholder="0.00" step="0.01" min="0" class="w-full pl-7 px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="manualType" class="block mb-1 font-medium">Expense Type</label>
                                    <select id="manualType" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                        <option value="Individual- Dinner">Dinner</option>
                                        <option value="Individual- Lunch">Lunch</option>
                                        <option value="Individual- Breakfast">Breakfast</option>
                                        <option value="Taxi / Car Service">Uber/Lyft/Taxi</option>
                                        <option value="Accommodation">Hotel</option>
                                        <option value="Car Rental">Car Rental</option>
                                        <option value="Airfare">Airfare</option>
                                        <option value="Undefined">Other</option>
                                    </select>
                                </div>
                                
                                <div id="hotelNightsContainer">
                                    <label for="hotelNights" class="block mb-1 font-medium">Number of Nights</label>
                                    <input type="number" id="hotelNights" value="1" min="1" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <button id="addManualExpenseButton" class="bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded">
                                    Add Expense
                                </button>
                            </div>
                        </div>
                        
                        <!-- Mileage & Tolls Tab Content -->
                        <div id="mileageTabContent" class="mt-4 hidden">
                            <div class="grid md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <h3 class="font-semibold mb-3">Mileage Log Generator</h3>
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label for="mileageStartDate" class="block mb-1 text-sm font-medium">Start Date</label>
                                            <input type="date" id="mileageStartDate" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                        </div>
                                        <div>
                                            <label for="mileageEndDate" class="block mb-1 text-sm font-medium">End Date</label>
                                            <input type="date" id="mileageEndDate" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                        </div>
                                        <div>
                                            <label for="totalMileage" class="block mb-1 text-sm font-medium">Total Mileage</label>
                                            <input type="number" id="totalMileage" placeholder="e.g., 1200" min="1" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                        </div>
                                        <div>
                                            <label for="numTrips" class="block mb-1 text-sm font-medium">Number of Trips</label>
                                            <input type="number" id="numTrips" placeholder="10" min="1" value="10" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                        </div>
                                    </div>
                                    <button id="generateMileageLogButton" class="bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded w-full">
                                        Generate Mileage Log
                                    </button>
                                </div>
                                
                                <div>
                                    <h3 class="font-semibold mb-3">Toll Receipt Generator</h3>
                                    <div class="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label for="tollStartDate" class="block mb-1 text-sm font-medium">Start Date</label>
                                            <input type="date" id="tollStartDate" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                        </div>
                                        <div>
                                            <label for="tollEndDate" class="block mb-1 text-sm font-medium">End Date</label>
                                            <input type="date" id="tollEndDate" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                        </div>
                                        <div>
                                            <label for="totalTollAmount" class="block mb-1 text-sm font-medium">Total Amount</label>
                                            <input type="number" id="totalTollAmount" placeholder="e.g., 150.00" min="0.01" step="0.01" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                        </div>
                                        <div>
                                            <label for="numTolls" class="block mb-1 text-sm font-medium">Number of Tolls</label>
                                            <input type="number" id="numTolls" placeholder="8" min="1" value="8" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                        </div>
                                    </div>
                                    <button id="generateTollReceiptButton" class="bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded w-full">
                                        Generate Toll Receipts
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Parsed Expenses Table -->
                        <div id="parsedExpenses" class="hidden mt-6">
                            <h3 class="font-semibold text-lg mb-2">Expense List</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="bg-gray-700">
                                        <tr>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                                <div class="flex items-center">
                                                    <input type="checkbox" id="selectAll" class="h-4 w-4 text-primary border-gray-600 rounded mr-2">
                                                    <span>Select</span>
                                                </div>
                                            </th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Type</th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Vendor</th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Location</th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Amount</th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expenseTableBody" class="bg-gray-800 divide-y divide-gray-700">
                                        <!-- Parsed expenses will go here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 flex flex-wrap gap-2">
                                <button id="generateReceiptButton" class="bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded">
                                    Generate Receipt(s)
                                </button>
                                <button id="generateAllReceiptsButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded">
                                    Generate All as ZIP
                                </button>
                                <button id="clearExpensesButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded">
                                    Clear All
                                </button>
                            </div>
                            
                            <!-- Batch Processing Status -->
                            <div id="batchProcessingStatus" class="hidden mt-4 p-4 bg-gray-700 rounded-lg">
                                <h3 class="font-semibold text-lg mb-2">Batch Processing</h3>
                                <div class="mb-3">
                                    <div class="w-full bg-gray-600 rounded-full h-4">
                                        <div id="batchProgress" class="bg-primary h-4 rounded-full" style="width: 0%"></div>
                                    </div>
                                    <p id="batchStatusText" class="mt-1 text-sm">Processing 0 of 0 expenses...</p>
                                </div>
                                <div id="skippedExpensesList" class="hidden">
                                    <h4 class="font-medium mb-1">Skipped Expenses:</h4>
                                    <ul id="skippedList" class="list-disc list-inside text-sm"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Pricing Section -->
    <section class="py-16 bg-gray-900">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-4">Flexible Pricing</h2>
            <p class="text-center max-w-2xl mx-auto mb-12 text-gray-400">Buy credits as you need them. 1 Credit = 1 Basic Receipt, 2 Credits = 1 Premium Receipt, 1 Credit per Toll/Mileage Line.</p>
            
            <div class="flex flex-wrap justify-center gap-8">
                <!-- Single Receipt -->
                <div class="price-card bg-dark rounded-xl shadow-lg overflow-hidden max-w-xs w-full">
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-1">Single Receipt</h3>
                        <p class="text-gray-400 text-sm mb-4">Quick solution for one-time use</p>
                        
                        <div class="mb-4">
                            <span class="text-4xl font-bold">$2.99</span>
                            <span class="text-gray-400 text-sm ml-1">1 Credit</span>
                        </div>
                        
                        <p class="text-sm text-gray-400 mb-6">($2.99 / receipt)</p>
                        
                        <button class="buy-credits-btn w-full bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded-md" data-plan="single" data-credits="1" data-price="2.99">
                            Buy 1 Credit
                        </button>
                    </div>
                </div>
                
                <!-- Starter Pack -->
                <div class="price-card bg-dark rounded-xl shadow-lg overflow-hidden max-w-xs w-full">
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-1">Starter Pack</h3>
                        <p class="text-gray-400 text-sm mb-4">Perfect for tax season needs</p>
                        
                        <div class="mb-4">
                            <span class="text-4xl font-bold">$9.99</span>
                            <span class="text-gray-400 text-sm ml-1">5 Credits</span>
                        </div>
                        
                        <p class="text-sm text-gray-400 mb-6">($2.00 / receipt)</p>
                        
                        <button class="buy-credits-btn w-full bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded-md" data-plan="starter" data-credits="5" data-price="9.99">
                            Buy 5 Credits
                        </button>
                    </div>
                </div>
                
                <!-- Value Pack -->
                <div class="price-card bg-dark rounded-xl shadow-lg overflow-hidden max-w-xs w-full border-2 border-primary relative">
                    <div class="bg-primary text-white py-1 text-center text-sm font-semibold">
                        POPULAR
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-1">Value Pack</h3>
                        <p class="text-gray-400 text-sm mb-4">Best for quarterly expenses</p>
                        
                        <div class="mb-4">
                            <span class="text-4xl font-bold">$19.99</span>
                            <span class="text-gray-400 text-sm ml-1">15 Credits</span>
                        </div>
                        
                        <p class="text-sm text-gray-400 mb-6">($1.33 / receipt)</p>
                        
                        <button class="buy-credits-btn w-full bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded-md" data-plan="value" data-credits="15" data-price="19.99">
                            Buy 15 Credits
                        </button>
                    </div>
                </div>
                
                <!-- Business Pack -->
                <div class="price-card bg-dark rounded-xl shadow-lg overflow-hidden max-w-xs w-full">
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-1">Business Pack</h3>
                        <p class="text-gray-400 text-sm mb-4">For frequent business travelers</p>
                        
                        <div class="mb-4">
                            <span class="text-4xl font-bold">$39.99</span>
                            <span class="text-gray-400 text-sm ml-1">50 Credits</span>
                        </div>
                        
                        <p class="text-sm text-gray-400 mb-6">($0.80 / receipt)</p>
                        
                        <button class="buy-credits-btn w-full bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded-md" data-plan="business" data-credits="50" data-price="39.99">
                            Buy 50 Credits
                        </button>
                    </div>
                </div>
                
                <!-- Enterprise Pack -->
                <div class="price-card bg-dark rounded-xl shadow-lg overflow-hidden max-w-xs w-full">
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-1">Enterprise Pack</h3>
                        <p class="text-gray-400 text-sm mb-4">For business compliance needs</p>
                        
                        <div class="mb-4">
                            <span class="text-4xl font-bold">$149.99</span>
                            <span class="text-gray-400 text-sm ml-1">300 Credits</span>
                        </div>
                        
                        <p class="text-sm text-gray-400 mb-6">($0.50 / receipt)</p>
                        
                        <button class="buy-credits-btn w-full bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded-md" data-plan="enterprise" data-credits="300" data-price="149.99">
                            Buy 300 Credits
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Custom Credit Amount Slider (NEW) -->
            <div class="max-w-2xl mx-auto mt-12 bg-dark rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold mb-4">Custom Credit Amount</h3>
                <p class="text-gray-400 text-sm mb-6">Need a specific number of credits? Choose your amount below:</p>
                
                <div class="mb-6">
                    <input type="range" id="customCreditsSlider" min="50" max="1000" step="50" value="50" class="custom-range w-full mb-2">
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>50</span>
                        <span>250</span>
                        <span>500</span>
                        <span>750</span>
                        <span>1000</span>
                    </div>
                </div>
                
                <div class="flex justify-between items-center">
                    <div>
                        <span id="customCreditsAmount" class="text-3xl font-bold">50</span>
                        <span class="text-gray-400 text-sm ml-1">Credits</span>
                        <p class="text-gray-400 text-sm mt-1">$<span id="customCreditsPrice">40.00</span> ($<span id="customCreditUnitPrice">0.80</span> / receipt)</p>
                    </div>
                    <button id="buyCustomCreditsBtn" class="bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded-md" data-plan="custom">
                        Buy Credits
                    </button>
                </div>
            </div>
            
            <p class="text-center mt-8 text-sm text-gray-400">All transactions are secure via Stripe. Credits are stored in your account.</p>
        </div>
    </section>

    <!-- Receipt Viewer Modal -->
    <div id="receiptModal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto relative">
            <!-- Close button -->
            <button id="closeModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <!-- Modal header -->
            <div class="mb-4">
                <h2 class="text-xl font-bold text-primary">Generated Receipt</h2>
                <p id="receiptCounter" class="text-sm text-gray-400">Receipt 1 of 1</p>
            </div>
            
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Receipt Preview Panel -->
                <div class="md:w-7/12">
                    <h3 class="font-semibold mb-2">Preview</h3>
                    <div id="receiptContent" class="bg-white p-4 border border-gray-200 mb-4 text-gray-800 receipt-preview receipt-text">
                        <!-- Receipt will be generated here -->
                    </div>
                </div>
                
                <!-- Edit Panel -->
                <div class="md:w-5/12 bg-gray-700 p-4 rounded-lg">
                    <h3 class="font-semibold mb-3">Edit Receipt Details</h3>
                    <div class="space-y-3">
                        <div>
                            <label for="editVendor" class="block text-sm font-medium mb-1">Vendor/Merchant</label>
                            <input type="text" id="editVendor" class="w-full rounded-md border-gray-600 bg-gray-600 text-sm px-3 py-2">
                        </div>
                        
                        <div>
                            <label for="editLocation" class="block text-sm font-medium mb-1">Location</label>
                            <input type="text" id="editLocation" class="w-full rounded-md border-gray-600 bg-gray-600 text-sm px-3 py-2">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label for="editDate" class="block text-sm font-medium mb-1">Date</label>
                                <input type="date" id="editDate" class="w-full rounded-md border-gray-600 bg-gray-600 text-sm px-3 py-2">
                            </div>
                            <div>
                                <label for="editTime" class="block text-sm font-medium mb-1">Time</label>
                                <input type="time" id="editTime" class="w-full rounded-md border-gray-600 bg-gray-600 text-sm px-3 py-2">
                            </div>
                        </div>
                        
                        <div>
                            <label for="editAmount" class="block text-sm font-medium mb-1">Amount</label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <span class="text-gray-400">$</span>
                                </div>
                                <input type="number" id="editAmount" step="0.01" min="0" class="w-full pl-7 px-3 py-2 rounded-md border-gray-600 bg-gray-600 text-sm">
                            </div>
                        </div>
                        
                        <div>
                            <label for="editTaxRate" class="block text-sm font-medium mb-1">Tax Rate (%)</label>
                            <input type="number" id="editTaxRate" step="0.01" min="0" class="w-full rounded-md border-gray-600 bg-gray-600 text-sm px-3 py-2">
                        </div>
                        
                        <div>
                            <label for="editPaymentMethod" class="block text-sm font-medium mb-1">Payment Method</label>
                            <div class="grid grid-cols-2 gap-2">
                                <select id="editPaymentMethod" class="w-full rounded-md border-gray-600 bg-gray-600 text-sm px-3 py-2">
                                    <option value="AMEX">American Express</option>
                                    <option value="VISA">Visa</option>
                                    <option value="MC">MasterCard</option>
                                    <option value="DISC">Discover</option>
                                    <option value="Apple Pay">Apple Pay</option>
                                    <option value="Corporate Card">Corporate Card</option>
                                    <option value="Cash">Cash</option>
                                </select>
                                <input type="text" id="editLastFour" placeholder="Last 4 digits" maxlength="4" class="w-full rounded-md border-gray-600 bg-gray-600 text-sm px-3 py-2">
                            </div>
                        </div>
                        
                        <div class="pt-3">
                            <button id="applyEditsBtn" class="w-full bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded-md">
                                Apply Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation buttons -->
            <div class="flex justify-between items-center my-4">
                <button id="prevReceiptBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md">
                    Previous
                </button>
                <button id="nextReceiptBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md">
                    Next
                </button>
            </div>
            
            <!-- Download buttons -->
            <div class="flex justify-end gap-2">
                <button id="downloadPdf" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded">
                    Download PDF
                </button>
                <button id="downloadPng" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">
                    Download PNG
                </button>
            </div>
        </div>
    </div>
    
    <!-- Buy Credits Modal -->
    <div id="buyCreditsModal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-primary">Purchase Credits</h2>
                <button id="closeBuyModal" class="text-gray-400 hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <p class="mb-4">For testing purposes, we've added 999 credits to your account.</p>
            
            <div class="flex justify-end">
                <button id="confirmAddCredits" class="bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded">
                    Got it!
                </button>
            </div>
        </div>
    </div>
    
    <!-- Sign In Modal -->
    <div id="signInModal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-primary">Sign In</h2>
                <button id="closeSignInModal" class="text-gray-400 hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" id="email" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm px-3 py-2" placeholder="your@email.com">
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="password" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm px-3 py-2" placeholder="">
                </div>
                
                <div class="pt-2">
                    <button id="confirmSignIn" class="w-full bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded">
                        Sign In
                    </button>
                </div>
                
                <div class="text-center">
                    <p class="text-sm text-gray-400">Or continue with</p>
                    <div class="flex justify-center gap-4 mt-3">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">
                            <i class="fab fa-google mr-2"></i> Google
                        </button>
                        <button class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded">
                            <i class="fab fa-apple mr-2"></i> Apple
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-darker py-8">
        <div class="container mx-auto px-4">
            <div class="text-center mb-4">
                <h3 class="text-lg font-semibold mb-2">Important Disclaimer</h3>
                <p class="text-sm text-gray-400 max-w-3xl mx-auto">This tool is intended to help recreate documentation for legitimate, actual expenses where the original receipt was lost/damaged. Users are solely responsible for accuracy and compliance with company policy & tax regulations.</p>
                <p class="text-sm font-semibold text-red-400 mt-2">Fraudulent use is strictly prohibited and may have legal consequences.</p>
            </div>
            
            <div class="border-t border-gray-800 pt-4 flex flex-col md:flex-row justify-between items-center">
                <p class="text-sm text-gray-500"> 2024 Receipt Recreator - Use Responsibly</p>
                <div class="flex space-x-4 mt-2 md:mt-0">
                    <a href="#" class="text-sm text-gray-500 hover:text-white">Privacy Policy</a>
                    <a href="#" class="text-sm text-gray-500 hover:text-white">Terms of Service</a>
                    <a href="#" class="text-sm text-gray-500 hover:text-white">Support</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Firebase and External Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="https://js.stripe.com/v3/"></script>

    <script>
        // Firebase configuration (to be replaced with actual values)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-app.firebaseapp.com",
            projectId: "your-app-id",
            storageBucket: "your-app.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase (commented out for now)
        // firebase.initializeApp(firebaseConfig);
        
        // Stripe publishable key (to be replaced with actual value)
        // const stripePublishableKey = 'pk_test_your_key_here';
        // const stripe = Stripe(stripePublishableKey);
    </script>

    <script>
        // API Integration Helpers - For future use in other applications
        window.ReceiptGenerator = {
            // Initialize the Receipt Generator API
            init: function(config = {}) {
                this.apiKey = config.apiKey || null;
                this.userId = config.userId || null;
                this.onReady = config.onReady || function() {};
                this.onError = config.onError || function(error) { console.error('Receipt Generator API Error:', error); };
                
                // Check if we're running as an embedded component
                this.isEmbedded = window.location !== window.parent.location;
                
                // Fire the ready event
                setTimeout(() => {
                    this.onReady({
                        status: 'ready',
                        isEmbedded: this.isEmbedded
                    });
                }, 100);
                
                return this;
            },
            
            // Generate a receipt with the provided data
            generateReceipt: function(receiptData, options = {}) {
                return new Promise((resolve, reject) => {
                    try {
                        // This would be replaced with actual receipt generation in production
                        const format = options.format || 'html';
                        const quality = options.quality || 'basic';
                        
                        // Simulated processing time
                        setTimeout(() => {
                            resolve({
                                status: 'success',
                                receipt: {
                                    html: '<div class="receipt">Sample Receipt Content</div>',
                                    data: receiptData,
                                    format: format,
                                    id: 'receipt_' + Date.now()
                                }
                            });
                        }, 500);
                    } catch (error) {
                        reject({
                            status: 'error',
                            message: error.message || 'Failed to generate receipt'
                        });
                    }
                });
            },
            
            // Get user's credit balance
            getCredits: function() {
                return new Promise((resolve) => {
                    // This would interact with Firebase in production
                    const credits = localStorage.getItem('receiptCredits') ? 
                        parseInt(localStorage.getItem('receiptCredits')) : 0;
                        
                    resolve({
                        status: 'success',
                        credits: credits
                    });
                });
            },
            
            // Add credits to the user's account
            addCredits: function(amount) {
                return new Promise((resolve) => {
                    // This would interact with Firebase in production
                    let credits = localStorage.getItem('receiptCredits') ? 
                        parseInt(localStorage.getItem('receiptCredits')) : 0;
                    
                    credits += amount;
                    localStorage.setItem('receiptCredits', credits);
                    
                    resolve({
                        status: 'success',
                        credits: credits
                    });
                });
            }
        };
        
        // Helper function for formatting dates properly (fixing the '3ar' bug)
        function formatDate(date, format = 'MMM DD, YYYY') {
            if (!date) return '';
            
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const shortMonths = [
                'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'
            ];
            
            const day = date.getDate();
            const month = date.getMonth();
            const year = date.getFullYear();
            
            // Replace patterns in the format string
            let result = format;
            result = result.replace('YYYY', year);
            result = result.replace('YY', String(year).slice(-2));
            result = result.replace('MMMM', months[month]);
            result = result.replace('MMM', shortMonths[month]);
            result = result.replace('MM', String(month + 1).padStart(2, '0'));
            result = result.replace('M', month + 1);
            result = result.replace('DD', String(day).padStart(2, '0'));
            result = result.replace('D', day);
            
            return result;
        }
        
        // Format time function
        function formatTime(date) {
            if (!date) return '';
            
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            
            const formattedHours = hours % 12 || 12; // Convert 0 to 12
            const formattedMinutes = String(minutes).padStart(2, '0');
            
            return `${formattedHours}:${formattedMinutes} ${ampm}`;
        }
    
        // Custom credit slider logic
        document.addEventListener('DOMContentLoaded', function() {
            const customCreditsSlider = document.getElementById('customCreditsSlider');
            const customCreditsAmount = document.getElementById('customCreditsAmount');
            const customCreditsPrice = document.getElementById('customCreditsPrice');
            const customCreditUnitPrice = document.getElementById('customCreditUnitPrice');
            const buyCustomCreditsBtn = document.getElementById('buyCustomCreditsBtn');
            
            // Calculate price based on credits - updated to match enterprise pricing
            function calculateCustomPrice(credits) {
                let unitPrice;
                
                if (credits < 100) {
                    unitPrice = 0.80; // $0.80 per credit (similar to Business Pack)
                } else if (credits < 250) {
                    unitPrice = 0.70; // $0.70 per credit
                } else if (credits < 500) {
                    unitPrice = 0.60; // $0.60 per credit
                } else if (credits < 750) {
                    unitPrice = 0.55; // $0.55 per credit
                } else {
                    unitPrice = 0.50; // $0.50 per credit (same as Enterprise Pack)
                }
                
                const totalPrice = (credits * unitPrice).toFixed(2);
                return { totalPrice, unitPrice };
            }
            
            // Update custom credit display
            customCreditsSlider.addEventListener('input', function() {
                const credits = parseInt(this.value);
                const { totalPrice, unitPrice } = calculateCustomPrice(credits);
                
                customCreditsAmount.textContent = credits;
                customCreditsPrice.textContent = totalPrice;
                customCreditUnitPrice.textContent = unitPrice.toFixed(2);
                
                // Update button data
                buyCustomCreditsBtn.dataset.credits = credits;
                buyCustomCreditsBtn.dataset.price = totalPrice;
            });
            
            // Initialize with default value
            const defaultCredits = parseInt(customCreditsSlider.value);
            const { totalPrice, unitPrice } = calculateCustomPrice(defaultCredits);
            customCreditsAmount.textContent = defaultCredits;
            customCreditsPrice.textContent = totalPrice;
            customCreditUnitPrice.textContent = unitPrice.toFixed(2);
            buyCustomCreditsBtn.dataset.credits = defaultCredits;
            buyCustomCreditsBtn.dataset.price = totalPrice;
            
            // Add click handler for custom credits button
            buyCustomCreditsBtn.addEventListener('click', function() {
                const creditsToAdd = parseInt(this.dataset.credits);
                addCredits(creditsToAdd); // This will be replaced with Stripe flow in production
                alert(`Added ${creditsToAdd} credits to your account!`);
            });
        });

        // Main app logic
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize credits from localStorage or set default
            let credits = localStorage.getItem('receiptCredits') ? parseInt(localStorage.getItem('receiptCredits')) : 999;
            updateCreditDisplay();
            
            // Elements
            const tabElements = {
                pasteTabLink: document.getElementById('pasteTabLink'),
                manualTabLink: document.getElementById('manualTabLink'),
                mileageTabLink: document.getElementById('mileageTabLink'),
                pasteTabContent: document.getElementById('pasteTabContent'),
                manualTabContent: document.getElementById('manualTabContent'),
                mileageTabContent: document.getElementById('mileageTabContent')
            };
            
            const expenseInput = document.getElementById('expenseInput');
            const parseButton = document.getElementById('parseButton');
            const parsedExpenses = document.getElementById('parsedExpenses');
            const expenseTableBody = document.getElementById('expenseTableBody');
            const selectAllCheckbox = document.getElementById('selectAll');
            const generateReceiptButton = document.getElementById('generateReceiptButton');
            const generateAllReceiptsButton = document.getElementById('generateAllReceiptsButton');
            const clearExpensesButton = document.getElementById('clearExpensesButton');
            const receiptModal = document.getElementById('receiptModal');
            const closeModal = document.getElementById('closeModal');
            const receiptContent = document.getElementById('receiptContent');
            const receiptCounter = document.getElementById('receiptCounter');
            const prevReceiptBtn = document.getElementById('prevReceiptBtn');
            const nextReceiptBtn = document.getElementById('nextReceiptBtn');
            const downloadPdf = document.getElementById('downloadPdf');
            const downloadPng = document.getElementById('downloadPng');
            
            // Auth elements
            const authStatus = document.getElementById('authStatus');
            const signInButton = document.getElementById('signInButton');
            const signOutButton = document.getElementById('signOutButton');
            const signInModal = document.getElementById('signInModal');
            const closeSignInModal = document.getElementById('closeSignInModal');
            const confirmSignIn = document.getElementById('confirmSignIn');
            
            // Loyalty program dropdowns
            const loyaltyProgram1 = document.getElementById('loyaltyProgram1');
            const loyaltyNumber1 = document.getElementById('loyaltyNumber1');
            const otherLoyaltyProgram1 = document.getElementById('otherLoyaltyProgram1');
            const otherLoyaltyName1 = document.getElementById('otherLoyaltyName1');
            
            const loyaltyProgram2 = document.getElementById('loyaltyProgram2');
            const loyaltyNumber2 = document.getElementById('loyaltyNumber2');
            const otherLoyaltyProgram2 = document.getElementById('otherLoyaltyProgram2');
            const otherLoyaltyName2 = document.getElementById('otherLoyaltyName2');
            
            // Manual entry elements
            const manualVendor = document.getElementById('manualVendor');
            const manualLocation = document.getElementById('manualLocation');
            const manualDate = document.getElementById('manualDate');
            const manualAmount = document.getElementById('manualAmount');
            const manualType = document.getElementById('manualType');
            const hotelNights = document.getElementById('hotelNights');
            const hotelNightsContainer = document.getElementById('hotelNightsContainer');
            const addManualExpenseButton = document.getElementById('addManualExpenseButton');
            
            // Mileage & toll log elements
            const mileageStartDate = document.getElementById('mileageStartDate');
            const mileageEndDate = document.getElementById('mileageEndDate');
            const totalMileage = document.getElementById('totalMileage');
            const numTrips = document.getElementById('numTrips');
            const generateMileageLogButton = document.getElementById('generateMileageLogButton');
            
            const tollStartDate = document.getElementById('tollStartDate');
            const tollEndDate = document.getElementById('tollEndDate');
            const totalTollAmount = document.getElementById('totalTollAmount');
            const numTolls = document.getElementById('numTolls');
            const generateTollReceiptButton = document.getElementById('generateTollReceiptButton');
            
            // Fix: Clear sample data when new content is pasted into the field
            expenseInput.addEventListener('paste', function(e) {
                // Clear the field when pasting
                this.value = '';
            });
            
            // Show/hide Other loyalty program field
            loyaltyProgram1.addEventListener('change', function() {
                otherLoyaltyProgram1.classList.toggle('hidden', this.value !== 'Other');
            });
            
            loyaltyProgram2.addEventListener('change', function() {
                otherLoyaltyProgram2.classList.toggle('hidden', this.value !== 'Other');
            });
            
            // Show/hide hotel nights field based on expense type
            manualType.addEventListener('change', function() {
                if (this.value === 'Accommodation' || this.value === 'Car Rental') {
                    hotelNightsContainer.classList.remove('hidden');
                    document.querySelector('label[for="hotelNights"]').textContent = 
                        this.value === 'Accommodation' ? 'Number of Nights' : 'Number of Days';
                } else {
                    hotelNightsContainer.classList.add('hidden');
                }
            });
            
            // Credit system elements
            const buyCreditsButton = document.getElementById('buyCreditsButton');
            const buyCreditsModal = document.getElementById('buyCreditsModal');
            const closeBuyModal = document.getElementById('closeBuyModal');
            const confirmAddCredits = document.getElementById('confirmAddCredits');
            const buyCreditsButtons = document.querySelectorAll('.buy-credits-btn');
            
            // Batch processing elements
            const batchProcessingStatus = document.getElementById('batchProcessingStatus');
            const batchProgress = document.getElementById('batchProgress');
            const batchStatusText = document.getElementById('batchStatusText');
            const skippedExpensesList = document.getElementById('skippedExpensesList');
            const skippedList = document.getElementById('skippedList');
            
            // Receipt quality elements
            const basicQuality = document.getElementById('basicQuality');
            const proQuality = document.getElementById('proQuality');
            
            // Receipt editor functionality
            const editVendor = document.getElementById('editVendor');
            const editLocation = document.getElementById('editLocation');
            const editDate = document.getElementById('editDate');
            const editTime = document.getElementById('editTime');
            const editAmount = document.getElementById('editAmount');
            const editTaxRate = document.getElementById('editTaxRate');
            const editPaymentMethod = document.getElementById('editPaymentMethod');
            const editLastFour = document.getElementById('editLastFour');
            const applyEditsBtn = document.getElementById('applyEditsBtn');
            
            // Auth handling (for modal approach)
            signInButton.addEventListener('click', function(e) {
                e.preventDefault();
                signInModal.classList.remove('hidden');
            });
            
            closeSignInModal.addEventListener('click', function() {
                signInModal.classList.add('hidden');
            });
            
            confirmSignIn.addEventListener('click', function() {
                // This would be replaced with Firebase authentication
                authStatus.textContent = 'User';
                signInButton.classList.add('hidden');
                signOutButton.classList.remove('hidden');
                signInModal.classList.add('hidden');
            });
            
            signOutButton.addEventListener('click', function() {
                // This will be replaced with Firebase authentication
                authStatus.textContent = 'Not signed in';
                signInButton.classList.remove('hidden');
                signOutButton.classList.add('hidden');
            });
            
            // Sample expense data for testing
            const sampleData = `Available Expenses
Drag and drop files to upload a new receipt. Valid file types for upload are .png, .jpg, .jpeg, .pdf, .tif or .tiff.
View:
All Expenses
Skip to available receipts
Available Expenses
Multiple rows can be selected using checkboxes in the first column.
Select all rows
Receipt
Expense Source
Select row		
NAM AMEX C-CARD IBCP US HQ
Corporate Card
Individual- Dinner
UBER EATS
San Francisco, California	04/05/2025	
$35.93
Select row		
NAM AMEX C-CARD IBCP US HQ
Corporate Card
Taxi / Car Service
UBER
San Francisco, California	04/04/2025	
$21.70`;

            // Fill with sample data if empty (for testing)
            if (expenseInput.value.trim() === '') {
                expenseInput.value = sampleData;
            }
            
            // Set default dates for all date fields to today
            const today = new Date();
            const formattedDate = today.toISOString().substr(0, 10);
            manualDate.value = formattedDate;
            mileageStartDate.value = formattedDate;
            mileageEndDate.value = formattedDate;
            tollStartDate.value = formattedDate;
            tollEndDate.value = formattedDate;
            
            // Store parsed expenses
            let expenses = [];
            
            // Store generated receipts for navigation
            let generatedReceipts = [];
            let currentReceiptIndex = 0;
            
            // Select All checkbox functionality
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('input[name="expenseCheck"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
            
            // Tab switching logic
            tabElements.pasteTabLink.addEventListener('click', function(e) {
                e.preventDefault();
                setActiveTab('paste');
            });
            
            tabElements.manualTabLink.addEventListener('click', function(e) {
                e.preventDefault();
                setActiveTab('manual');
            });
            
            tabElements.mileageTabLink.addEventListener('click', function(e) {
                e.preventDefault();
                setActiveTab('mileage');
            });
            
            function setActiveTab(tabName) {
                // Reset all tabs
                Object.keys(tabElements).forEach(key => {
                    if (key.includes('TabLink')) {
                        tabElements[key].classList.remove('text-primary', 'bg-gray-800', 'font-medium');
                        tabElements[key].classList.add('text-gray-400', 'hover:text-primary');
                    } else if (key.includes('TabContent')) {
                        tabElements[key].classList.add('hidden');
                    }
                });
                
                // Set active tab
                if (tabName === 'paste') {
                    tabElements.pasteTabLink.classList.remove('text-gray-400', 'hover:text-primary');
                    tabElements.pasteTabLink.classList.add('text-primary', 'bg-gray-800', 'font-medium');
                    tabElements.pasteTabContent.classList.remove('hidden');
                } else if (tabName === 'manual') {
                    tabElements.manualTabLink.classList.remove('text-gray-400', 'hover:text-primary');
                    tabElements.manualTabLink.classList.add('text-primary', 'bg-gray-800', 'font-medium');
                    tabElements.manualTabContent.classList.remove('hidden');
                } else if (tabName === 'mileage') {
                    tabElements.mileageTabLink.classList.remove('text-gray-400', 'hover:text-primary');
                    tabElements.mileageTabLink.classList.add('text-primary', 'bg-gray-800', 'font-medium');
                    tabElements.mileageTabContent.classList.remove('hidden');
                }
            }
            
            // State and city tax rate data
            const taxRates = {
                'CA': {
                    'default': 7.25,
                    'San Francisco': 8.625,
                    'Los Angeles': 9.5,
                    'San Diego': 7.75,
                    'Oakland': 9.25
                },
                'TX': {
                    'default': 6.25,
                    'Houston': 8.25,
                    'Dallas': 8.25,
                    'Austin': 8.25,
                    'San Antonio': 8.25,
                    'Spring': 8.25
                },
                'NY': {
                    'default': 4.0,
                    'New York City': 8.875,
                    'Buffalo': 8.75,
                    'Syracuse': 8.0,
                    'LaGuardia Airport': 8.875,
                    'East Elmhurst': 8.875
                },
                'FL': {
                    'default': 6.0,
                    'Miami': 7.0,
                    'Orlando': 6.5,
                    'Tampa': 7.5
                },
                'IL': {
                    'default': 6.25,
                    'Chicago': 10.25,
                    'Springfield': 9.0
                },
                'PA': {
                    'default': 6.0,
                    'Philadelphia': 8.0,
                    'Pittsburgh': 7.0,
                    'Norristown': 6.0,
                    'Conshohocken': 6.0,
                    'Plymouth Meeting': 6.0
                },
                'OH': {
                    'default': 5.75,
                    'Cleveland': 8.0,
                    'Columbus': 7.5,
                    'Cincinnati': 7.8
                },
                'GA': {
                    'default': 4.0,
                    'Atlanta': 8.9,
                    'Savannah': 7.0
                },
                'NC': {
                    'default': 4.75,
                    'Charlotte': 7.25,
                    'Raleigh': 7.25
                },
                'MI': {
                    'default': 6.0,
                    'Detroit': 6.0,
                    'Grand Rapids': 6.0
                },
                'MO': {
                    'default': 4.225,
                    'Kansas City': 10.6,
                    'St. Louis': 8.679
                },
                'KS': {
                    'default': 6.5,
                    'Kansas City': 9.5,
                    'Topeka': 9.15
                }
            };
            
            // Toll data by region
            const tollData = {
                'E-ZPass': {
                    states: ['NY', 'NJ', 'PA', 'DE', 'MD', 'VA', 'WV', 'NC', 'OH', 'IN', 'IL', 'ME', 'NH', 'MA', 'RI', 'KY'],
                    locations: [
                        { name: 'George Washington Bridge', min: 11.75, max: 16.00 },
                        { name: 'Lincoln Tunnel', min: 11.75, max: 16.00 },
                        { name: 'Holland Tunnel', min: 11.75, max: 16.00 },
                        { name: 'Verrazano-Narrows Bridge', min: 12.24, max: 19.00 },
                        { name: 'Goethals Bridge', min: 11.75, max: 16.00 },
                        { name: 'Outerbridge Crossing', min: 11.75, max: 16.00 },
                        { name: 'Bayonne Bridge', min: 11.75, max: 16.00 },
                        { name: 'New Jersey Turnpike', min: 3.50, max: 18.85 },
                        { name: 'Pennsylvania Turnpike', min: 1.80, max: 47.65 },
                        { name: 'New York State Thruway', min: 0.55, max: 22.25 },
                        { name: 'Ohio Turnpike', min: 1.25, max: 15.00 },
                        { name: 'Indiana Toll Road', min: 2.30, max: 12.28 },
                        { name: 'Massachusetts Turnpike', min: 1.70, max: 7.10 }
                    ]
                },
                'SunPass': {
                    states: ['FL', 'GA', 'NC'],
                    locations: [
                        { name: 'Florida Turnpike', min: 1.07, max: 17.80 },
                        { name: 'Alligator Alley', min: 2.84, max: 3.34 },
                        { name: 'Sawgrass Expressway', min: 1.07, max: 2.14 },
                        { name: 'Sunshine Skyway Bridge', min: 1.07, max: 1.07 },
                        { name: 'Selmon Expressway', min: 1.07, max: 2.14 },
                        { name: 'I-75 Express', min: 0.50, max: 10.50 },
                        { name: 'I-95 Express', min: 0.50, max: 10.50 },
                        { name: '836 Dolphin Expressway', min: 1.07, max: 2.14 }
                    ]
                },
                'FasTrak': {
                    states: ['CA'],
                    locations: [
                        { name: 'Golden Gate Bridge', min: 8.05, max: 9.05 },
                        { name: 'Bay Bridge', min: 5.50, max: 7.00 },
                        { name: 'San Mateo Bridge', min: 5.50, max: 7.00 },
                        { name: 'Dumbarton Bridge', min: 5.50, max: 7.00 },
                        { name: 'Carquinez Bridge', min: 5.50, max: 7.00 },
                        { name: 'Richmond-San Rafael Bridge', min: 5.50, max: 7.00 },
                        { name: 'Benicia-Martinez Bridge', min: 5.50, max: 7.00 },
                        { name: 'Antioch Bridge', min: 5.50, max: 7.00 },
                        { name: '91 Express Lanes', min: 1.65, max: 12.60 },
                        { name: 'SR-237 Express Lanes', min: 0.50, max: 8.00 },
                        { name: 'I-680 Express Lanes', min: 0.50, max: 8.00 }
                    ]
                },
                'TxTag': {
                    states: ['TX', 'KS', 'OK'],
                    locations: [
                        { name: 'SH 130', min: 1.35, max: 12.15 },
                        { name: 'SH 45 North', min: 1.35, max: 2.13 },
                        { name: 'SH 45 SE', min: 0.98, max: 1.64 },
                        { name: 'Loop 1', min: 0.98, max: 1.64 },
                        { name: 'US 290', min: 0.98, max: 1.64 },
                        { name: 'US 183A', min: 1.35, max: 2.13 },
                        { name: '183 Toll', min: 1.35, max: 2.13 },
                        { name: 'SH 99', min: 0.65, max: 7.25 },
                        { name: 'North Tarrant Express', min: 0.75, max: 9.50 },
                        { name: 'LBJ TEXpress Lanes', min: 0.75, max: 9.50 }
                    ]
                },
                'I-Pass': {
                    states: ['IL', 'WI', 'IN'],
                    locations: [
                        { name: 'Tri-State Tollway (I-94/I-294/I-80)', min: 1.10, max: 3.80 },
                        { name: 'Jane Addams Memorial Tollway (I-90)', min: 1.10, max: 3.80 },
                        { name: 'Reagan Memorial Tollway (I-88)', min: 1.10, max: 3.80 },
                        { name: 'Veterans Memorial Tollway (I-355)', min: 1.10, max: 3.80 },
                        { name: 'Chicago Skyway', min: 5.60, max: 5.60 }
                    ]
                },
                'PeachPass': {
                    states: ['GA', 'FL', 'NC'],
                    locations: [
                        { name: 'I-85 Express Lanes', min: 0.10, max: 13.95 },
                        { name: 'I-75 Northwest Express Lanes', min: 0.10, max: 13.95 },
                        { name: 'I-75 South Metro Express Lanes', min: 0.10, max: 13.95 },
                        { name: 'I-285 Top End Express Lanes', min: 0.10, max: 13.95 }
                    ]
                },
                'NC Quick Pass': {
                    states: ['NC', 'SC', 'FL', 'GA'],
                    locations: [
                        { name: 'Triangle Expressway', min: 0.49, max: 3.37 },
                        { name: 'Monroe Expressway', min: 0.49, max: 2.53 },
                        { name: 'I-77 Express Lanes', min: 0.30, max: 7.00 }
                    ]
                },
                'Other': {
                    states: ['Other'],
                    locations: [
                        { name: 'General Toll Road', min: 1.00, max: 15.00 },
                        { name: 'Bridge Toll', min: 2.00, max: 18.00 },
                        { name: 'Tunnel Toll', min: 2.00, max: 18.00 },
                        { name: 'Express Lane', min: 0.50, max: 12.00 }
                    ]
                }
            };
            
            // State and city selection handling
            const stateSelect = document.getElementById('stateSelect');
            const citySelect = document.getElementById('citySelect');
            const taxRateInput = document.getElementById('taxRate');
            
            // Fixed: Store user's tax rate separately to avoid overriding
            let userTaxRate = null;
            
            // Add change listener to tax rate input to capture user changes
            taxRateInput.addEventListener('change', function() {
                // Store the user's manually entered tax rate
                userTaxRate = parseFloat(this.value);
            });
            
            stateSelect.addEventListener('change', function() {
                const selectedState = this.value;
                citySelect.innerHTML = '<option value="">Select City</option>';
                
                if (selectedState && taxRates[selectedState]) {
                    // Only set default tax rate if user hasn't specified one
                    if (userTaxRate === null) {
                        taxRateInput.value = taxRates[selectedState].default;
                    } else {
                        taxRateInput.value = userTaxRate;
                    }
                    
                    // Add cities for the selected state
                    Object.keys(taxRates[selectedState]).forEach(city => {
                        if (city !== 'default') {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            citySelect.appendChild(option);
                        }
                    });
                }
            });
            
            citySelect.addEventListener('change', function() {
                const selectedState = stateSelect.value;
                const selectedCity = this.value;
                
                // Only set city tax rate if user hasn't specified one
                if (selectedState && selectedCity && taxRates[selectedState][selectedCity] && userTaxRate === null) {
                    taxRateInput.value = taxRates[selectedState][selectedCity];
                } else if (userTaxRate !== null) {
                    taxRateInput.value = userTaxRate;
                }
            });
            
            // Credit system functions
            function updateCreditDisplay() {
                document.getElementById('creditCount').textContent = credits;
                document.getElementById('availableCredits').textContent = credits;
            }
            
            function addCredits(amount) {
                credits += amount;
                localStorage.setItem('receiptCredits', credits);
                updateCreditDisplay();
            }
            
            function useCredits(amount) {
                if (credits >= amount) {
                    credits -= amount;
                    localStorage.setItem('receiptCredits', credits);
                    updateCreditDisplay();
                    return true;
                }
                return false;
            }
            
            // Buy credits button handlers - made modal
            buyCreditsButton.addEventListener('click', function(e) {
                e.preventDefault();
                buyCreditsModal.classList.remove('hidden');
            });
            
            closeBuyModal.addEventListener('click', function() {
                buyCreditsModal.classList.add('hidden');
            });
            
            confirmAddCredits.addEventListener('click', function() {
                addCredits(999); // For testing
                buyCreditsModal.classList.add('hidden');
            });
            
            buyCreditsButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const creditsToAdd = parseInt(this.dataset.credits);
                    // In production this would open Stripe checkout
                    addCredits(creditsToAdd);
                    alert(`Added ${creditsToAdd} credits to your account!`);
                });
            });
            
            // Helper function to get loyalty program information
            function getLoyaltyInfo() {
                let loyaltyPrograms = [];
                
                // First loyalty program
                if (loyaltyProgram1.value && loyaltyNumber1.value) {
                    const programName = loyaltyProgram1.value === 'Other' ? 
                        otherLoyaltyName1.value || 'Loyalty Program' : loyaltyProgram1.value;
                    
                    loyaltyPrograms.push({
                        program: programName,
                        number: loyaltyNumber1.value
                    });
                }
                
                // Second loyalty program
                if (loyaltyProgram2.value && loyaltyNumber2.value) {
                    const programName = loyaltyProgram2.value === 'Other' ? 
                        otherLoyaltyName2.value || 'Loyalty Program' : loyaltyProgram2.value;
                    
                    loyaltyPrograms.push({
                        program: programName,
                        number: loyaltyNumber2.value
                    });
                }
                
                return loyaltyPrograms;
            }
            
            // Parse expense data from Concur format
            parseButton.addEventListener('click', function() {
                const data = expenseInput.value.trim();
                if (!data) {
                    alert('Please paste expense data first.');
                    return;
                }

                try {
                    const newExpenses = parseExpenseData(data);
                    expenses = [...expenses, ...newExpenses];
                    displayParsedExpenses(expenses);
                    parsedExpenses.classList.remove('hidden');
                } catch (e) {
                    console.error('Error parsing data:', e);
                    alert('Error parsing data. Please check the format and try again.');
                }
            });
            
            // Mileage log generator
            generateMileageLogButton.addEventListener('click', function() {
                const startDate = new Date(mileageStartDate.value);
                const endDate = new Date(mileageEndDate.value);
                const totalMiles = parseFloat(totalMileage.value);
                const trips = parseInt(numTrips.value);
                
                if (!mileageStartDate.value || !mileageEndDate.value || !totalMileage.value || !numTrips.value) {
                    alert('Please fill out all mileage fields.');
                    return;
                }
                
                if (startDate > endDate) {
                    alert('Start date must be before end date.');
                    return;
                }
                
                // Calculate required credits (1 credit per trip)
                const creditsNeeded = trips;
                
                // Check if enough credits
                if (!useCredits(creditsNeeded)) {
                    alert(`Not enough credits. You need ${creditsNeeded} credits to generate ${trips} trips.`);
                    return;
                }
                
                // Generate mileage log
                const mileageLog = generateMileageLog(startDate, endDate, totalMiles, trips);
                
                // Display in receipt modal
                receiptContent.innerHTML = mileageLog;
                receiptModal.classList.remove('hidden');
                
                // Set up for navigation
                generatedReceipts = [mileageLog];
                currentReceiptIndex = 0;
                showCurrentReceipt();
            });
            
            // Toll receipt generator
            generateTollReceiptButton.addEventListener('click', function() {
                const startDate = new Date(tollStartDate.value);
                const endDate = new Date(tollEndDate.value);
                const totalAmount = parseFloat(totalTollAmount.value);
                const tolls = parseInt(numTolls.value);
                
                if (!tollStartDate.value || !tollEndDate.value || !totalTollAmount.value || !numTolls.value) {
                    alert('Please fill out all toll receipt fields.');
                    return;
                }
                
                if (startDate > endDate) {
                    alert('Start date must be before end date.');
                    return;
                }
                
                // Calculate required credits (1 credit per toll)
                const creditsNeeded = tolls;
                
                // Check if enough credits
                if (!useCredits(creditsNeeded)) {
                    alert(`Not enough credits. You need ${creditsNeeded} credits to generate ${tolls} toll receipts.`);
                    return;
                }
                
                // Generate toll receipt
                const tollReceipt = generateTollReceipt(startDate, endDate, totalAmount, tolls);
                
                // Display in receipt modal
                receiptContent.innerHTML = tollReceipt;
                receiptModal.classList.remove('hidden');
                
                // Set up for navigation
                generatedReceipts = [tollReceipt];
                currentReceiptIndex = 0;
                showCurrentReceipt();
            });
            
            // Add expense from manual entry
            addManualExpenseButton.addEventListener('click', function() {
                // Validate inputs
                if (!manualVendor.value || !manualLocation.value || !manualDate.value || !manualAmount.value) {
                    alert('Please fill out all required fields.');
                    return;
                }
                
                // Get name from input or use default
                const customerName = document.getElementById('customerName').value || '';
                
                // Get payment method info
                const paymentCardType = document.getElementById('paymentCardType').value;
                const lastFour = document.getElementById('paymentLastFour').value || '0000';
                const paymentMethod = lastFour ? `${paymentCardType}${lastFour}` : paymentCardType;
                
                // Get loyalty info
                const loyaltyInfo = getLoyaltyInfo();
                
                // Create expense object
                const expense = {
                    type: manualType.value,
                    vendor: manualVendor.value,
                    location: manualLocation.value,
                    date: manualDate.value,
                    amount: '$' + parseFloat(manualAmount.value).toFixed(2),
                    cardType: paymentMethod,
                    customerName: customerName,
                    loyaltyPrograms: loyaltyInfo,
                    // Add the nights property for hotel/car rental expenses
                    ...(manualType.value === 'Accommodation' && {nights: parseInt(hotelNights.value)}),
                    ...(manualType.value === 'Car Rental' && {days: parseInt(hotelNights.value)}),
                    // Add travel details for certain expense types
                    ...(manualType.value === 'Taxi / Car Service' && {
                        pickupLocation: document.getElementById('pickupLocation').value || '',
                        dropoffLocation: document.getElementById('returnLocation').value || '',
                    }),
                    ...(manualType.value === 'Car Rental' && {
                        pickupLocation: document.getElementById('pickupLocation').value || '',
                        returnLocation: document.getElementById('returnLocation').value || '',
                        vehicle: document.getElementById('vehicleModel').value || '',
                        licensePlate: document.getElementById('licensePlate').value || ''
                    }),
                };
                
                // Add to expenses array
                expenses.push(expense);
                
                // Display expenses
                displayParsedExpenses(expenses);
                parsedExpenses.classList.remove('hidden');
                
                // Clear form
                manualVendor.value = '';
                manualAmount.value = '';
                
                // Show success message
                alert('Expense added successfully!');
            });
            
            // Generate receipt for selected expense
            generateReceiptButton.addEventListener('click', function() {
                const selectedCheckboxes = document.querySelectorAll('input[name="expenseCheck"]:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('Please select at least one expense.');
                    return;
                }
                
                // Calculate required credits
                const creditsNeeded = proQuality.checked ? selectedCheckboxes.length * 2 : selectedCheckboxes.length;
                
                // Check if enough credits
                if (!useCredits(creditsNeeded)) {
                    alert(`Not enough credits. You need ${creditsNeeded} credits to generate ${selectedCheckboxes.length} receipt(s).`);
                    return;
                }
                
                // Generate receipts for selected expenses
                generatedReceipts = [];
                
                for (const checkbox of selectedCheckboxes) {
                    const selectedIndex = parseInt(checkbox.value);
                    const selectedExpense = expenses[selectedIndex];
                    
                    // Get customer name (use default if not provided)
                    const customerName = selectedExpense.customerName || document.getElementById('customerName').value || 'Guest';
                    
                    // Get payment method info if not already set
                    let paymentMethod = selectedExpense.cardType;
                    if (!paymentMethod) {
                        const paymentCardType = document.getElementById('paymentCardType').value;
                        const lastFour = document.getElementById('paymentLastFour').value || '0000';
                        paymentMethod = lastFour ? `${paymentCardType}${lastFour}` : paymentCardType;
                    }
                    
                    // Get loyalty info
                    const loyaltyInfo = selectedExpense.loyaltyPrograms || getLoyaltyInfo();
                    const loyaltyNumber = loyaltyInfo && loyaltyInfo.length > 0 ? loyaltyInfo[0].number : '';
                    
                    // Get company policy values
                    const policy = {
                        customerName: customerName,
                        paymentMethod: paymentMethod,
                        loyaltyNumber: loyaltyNumber,
                        taxRate: userTaxRate !== null ? userTaxRate : parseFloat(document.getElementById('taxRate').value) || 8.25,
                        receiptQuality: proQuality.checked ? 'pro' : 'basic'
                    };
                    
                    // Generate receipt HTML
                    const receiptHTML = generateReceipt(selectedExpense, policy);
                    generatedReceipts.push(receiptHTML);
                }
                
                // Display the first receipt
                currentReceiptIndex = 0;
                showCurrentReceipt();
                receiptModal.classList.remove('hidden');
                
                // Populate edit fields for the first receipt
                populateEditFields(expenses[parseInt(selectedCheckboxes[0].value)]);
            });
            
            // Receipt edit functionality
            applyEditsBtn.addEventListener('click', function() {
                // Get the current receipt data
                const currentReceipt = expenses[parseInt(document.querySelectorAll('input[name="expenseCheck"]:checked')[currentReceiptIndex].value)];
                if (!currentReceipt) return;
                
                // Update receipt data with edited values
                if (editVendor.value) currentReceipt.vendor = editVendor.value;
                if (editLocation.value) currentReceipt.location = editLocation.value;
                
                // Update date if provided
                if (editDate.value) {
                    currentReceipt.date = editDate.value;
                }
                
                // Update amount if provided
                if (editAmount.value && !isNaN(parseFloat(editAmount.value))) {
                    currentReceipt.amount = '$' + parseFloat(editAmount.value).toFixed(2);
                }
                
                // Update tax rate if provided
                if (editTaxRate.value && !isNaN(parseFloat(editTaxRate.value))) {
                    userTaxRate = parseFloat(editTaxRate.value);
                    taxRateInput.value = userTaxRate;
                }
                
                // Update payment method
                if (editPaymentMethod.value) {
                    const lastFour = editLastFour.value || '0000';
                    currentReceipt.cardType = lastFour ? `${editPaymentMethod.value}${lastFour}` : editPaymentMethod.value;
                }
                
                // Regenerate the receipt HTML with updated data
                const policy = {
                    customerName: currentReceipt.customerName || document.getElementById('customerName').value || 'Guest',
                    paymentMethod: currentReceipt.cardType,
                    loyaltyNumber: currentReceipt.loyaltyPrograms && currentReceipt.loyaltyPrograms.length > 0 ? 
                        currentReceipt.loyaltyPrograms[0].number : '',
                    taxRate: userTaxRate !== null ? userTaxRate : parseFloat(document.getElementById('taxRate').value) || 8.25,
                    receiptQuality: proQuality.checked ? 'pro' : 'basic'
                };
                
                const receiptHtml = generateReceipt(currentReceipt, policy);
                generatedReceipts[currentReceiptIndex] = receiptHtml;
                receiptContent.innerHTML = receiptHtml;
                
                // Show success message
                const successMessage = document.createElement('div');
                successMessage.className = 'bg-green-600 text-white p-2 rounded mt-2 text-center';
                successMessage.textContent = 'Receipt updated successfully';
                
                // Insert after the apply button
                applyEditsBtn.parentNode.appendChild(successMessage);
                
                // Remove the message after 2 seconds
                setTimeout(() => {
                    successMessage.remove();
                }, 2000);
                
                // Update the expense list
                displayParsedExpenses(expenses);
            });
            
            // Populate edit fields when viewing a receipt
            function populateEditFields(expense) {
                editVendor.value = expense.vendor || '';
                editLocation.value = expense.location || '';
                
                // Format date for date input (YYYY-MM-DD)
                if (expense.date) {
                    editDate.value = expense.date;
                } else {
                    editDate.value = '';
                }
                
                // Set time value if available
                editTime.value = expense.time || '';
                
                // Set amount - strip $ sign
                if (expense.amount) {
                    editAmount.value = expense.amount.replace('$', '').replace(',', '');
                } else {
                    editAmount.value = '';
                }
                
                // Set tax rate
                editTaxRate.value = userTaxRate !== null ? userTaxRate : document.getElementById('taxRate').value;
                
                // Set payment method
                if (expense.cardType) {
                    const paymentMethod = expense.cardType.split('')[0];
                    // Find the option that matches the payment method
                    const options = Array.from(editPaymentMethod.options);
                    const option = options.find(opt => paymentMethod.includes(opt.value));
                    if (option) {
                        editPaymentMethod.value = option.value;
                    } else {
                        editPaymentMethod.value = 'VISA'; // Default
                    }
                    
                    // Set last four digits
                    const lastFourMatch = expense.cardType.match(/(\d{4})/);
                    if (lastFourMatch) {
                        editLastFour.value = lastFourMatch[1];
                    } else {
                        editLastFour.value = '';
                    }
                } else {
                    editPaymentMethod.value = document.getElementById('paymentCardType').value;
                    editLastFour.value = document.getElementById('paymentLastFour').value;
                }
            }
            
            // Add navigation event handlers to populate edit fields
            prevReceiptBtn.addEventListener('click', function() {
                if (currentReceiptIndex > 0) {
                    currentReceiptIndex--;
                    showCurrentReceipt();
                    
                    // Get the index of the displayed expense
                    const selectedCheckboxes = document.querySelectorAll('input[name="expenseCheck"]:checked');
                    if (selectedCheckboxes.length > currentReceiptIndex) {
                        const expenseIndex = parseInt(selectedCheckboxes[currentReceiptIndex].value);
                        populateEditFields(expenses[expenseIndex]);
                    }
                }
            });
            
            nextReceiptBtn.addEventListener('click', function() {
                if (currentReceiptIndex < generatedReceipts.length - 1) {
                    currentReceiptIndex++;
                    showCurrentReceipt();
                    
                    // Get the index of the displayed expense
                    const selectedCheckboxes = document.querySelectorAll('input[name="expenseCheck"]:checked');
                    if (selectedCheckboxes.length > currentReceiptIndex) {
                        const expenseIndex = parseInt(selectedCheckboxes[currentReceiptIndex].value);
                        populateEditFields(expenses[expenseIndex]);
                    }
                }
            });
            
            // Navigate between receipts
            function showCurrentReceipt() {
                receiptContent.innerHTML = generatedReceipts[currentReceiptIndex];
                receiptCounter.textContent = `Receipt ${currentReceiptIndex + 1} of ${generatedReceipts.length}`;
                
                // Update navigation buttons
                prevReceiptBtn.disabled = currentReceiptIndex === 0;
                prevReceiptBtn.classList.toggle('opacity-50', currentReceiptIndex === 0);
                
                nextReceiptBtn.disabled = currentReceiptIndex === generatedReceipts.length - 1;
                nextReceiptBtn.classList.toggle('opacity-50', currentReceiptIndex === generatedReceipts.length - 1);
            }
            
            // Batch process all receipts
            generateAllReceiptsButton.addEventListener('click', async function() {
                if (expenses.length === 0) {
                    alert('No expenses found to process.');
                    return;
                }
                
                // Calculate required credits
                const creditsNeeded = proQuality.checked ? expenses.length * 2 : expenses.length;
                
                // Check if enough credits
                if (!useCredits(creditsNeeded)) {
                    alert(`Not enough credits. You need ${creditsNeeded} credits to generate all ${expenses.length} receipts.`);
                    return;
                }
                
                // Show batch processing UI
                batchProcessingStatus.classList.remove('hidden');
                skippedExpensesList.classList.add('hidden');
                skippedList.innerHTML = '';
                
                // Create array for receipts
                let allReceipts = [];
                let skippedExpenses = [];
                let processedCount = 0;
                let totalSuccessCount = 0;
                
                // Start batch processing
                for (let i = 0; i < expenses.length; i++) {
                    const expense = expenses[i];
                    
                    // Update progress
                    const progress = Math.round((i / expenses.length) * 100);
                    batchProgress.style.width = `${progress}%`;
                    batchStatusText.textContent = `Processing ${i + 1} of ${expenses.length} expenses...`;
                    
                    // Get customer name (use default if not provided)
                    const customerName = expense.customerName || document.getElementById('customerName').value || 'Guest';
                    
                    // Get payment method info if not already set
                    let paymentMethod = expense.cardType;
                    if (!paymentMethod) {
                        const paymentCardType = document.getElementById('paymentCardType').value;
                        const lastFour = document.getElementById('paymentLastFour').value || '0000';
                        paymentMethod = lastFour ? `${paymentCardType}${lastFour}` : paymentCardType;
                    }
                    
                    // Get loyalty info
                    const loyaltyInfo = expense.loyaltyPrograms || getLoyaltyInfo();
                    const loyaltyNumber = loyaltyInfo && loyaltyInfo.length > 0 ? loyaltyInfo[0].number : '';
                    
                    // Get company policy values
                    const policy = {
                        customerName: customerName,
                        paymentMethod: paymentMethod,
                        loyaltyNumber: loyaltyNumber,
                        taxRate: userTaxRate !== null ? userTaxRate : parseFloat(document.getElementById('taxRate').value) || 8.25,
                        receiptQuality: proQuality.checked ? 'pro' : 'basic'
                    };
                    
                    // Generate receipt
                    try {
                        const receiptHTML = generateReceipt(expense, policy);
                        allReceipts.push(receiptHTML);
                        totalSuccessCount++;
                    } catch (error) {
                        console.error('Error generating receipt:', error);
                        skippedExpenses.push({
                            vendor: expense.vendor,
                            location: expense.location,
                            amount: expense.amount,
                            date: expense.date,
                            reason: 'Receipt generation failed'
                        });
                    }
                    
                    processedCount++;
                    
                    // Add small delay to allow UI to update
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                // Update final status
                batchProgress.style.width = '100%';
                batchStatusText.textContent = `Completed: Generated ${totalSuccessCount} of ${expenses.length} receipts.`;
                
                // Show skipped expenses if any
                if (skippedExpenses.length > 0) {
                    skippedExpensesList.classList.remove('hidden');
                    skippedExpenses.forEach(expense => {
                        const li = document.createElement('li');
                        li.textContent = `${expense.vendor} (${expense.date}) - ${expense.amount} - ${expense.location} - Reason: ${expense.reason}`;
                        skippedList.appendChild(li);
                    });
                }
                
                // Alert completion
                alert(`Receipt generation complete!\n${totalSuccessCount} receipts created.\n${skippedExpenses.length} receipts skipped due to issues.`);
            });
            
            // Clear all expenses
            clearExpensesButton.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all expenses?')) {
                    expenses = [];
                    displayParsedExpenses(expenses);
                }
            });

            // Close modal
            closeModal.addEventListener('click', function() {
                receiptModal.classList.add('hidden');
            });

            // Close modal when clicking outside
            receiptModal.addEventListener('click', function(e) {
                if (e.target === receiptModal) {
                    receiptModal.classList.add('hidden');
                }
            });

            // Download as PDF
            downloadPdf.addEventListener('click', async function() {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    
                    // Create a clone of the receipt container without watermark
                    const tempContainer = document.createElement('div');
                    tempContainer.innerHTML = receiptContent.innerHTML;
                    tempContainer.classList.add('download-receipt');
                    tempContainer.style.backgroundColor = '#ffffff';
                    tempContainer.style.padding = '20px';
                    document.body.appendChild(tempContainer);
                    
                    // Apply dark text for download
                    const allElements = tempContainer.querySelectorAll('*');
                    allElements.forEach(el => {
                        el.style.color = '#000000';
                    });
                    
                    const canvas = await html2canvas(tempContainer, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        useCORS: true
                    });
                    
                    document.body.removeChild(tempContainer);
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210 - 20; // A4 width minus margins
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 10; // Top margin
                    
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight - 20;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight + 10;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight - 20;
                    }
                    
                    const fileName = `receipt_${generateRandomReceiptNumber()}.pdf`;
                    pdf.save(fileName);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                }
            });

            // Download as PNG
            downloadPng.addEventListener('click', async function() {
                try {
                    // Create a clone of the receipt container without watermark
                    const tempContainer = document.createElement('div');
                    tempContainer.innerHTML = receiptContent.innerHTML;
                    tempContainer.classList.add('download-receipt');
                    tempContainer.style.backgroundColor = '#ffffff';
                    tempContainer.style.padding = '20px';
                    document.body.appendChild(tempContainer);
                    
                    // Apply dark text for download
                    const allElements = tempContainer.querySelectorAll('*');
                    allElements.forEach(el => {
                        el.style.color = '#000000';
                    });
                    
                    const canvas = await html2canvas(tempContainer, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        useCORS: true
                    });
                    
                    document.body.removeChild(tempContainer);
                    
                    const link = document.createElement('a');
                    link.download = `receipt_${generateRandomReceiptNumber()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (error) {
                    console.error('Error generating PNG:', error);
                    alert('Error generating PNG. Please try again.');
                }
            });

            // Parse expense data from Concur format
            function parseExpenseData(data) {
                const lines = data.split('\n');
                const expenses = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Look for expense type indicators
                    if (line.includes('Individual-') || 
                        line.includes('Taxi / Car Service') || 
                        line.includes('Accommodation') ||
                        line.includes('Car Rental') ||
                        line.includes('Airfare') ||
                        line.includes('Undefined')) {
                        
                        const type = line;
                        let vendor = '';
                        let location = '';
                        let date = '';
                        let amount = '';
                        
                        // Get vendor from next line
                        if (i + 1 < lines.length) {
                            vendor = lines[i + 1].trim();
                        }
                        
                        // Get location and date
                        if (i + 2 < lines.length) {
                            const locDateLine = lines[i + 2].trim();
                            const dateMatch = locDateLine.match(/(\d{2}\/\d{2}\/\d{4})/);
                            
                            if (dateMatch) {
                                date = dateMatch[0];
                                location = locDateLine.replace(date, '').trim();
                            } else {
                                location = locDateLine;
                            }
                        }
                        
                        // Get amount
                        if (i + 3 < lines.length) {
                            const amountLine = lines[i + 3].trim();
                            const amountMatch = amountLine.match(/\$([0-9,]+\.\d{2})/);
                            
                            if (amountMatch) {
                                amount = amountMatch[0];
                            } else if (amountLine.startsWith('$')) {
                                amount = amountLine;
                            }
                        }
                        
                        // Get customer name if available (from form)
                        const customerName = document.getElementById('customerName').value || '';
                        
                        // Get payment method
                        const paymentCardType = document.getElementById('paymentCardType').value;
                        const lastFour = document.getElementById('paymentLastFour').value || '0000';
                        const paymentMethod = lastFour ? `${paymentCardType}${lastFour}` : paymentCardType;
                        
                        // Get loyalty info
                        const loyaltyInfo = getLoyaltyInfo();
                        
                        // Only add if we have an amount
                        if (amount) {
                            expenses.push({
                                type,
                                vendor,
                                location,
                                date,
                                amount,
                                cardType: paymentMethod,
                                customerName: customerName,
                                loyaltyPrograms: loyaltyInfo,
                                // For hotels, default to 1 night
                                ...(type.includes('Accommodation') && {nights: 1}),
                                // For car rentals, default to 1 day
                                ...(type.includes('Car Rental') && {days: 1})
                            });
                        }
                    }
                }
                
                return expenses;
            }

            // Display parsed expenses in the table
            function displayParsedExpenses(expenses) {
                expenseTableBody.innerHTML = '';
                
                if (expenses.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="7" class="px-3 py-4 text-center text-gray-400">
                            No expenses added yet. Paste data or use manual entry.
                        </td>
                    `;
                    expenseTableBody.appendChild(row);
                    return;
                }
                
                expenses.forEach((expense, index) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-700';
                    
                    row.innerHTML = `
                        <td class="px-3 py-4">
                            <input type="checkbox" name="expenseCheck" value="${index}" class="h-4 w-4 text-primary border-gray-600 rounded">
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            ${expense.type}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            ${expense.vendor}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            ${expense.location}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            ${expense.date}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">
                            ${expense.amount}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            <button class="text-primary hover:text-blue-400 mr-2 delete-expense-btn" data-index="${index}">
                                Delete
                            </button>
                            <button class="text-green-500 hover:text-green-400 generate-single-btn" data-index="${index}">
                                Generate
                            </button>
                        </td>
                    `;
                    
                    expenseTableBody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-expense-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        expenses.splice(index, 1);
                        displayParsedExpenses(expenses);
                    });
                });
                
                // Add event listeners to generate single receipt buttons
                document.querySelectorAll('.generate-single-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        const expense = expenses[index];
                        
                        // Calculate required credits
                        const creditsNeeded = proQuality.checked ? 2 : 1;
                        
                        // Check if enough credits
                        if (!useCredits(creditsNeeded)) {
                            alert(`Not enough credits. You need ${creditsNeeded} credits to generate this receipt.`);
                            return;
                        }
                        
                        // Get customer name
                        const customerName = expense.customerName || document.getElementById('customerName').value || 'Guest';
                        
                        // Get payment method info if not already set
                        let paymentMethod = expense.cardType;
                        if (!paymentMethod) {
                            const paymentCardType = document.getElementById('paymentCardType').value;
                            const lastFour = document.getElementById('paymentLastFour').value || '0000';
                            paymentMethod = lastFour ? `${paymentCardType}${lastFour}` : paymentCardType;
                        }
                        
                        // Get loyalty info
                        const loyaltyInfo = expense.loyaltyPrograms || getLoyaltyInfo();
                        const loyaltyNumber = loyaltyInfo && loyaltyInfo.length > 0 ? loyaltyInfo[0].number : '';
                        
                        // Get company policy values
                        const policy = {
                            customerName: customerName,
                            paymentMethod: paymentMethod,
                            loyaltyNumber: loyaltyNumber,
                            taxRate: userTaxRate !== null ? userTaxRate : parseFloat(document.getElementById('taxRate').value) || 8.25,
                            receiptQuality: proQuality.checked ? 'pro' : 'basic'
                        };
                        
                        // Generate receipt
                        const receiptHTML = generateReceipt(expense, policy);
                        
                        // Set up for display
                        generatedReceipts = [receiptHTML];
                        currentReceiptIndex = 0;
                        showCurrentReceipt();
                        receiptModal.classList.remove('hidden');
                        
                        // Populate edit fields
                        populateEditFields(expense);
                    });
                });
            }

            // Generate Mileage Log
            function generateMileageLog(startDate, endDate, totalMiles, trips) {
                // Get vehicle info
                const vehicleMake = document.getElementById('vehicleMake').value || 'Toyota';
                const vehicleModel = document.getElementById('vehicleModel').value || 'Camry';
                const homeBase = document.getElementById('homeBase').value || 'Home Office';
                const endOdometer = document.getElementById('endOdometer').value || '45000';
                
                // Calculate dates between start and end
                const dateArray = [];
                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    dateArray.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // Randomly select dates for trips (or distribute evenly if more trips than days)
                let tripDates = [];
                if (trips <= dateArray.length) {
                    // Randomly select dates
                    const shuffled = [...dateArray].sort(() => 0.5 - Math.random());
                    tripDates = shuffled.slice(0, trips);
                } else {
                    // Distribute evenly with some dates having multiple trips
                    for (let i = 0; i < trips; i++) {
                        tripDates.push(dateArray[i % dateArray.length]);
                    }
                }
                
                // Sort the dates chronologically
                tripDates.sort((a, b) => a - b);
                
                // Calculate miles per trip (approximately)
                const milesPerTrip = totalMiles / trips;
                
                // Calculate starting odometer
                const startOdometer = parseInt(endOdometer) - totalMiles;
                
                // Generate trip destinations
                const destinations = [
                    "Client Meeting", 
                    "Sales Conference", 
                    "Customer Site Visit", 
                    "Regional Office",
                    "Business Lunch",
                    "Training Session",
                    "Project Kickoff",
                    "Vendor Meeting"
                ];
                
                // Generate mileage log HTML
                let mileageLogHtml = `
                    <div class="mileage-receipt">
                        <h2 style="text-align: center; margin-bottom: 15px; font-size: 20px; font-weight: bold; color: #000;">Mileage Log</h2>
                        
                        <div style="margin-bottom: 15px;">
                            <table style="width: 100%; font-size: 14px; color: #000;">
                                <tr>
                                    <td style="padding: 4px; width: 150px; color: #000;"><strong>Vehicle:</strong></td>
                                    <td style="padding: 4px; color: #000;">${vehicleMake} ${vehicleModel}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; color: #000;"><strong>Period:</strong></td>
                                    <td style="padding: 4px; color: #000;">${formatDate(startDate)} to ${formatDate(endDate)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; color: #000;"><strong>Starting Odometer:</strong></td>
                                    <td style="padding: 4px; color: #000;">${startOdometer} miles</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; color: #000;"><strong>Ending Odometer:</strong></td>
                                    <td style="padding: 4px; color: #000;">${endOdometer} miles</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; color: #000;"><strong>Total Miles:</strong></td>
                                    <td style="padding: 4px; color: #000;">${totalMiles} miles</td>
                                </tr>
                            </table>
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px; color: #000;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">Date</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">From</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">To</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">Purpose</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">Odometer Start</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">Odometer End</th>
                                    <th style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">Miles</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                let currentOdometer = startOdometer;
                
                // Generate rows for each trip
                tripDates.forEach((date, index) => {
                    const destination = destinations[Math.floor(Math.random() * destinations.length)];
                    const tripMiles = Math.round(milesPerTrip + (Math.random() * milesPerTrip * 0.2 - milesPerTrip * 0.1)); // Random variation 10%
                    const newOdometer = currentOdometer + tripMiles;
                    
                    mileageLogHtml += `
                        <tr>
                            <td style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">${formatDate(date)}</td>
                            <td style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">${homeBase}</td>
                            <td style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">${destination}</td>
                            <td style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">Business Travel</td>
                            <td style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">${currentOdometer}</td>
                            <td style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">${newOdometer}</td>
                            <td style="padding: 8px; text-align: left; border: 1px solid #ddd; color: #000;">${tripMiles}</td>
                        </tr>
                    `;
                    
                    currentOdometer = newOdometer;
                });
                
                mileageLogHtml += `
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; text-align: center; font-size: 14px;">
                            <p style="margin: 5px 0; color: #000;">This mileage log is provided for record-keeping purposes only.</p>
                            <p style="margin: 5px 0; color: #000;">Standard mileage rate for business use: $0.655 per mile (2023)</p>
                        </div>
                    </div>
                `;
                
                return mileageLogHtml;
            }

            // Generate Toll Receipt
            function generateTollReceipt(startDate, endDate, totalAmount, tolls) {
                // Get toll pass system
                const tollPassSystem = document.getElementById('tollPassSystem').value;
                const vehicleMake = document.getElementById('vehicleMake').value || 'Toyota';
                const vehicleModel = document.getElementById('vehicleModel').value || 'Camry';
                
                // Calculate dates between start and end
                const dateArray = [];
                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    dateArray.push(new Date(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // Randomly select dates for tolls (or distribute evenly if more tolls than days)
                let tollDates = [];
                if (tolls <= dateArray.length) {
                    // Randomly select dates
                    const shuffled = [...dateArray].sort(() => 0.5 - Math.random());
                    tollDates = shuffled.slice(0, tolls);
                } else {
                    // Distribute evenly with some dates having multiple tolls
                    for (let i = 0; i < tolls; i++) {
                        tollDates.push(dateArray[i % dateArray.length]);
                    }
                }
                
                // Sort the dates chronologically
                tollDates.sort((a, b) => a - b);
                
                // Get toll locations based on selected system
                const tollSystem = tollData[tollPassSystem] || tollData['Other'];
                const locations = tollSystem.locations;
                
                // Calculate amount per toll (approximately)
                const amountPerToll = totalAmount / tolls;
                
                // Generate random account number
                const accountNumber = Math.floor(100000000 + Math.random() * 900000000);
                
                // Generate toll receipt HTML
                let tollReceiptHtml = `
                    <div class="toll-receipt">
                        <div class="header">
                            <h2 style="margin: 0; font-size: 22px; font-weight: bold; color: #000;">${tollPassSystem} Statement</h2>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">Toll Charges Summary</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <table style="width: 100%; font-size: 14px; color: #000;">
                                <tr>
                                    <td style="padding: 4px; width: 200px; color: #000;"><strong>Account Number:</strong></td>
                                    <td style="padding: 4px; color: #000;">${accountNumber}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; color: #000;"><strong>Statement Period:</strong></td>
                                    <td style="padding: 4px; color: #000;">${formatDate(startDate)} to ${formatDate(endDate)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; color: #000;"><strong>Vehicle:</strong></td>
                                    <td style="padding: 4px; color: #000;">${vehicleMake} ${vehicleModel}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 4px; color: #000;"><strong>Total Charges:</strong></td>
                                    <td style="padding: 4px; font-weight: bold; color: #000;">$${totalAmount.toFixed(2)}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <h3 style="margin: 15px 0 10px 0; font-size: 16px; font-weight: bold; color: #000;">Transaction Details</h3>
                        
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px; color: #000;">
                            <thead>
                                <tr style="background-color: #f5f5f5;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #000;">Date</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #000;">Time</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #000;">Location</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd; color: #000;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Generate rows for each toll
                let totalShown = 0;
                
                tollDates.forEach((date, index) => {
                    // Generate random time
                    const hours = Math.floor(Math.random() * 24);
                    const minutes = Math.floor(Math.random() * 60);
                    const time = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                    
                    // Select random location
                    const location = locations[Math.floor(Math.random() * locations.length)];
                    
                    // Calculate toll amount with some variation
                    const minAmount = location.min;
                    const maxAmount = location.max;
                    const tollAmount = parseFloat((minAmount + Math.random() * (maxAmount - minAmount)).toFixed(2));
                    
                    // Adjust final toll to make the total exactly match
                    let adjustedAmount = tollAmount;
                    if (index === tolls - 1) {
                        adjustedAmount = parseFloat((totalAmount - totalShown).toFixed(2));
                    } else {
                        totalShown += tollAmount;
                    }
                    
                    tollReceiptHtml += `
                        <tr>
                            <td style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #000;">${formatDate(date)}</td>
                            <td style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #000;">${time}</td>
                            <td style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #000;">${location.name}</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd; color: #000;">$${adjustedAmount.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                tollReceiptHtml += `
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="padding: 8px; text-align: right; font-weight: bold; border-top: 2px solid #ddd; color: #000;">Total:</td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold; border-top: 2px solid #ddd; color: #000;">$${totalAmount.toFixed(2)}</td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div style="margin-top: 20px; text-align: center; font-size: 14px; color: #666;">
                            <p style="margin: 5px 0; color: #666;">This statement is provided for record-keeping purposes only.</p>
                            <p style="margin: 5px 0; color: #666;">For questions about your account, please contact customer service.</p>
                        </div>
                    </div>
                `;
                
                return tollReceiptHtml;
            }

            // Generate a receipt for a given expense
            function generateReceipt(expense, policy) {
                // Parse amount
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                
                // Parse date (if it's a string)
                let date;
                if (typeof expense.date === 'string') {
                    // Handle different date formats (MM/DD/YYYY or YYYY-MM-DD)
                    if (expense.date.includes('/')) {
                        const parts = expense.date.split('/');
                        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                    } else {
                        date = new Date(expense.date);
                    }
                } else {
                    date = expense.date || new Date();
                }
                
                // Determine if receipt is basic or premium quality
                const isProQuality = policy.receiptQuality === 'pro';
                
                // Determine receipt type based on vendor and expense type
                // This helps us select the appropriate template
                let receiptType = 'generic';
                
                if (expense.vendor.toUpperCase().includes('UBER') || expense.vendor.toUpperCase().includes('LYFT') || 
                    expense.type.includes('Taxi / Car Service')) {
                    receiptType = 'rideshare';
                } else if (expense.vendor.toUpperCase().includes('HILTON') || 
                          (expense.type.includes('Accommodation') && !expense.vendor.toUpperCase().includes('MARRIOTT'))) {
                    receiptType = 'hilton';
                } else if (expense.vendor.toUpperCase().includes('MARRIOTT') || expense.vendor.toUpperCase().includes('ALOFT')) {
                    receiptType = 'marriott';
                } else if (expense.type.includes('Car Rental') || expense.vendor.toUpperCase().includes('AVIS') || 
                          expense.vendor.toUpperCase().includes('HERTZ') || expense.vendor.toUpperCase().includes('ENTERPRISE')) {
                    receiptType = 'carrental';
                } else if (expense.type.includes('Individual-')) {
                    receiptType = 'restaurant';
                }
                
                // Select the receipt template based on type and quality
                if (receiptType === 'rideshare') {
                    return generateRideshareReceipt(expense, policy, isProQuality);
                } else if (receiptType === 'hilton') {
                    return generateHiltonReceipt(expense, policy, isProQuality);
                } else if (receiptType === 'marriott') {
                    return generateMarriottReceipt(expense, policy, isProQuality);
                } else if (receiptType === 'carrental') {
                    return generateCarRentalReceipt(expense, policy, isProQuality);
                } else if (receiptType === 'restaurant') {
                    return generateRestaurantReceipt(expense, policy, isProQuality);
                } else {
                    return generateGenericReceipt(expense, policy, isProQuality);
                }
            }
            
            // Restaurant-style receipt (Jack Stack Barbecue style)
            function generateRestaurantReceipt(expense, policy, isProQuality) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                let date;
                if (typeof expense.date === 'string') {
                    if (expense.date.includes('/')) {
                        const parts = expense.date.split('/');
                        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                    } else {
                        date = new Date(expense.date);
                    }
                } else {
                    date = expense.date || new Date();
                }
                
                // Format date properly
                const formattedDate = formatDate(date);
                
                // Calculate receipt components based on tax rate
                const taxRate = policy.taxRate;
                const taxAmount = parseFloat((amount * taxRate / 100 / (1 + taxRate / 100)).toFixed(2));
                const subtotal = parseFloat((amount - taxAmount).toFixed(2));
                
                // Generate random server name
                const serverNames = ["Amy", "John", "Michael", "Sarah", "David", "Lisa", "Robert", "Jessica"];
                const serverName = serverNames[Math.floor(Math.random() * serverNames.length)];
                
                // Generate random server ID
                const serverID = `${Math.floor(100 + Math.random() * 900)}/${Math.floor(1 + Math.random() * 9)}`;
                
                // Generate random receipt number
                const receiptNumber = Math.floor(100000 + Math.random() * 900000);
                
                // Generate random table number
                const tableNumber = Math.floor(10 + Math.random() * 90);
                
                // Generate random check number
                const checkNumber = Math.floor(10000 + Math.random() * 90000);
                
                // Generate random auth code
                const authCode = Math.floor(100000 + Math.random() * 900000);
                
                // Check if it's a food/meal receipt
                const mealType = expense.type.includes('Dinner') ? 'Dinner' : 
                               expense.type.includes('Lunch') ? 'Lunch' : 'Breakfast';
                
                // Generate menu items based on meal type
                let menuItems = [];
                
                // More detailed for premium receipts
                if (isProQuality) {
                    const numItems = Math.floor(Math.random() * 3) + 2; // 2-4 items
                    let remainingSubtotal = subtotal;
                    
                    for (let i = 0; i < numItems; i++) {
                        let itemPrice;
                        
                        if (i === numItems - 1) {
                            // Last item gets remainder
                            itemPrice = parseFloat(remainingSubtotal.toFixed(2));
                        } else {
                            // Random portion of remaining subtotal
                            const portion = 0.3 + Math.random() * 0.4; // 30-70% of remaining
                            itemPrice = parseFloat((remainingSubtotal * portion).toFixed(2));
                            remainingSubtotal -= itemPrice;
                        }
                        
                        menuItems.push({
                            name: generateRandomFoodItem(mealType, i !== 0), // First item is main dish
                            price: itemPrice,
                            quantity: 1
                        });
                    }
                } else {
                    // Simpler for basic receipts
                    const mainItemPrice = parseFloat((subtotal * 0.7).toFixed(2));
                    const sideItemPrice = parseFloat((subtotal - mainItemPrice).toFixed(2));
                    
                    menuItems.push({
                        name: generateRandomFoodItem(mealType, false),
                        price: mainItemPrice,
                        quantity: 1
                    });
                    
                    menuItems.push({
                        name: generateRandomFoodItem(mealType, true),
                        price: sideItemPrice,
                        quantity: 1
                    });
                }
                
                // Generate HTML for restaurant receipt (Jack Stack style)
                let receiptHTML = `
                    <div data-quality="${policy.receiptQuality}" class="restaurant-receipt receipt-text" style="font-family: 'Courier New', monospace; max-width: 350px; margin: 0 auto; text-align: center; color: #000;">
                        <div class="header">
                            <h2 style="margin: 0; font-size: 16px; font-weight: bold; color: #000;">${expense.vendor}</h2>
                            <p style="margin: 2px 0; font-size: 12px; color: #000;">${expense.location}</p>
                            <p style="margin: 2px 0; font-size: 12px; color: #000;">${expense.location.split(',')[0]} ${isProQuality ? ', MO 64108' : ''}</p>
                            ${isProQuality ? `<p style="margin: 2px 0; font-size: 12px; color: #000;">(123) 456-7890</p>` : ''}
                        </div>
                        
                        <div style="text-align: left; margin-top: 10px; font-size: 12px; color: #000;">
                            <p style="margin: 0; color: #000;">Server: ${serverName}</p>
                            <p style="margin: 0; color: #000;">Table: ${tableNumber}</p>
                            <p style="margin: 0; color: #000;">Check: ${checkNumber}</p>
                            <p style="margin: 0; color: #000;">Date: ${formattedDate}</p>
                        </div>
                        
                        <div class="divider" style="border-top: 1px dashed #aaa; margin: 8px 0;"></div>
                        
                        <div style="text-align: left; color: #000;">
                `;
                
                // Add menu items
                menuItems.forEach(item => {
                    receiptHTML += `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px; color: #000;">
                            <span style="flex: 0 0 30px; color: #000;">${item.quantity}</span>
                            <span style="flex: 1; color: #000;">${item.name}</span>
                            <span style="flex: 0 0 60px; text-align: right; color: #000;">$${item.price.toFixed(2)}</span>
                        </div>
                    `;
                });
                
                receiptHTML += `
                        </div>
                        
                        <div class="divider" style="border-top: 1px dashed #aaa; margin: 8px 0;"></div>
                        
                        <div style="text-align: right; font-size: 12px; color: #000;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #000;">Subtotal</span>
                                <span style="color: #000;">$${subtotal.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #000;">Tax</span>
                                <span style="color: #000;">$${taxAmount.toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #aaa;">
                                <span style="color: #000;">Total</span>
                                <span style="color: #000;">$${amount.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        ${isProQuality ? `
                        <div class="divider" style="border-top: 1px dashed #aaa; margin: 8px 0;"></div>
                        
                        <div style="text-align: left; font-size: 12px; color: #000;">
                            <p style="margin: 0; color: #000;">PURCHASE</p>
                            <p style="margin: 0; color: #000;">${policy.paymentMethod.includes('AMEX') ? 'AMERICAN EXPRESS' : policy.paymentMethod.includes('VISA') ? 'VISA' : policy.paymentMethod.includes('MC') ? 'MASTERCARD' : 'CREDIT CARD'}</p>
                            <p style="margin: 0; color: #000;">CARD #: XXXXXXXXXXXX${policy.paymentMethod.includes('') ? policy.paymentMethod.split('')[1] : '1009'}</p>
                            <p style="margin: 0; color: #000;">AUTH CODE: ${authCode}</p>
                        </div>
                        
                        <div class="divider" style="border-top: 1px dashed #aaa; margin: 8px 0;"></div>
                        
                        <div style="text-align: center; font-size: 12px; color: #000;">
                            <p style="margin: 0; color: #000;">Gratuities Not Included</p>
                            <p style="margin: 2px 0; color: #000;">For Your Convenience</p>
                            <div style="display: flex; justify-content: space-between; margin: 2px 50px;">
                                <span style="color: #000;">18% = </span>
                                <span style="color: #000;">$${(subtotal * 0.18).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 50px;">
                                <span style="color: #000;">20% = </span>
                                <span style="color: #000;">$${(subtotal * 0.20).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 2px 50px;">
                                <span style="color: #000;">22% = </span>
                                <span style="color: #000;">$${(subtotal * 0.22).toFixed(2)}</span>
                            </div>
                            <p style="margin: 6px 0 2px 0; font-weight: bold; color: #000;">Merchant Copy</p>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                return receiptHTML;
            }
            
            // Generate Uber/Lyft style receipt
            function generateRideshareReceipt(expense, policy, isProQuality) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                let date;
                if (typeof expense.date === 'string') {
                    if (expense.date.includes('/')) {
                        const parts = expense.date.split('/');
                        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                    } else {
                        date = new Date(expense.date);
                    }
                } else {
                    date = expense.date || new Date();
                }
                
                // Generate random time
                const hours = Math.floor(Math.random() * 12) + 1;
                const minutes = Math.floor(Math.random() * 60);
                const ampm = Math.random() > 0.5 ? 'AM' : 'PM';
                const formattedTime = `${hours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
                
                // Calculate components
                const subtotal = parseFloat((amount * 0.70).toFixed(2));
                const bookingFee = parseFloat((amount * 0.05).toFixed(2));
                const surcharges = parseFloat((amount * 0.10).toFixed(2));
                const tip = parseFloat((amount * 0.15).toFixed(2));
                
                // Generate random ride details
                const durationMinutes = Math.floor(Math.random() * 35) + 10; // 10-45 minutes
                const distanceMiles = parseFloat((Math.random() * 20 + 2).toFixed(2)); // 2-22 miles
                
                // Pickup and dropoff locations
                const pickupLocation = expense.pickupLocation || "Main St & 1st Ave";
                const dropoffLocation = expense.dropoffLocation || "Airport Terminal 1";
                
                // Determine if it's Uber or Lyft
                const isUber = expense.vendor.includes('UBER');
                const serviceName = isUber ? "UBER" : "LYFT";
                const serviceColor = isUber ? "#000000" : "#FF00BF";
                
                // Random driver name
                const driverNames = ["Michael", "David", "Jennifer", "Maria", "John", "Robert", "Francisco", "Sarah", "James"];
                const driverName = driverNames[Math.floor(Math.random() * driverNames.length)];
                
                // Format date properly
                const formattedDate = formatDate(date);
                
                // Generate HTML for receipt
                let receiptHTML = `
                    <div data-quality="${policy.receiptQuality}" class="uber-receipt receipt-text" style="font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif; max-width: 400px; margin: 0 auto; padding: 20px; color: #000;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            ${isProQuality ? `<div style="margin-bottom: 10px;"><i class="fas fa-${isUber ? 'car' : 'car-side'}" style="font-size: 28px; color: ${serviceColor};"></i></div>` : ''}
                            <h2 style="margin: 0; font-size: 24px; color: ${serviceColor};">${serviceName}</h2>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">Receipt</p>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Date:</strong> ${formattedDate}</p>
                            <p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Time:</strong> ${formattedTime}</p>
                        </div>
                        
                        <div style="margin-bottom: 20px; border: 1px solid #eee; border-radius: 8px; padding: 12px;">
                            <p style="margin: 0 0 8px 0; font-size: 13px; color: #666;">${hours-1}:${minutes.toString().padStart(2, '0')} ${ampm} | ${pickupLocation}</p>
                            <p style="margin: 0; font-size: 13px; color: #666;">${formattedTime} | ${dropoffLocation}</p>
                            <div style="margin-top: 12px; font-size: 14px; color: #000;">
                                <span>${isUber ? 'UberX' : 'Lyft'}</span>
                                <span style="margin-left: 10px;">${distanceMiles} miles</span>
                                <span style="margin-left: 10px;">| ${durationMinutes} min</span>
                            </div>
                        </div>
                        
                        ${isProQuality ? `
                        <div style="margin-bottom: 15px; border-top: 1px solid #eee; padding-top: 12px;">
                            <p style="margin: 3px 0; font-size: 14px; color: #000;">Thanks for riding${policy.customerName !== 'Guest' ? ', ' + policy.customerName.split(' ')[0] : ''}!</p>
                            <p style="margin: 3px 0; font-size: 14px; color: #000;">You rode with ${driverName}</p>
                        </div>
                        ` : ''}
                        
                        <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 5px;">
                            <table style="width: 100%; border-collapse: collapse; color: #000;">
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Trip fare</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${subtotal.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Booking Fee</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${bookingFee.toFixed(2)}</td>
                                </tr>
                                ${isProQuality && (expense.location.toLowerCase().includes('airport') || dropoffLocation.toLowerCase().includes('airport')) ? `
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Airport Surcharge</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${surcharges.toFixed(2)}</td>
                                </tr>
                                ` : `
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Service Fee</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${surcharges.toFixed(2)}</td>
                                </tr>
                                `}
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Tip</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${tip.toFixed(2)}</td>
                                </tr>
                                <tr style="font-weight: bold;">
                                    <td style="text-align: left; padding: 8px 0; border-top: 2px solid #eee; color: #000;">Total</td>
                                    <td style="text-align: right; padding: 8px 0; border-top: 2px solid #eee; color: #000;">$${amount.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Payment</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">${policy.paymentMethod}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-top: 25px; text-align: center; color: #999; font-size: 12px;">
                            <p>Visit the trip page for more information, including invoices (where available)</p>
                        </div>
                    </div>
                `;
                
                return receiptHTML;
            }
            
            // Generate Hilton receipt
            function generateHiltonReceipt(expense, policy, isProQuality) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                let date;
                if (typeof expense.date === 'string') {
                    if (expense.date.includes('/')) {
                        const parts = expense.date.split('/');
                        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                    } else {
                        date = new Date(expense.date);
                    }
                } else {
                    date = expense.date || new Date();
                }
                
                const nights = expense.nights || 1;
                
                // Calculate check-in date (checkout date - nights)
                const checkInDate = new Date(date);
                checkInDate.setDate(checkInDate.getDate() - nights);
                
                // Generate folio number
                const folioNumber = Math.floor(1000000000 + Math.random() * 9000000000);
                const confirmationNumber = Math.floor(3000000000 + Math.random() * 9000000000);
                
                // Calculate room rate and taxes
                const roomRate = parseFloat((amount * 0.85 / nights).toFixed(2));
                const stateTax = parseFloat((roomRate * 0.10).toFixed(2));
                const cityTax = parseFloat((roomRate * 0.075).toFixed(2));
                const occupancyTax = parseFloat((roomRate * 0.01).toFixed(2));
                const additionalTax = parseFloat((roomRate * 0.005).toFixed(2));
                
                // Room number (random 3-digit number)
                const roomNumber = Math.floor(100 + Math.random() * 900);
                
                // Format dates properly
                const formattedCheckInDate = formatDate(checkInDate);
                const formattedCheckOutDate = formatDate(date);
                
                // Generate HTML for receipt
                let receiptHTML = `
                    <div data-quality="${policy.receiptQuality}" class="hilton-receipt receipt-text" style="font-family: 'Georgia', serif; max-width: 680px; margin: 0 auto; padding: 20px; color: #000;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h2 style="margin: 0; font-size: 22px; color: #00538A;">Hilton ${expense.location.split(',')[0]}</h2>
                                <p style="margin: 4px 0; font-size: 13px; color: #555;">${expense.location}</p>
                                ${isProQuality ? `<p style="margin: 2px 0; font-size: 12px; color: #555;">Tel: (123) 456-7890 | Email: info@hilton.com</p>` : ''}
                            </div>
                        </div>
                        
                        <div style="border-bottom: 1px solid #ddd; margin-bottom: 15px; padding-bottom: 10px;">
                            <h3 style="margin: 0; font-size: 18px; color: #00538A;">Guest Folio</h3>
                            <p style="margin: 4px 0; font-size: 13px; color: #555;">Confirmation Number - ${confirmationNumber}</p>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #00538A;">Primary Guest</h4>
                                <p style="margin: 2px 0; font-size: 13px; color: #333;"><strong>${policy.customerName.toUpperCase()}</strong></p>
                                ${isProQuality ? `
                                <p style="margin: 2px 0; font-size: 13px; color: #555;">123 MAIN ST</p>
                                <p style="margin: 2px 0; font-size: 13px; color: #555;">ANYTOWN, CA 90210</p>
                                ` : ''}
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #00538A;">Stay Details</h4>
                                <table style="font-size: 13px; color: #333; width: 100%;">
                                    <tr>
                                        <td style="padding: 2px 10px 2px 0; color: #333;">Check In Date</td>
                                        <td style="padding: 2px 0; color: #333;">${formattedCheckInDate}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 10px 2px 0; color: #333;">Check Out Date</td>
                                        <td style="padding: 2px 0; color: #333;">${formattedCheckOutDate}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 10px 2px 0; color: #333;">Room</td>
                                        <td style="padding: 2px 0; color: #333;">KING - ${roomNumber}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 10px 2px 0; color: #333;">Guests</td>
                                        <td style="padding: 2px 0; color: #333;">1/0</td>
                                    </tr>
                                </table>
                            </div>
                            
                            ${policy.loyaltyNumber ? `
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #00538A;">Hilton Honors</h4>
                                <p style="margin: 2px 0; font-size: 13px; color: #333;">${policy.loyaltyNumber}</p>
                                <p style="margin: 2px 0; font-size: 13px; color: #333;">Gold</p>
                            </div>
                            ` : ''}
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; color: #000;">
                            <thead>
                                <tr style="background-color: #f5f5f5; color: #333;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #333;">Date</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #333;">Type</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #333;">Description</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd; color: #333;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Generate entries for each night
                for (let i = 0; i < nights; i++) {
                    const currentDate = new Date(checkInDate);
                    currentDate.setDate(currentDate.getDate() + i);
                    const formattedCurrentDate = formatDate(currentDate);
                    
                    receiptHTML += `
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Charge</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">GUEST ROOM</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${roomRate.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Tax</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">RM SALES TAX</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${stateTax.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Tax</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">RM CITY OCCUPANCY TAX</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${cityTax.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Tax</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">RM CITY ARENA FEE</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${occupancyTax.toFixed(2)}</td>
                        </tr>
                    `;
                    
                    // Add food charges for pro quality
                    if (isProQuality && i < nights - 1) {
                        const foodCharge = parseFloat((Math.random() * 15 + 10).toFixed(2));
                        const foodTax = parseFloat((foodCharge * 0.0825).toFixed(2));
                        const tipAmount = parseFloat((foodCharge * 0.18).toFixed(2));
                        
                        receiptHTML += `
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Charge</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">GALLERY BFAST - POS #${Math.floor(1000 + Math.random() * 9000)}</td>
                                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${foodCharge.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Tax</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">FB SALES TAX</td>
                                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${foodTax.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Charge</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">GALLERY TIPS - POS #${Math.floor(1000 + Math.random() * 9000)}</td>
                                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${tipAmount.toFixed(2)}</td>
                            </tr>
                        `;
                    }
                }
                
                // Payment line
                receiptHTML += `
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCheckOutDate}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Payments</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${policy.paymentMethod}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">($${amount.toFixed(2)})</td>
                    </tr>
                `;
                
                // Complete the receipt
                receiptHTML += `
                            </tbody>
                        </table>
                        
                        <div style="border-top: 1px solid #ddd; padding-top: 15px; text-align: right;">
                            <table style="margin-left: auto; width: auto; color: #000;">
                                <tr>
                                    <td style="padding: 4px 15px 4px 0; font-weight: bold; color: #333;">Folio Balance</td>
                                    <td style="padding: 4px 0; font-weight: bold; color: #333;">$0.00</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center; color: #666; font-size: 11px;">
                            <p style="margin: 0;">Check In Time: 03:00 PM | Check Out Time: 12:00 PM</p>
                            <p style="margin: 5px 0;">Reservations: hiltonhotels.com or 1-800-HILTONS</p>
                        </div>
                    </div>
                `;
                
                return receiptHTML;
            }
            
            // Generate Marriott/Aloft receipt
            function generateMarriottReceipt(expense, policy, isProQuality) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                let date;
                if (typeof expense.date === 'string') {
                    if (expense.date.includes('/')) {
                        const parts = expense.date.split('/');
                        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                    } else {
                        date = new Date(expense.date);
                    }
                } else {
                    date = expense.date || new Date();
                }
                
                const nights = expense.nights || 1;
                
                // Calculate check-in date (checkout date - nights)
                const checkInDate = new Date(date);
                checkInDate.setDate(checkInDate.getDate() - nights);
                
                // Format dates properly
                const formattedCheckInDate = formatDate(checkInDate, 'DD-MMM-YY');
                const formattedCheckOutDate = formatDate(date, 'DD-MMM-YY');
                
                // Generate guest number and other identifiers
                const guestNumber = Math.floor(100000 + Math.random() * 900000);
                const roomNumber = Math.floor(100 + Math.random() * 900);
                const folioID = String.fromCharCode(65 + Math.floor(Math.random() * 26)); // Random letter A-Z
                
                // Calculate room rate and taxes
                const roomCharge = parseFloat((amount * 0.86).toFixed(2));
                const stateTax = parseFloat((roomCharge * 0.09).toFixed(2));
                const cityTax = parseFloat((roomCharge * 0.05).toFixed(2));
                const tourismFee = parseFloat(2.00);
                const javitsFee = parseFloat(1.50);
                
                // Build branded hotel name
                const hotelBrand = expense.vendor.includes('ALOFT') ? 'Aloft' : 
                                  expense.vendor.includes('MARRIOTT') ? 'Marriott' : 
                                  expense.vendor.includes('WESTIN') ? 'Westin' : 
                                  expense.vendor.includes('SHERATON') ? 'Sheraton' : 'Marriott';
                
                const cityName = expense.location.split(',')[0].trim();
                const hotelName = `${hotelBrand} ${cityName}`;
                
                // Generate HTML for receipt
                let receiptHTML = `
                    <div data-quality="${policy.receiptQuality}" class="marriott-receipt receipt-text" style="font-family: Arial, sans-serif; max-width: 680px; margin: 0 auto; padding: 20px; color: #000;">
                        <div style="margin-bottom: 15px;">
                            <h2 style="margin: 0; font-size: 18px; color: #000;">${hotelName}</h2>
                            <p style="margin: 4px 0; font-size: 13px; color: #333;">100 Main Street</p>
                            <p style="margin: 4px 0; font-size: 13px; color: #333;">${expense.location}</p>
                            <p style="margin: 4px 0; font-size: 13px; color: #333;">United States</p>
                            ${isProQuality ? `<p style="margin: 4px 0; font-size: 13px; color: #333;">Tel: (123) 456-7890 Fax: (123) 456-7891</p>` : ''}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <table style="width: 100%; font-size: 13px; color: #000;">
                                    <tr>
                                        <td style="padding: 3px; width: 120px; color: #000;">Guest Name</td>
                                        <td style="padding: 3px; color: #000;">${policy.customerName.toUpperCase()}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Guest Number</td>
                                        <td style="padding: 3px; color: #000;">${guestNumber}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Folio ID</td>
                                        <td style="padding: 3px; color: #000;">${folioID}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Arrive Date</td>
                                        <td style="padding: 3px; color: #000;">${formattedCheckInDate}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Depart Date</td>
                                        <td style="padding: 3px; color: #000;">${formattedCheckOutDate}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">No. Of Guest</td>
                                        <td style="padding: 3px; color: #000;">1</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Room Number</td>
                                        <td style="padding: 3px; color: #000;">${roomNumber}</td>
                                    </tr>
                                    ${policy.loyaltyNumber ? `
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Marriott Bonvoy Number</td>
                                        <td style="padding: 3px; color: #000;">${policy.loyaltyNumber}</td>
                                    </tr>
                                    ` : ''}
                                </table>
                            </div>
                            
                            ${isProQuality ? `
                            <div style="flex: 0 0 100px; text-align: right;">
                                <div style="background-color: #000; color: #fff; display: inline-block; padding: 3px 10px; margin-bottom: 10px; font-weight: bold;">
                                    Page 1
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; color: #000;">
                            <thead>
                                <tr style="border-bottom: 1px solid #ccc; color: #000;">
                                    <th style="padding: 8px; text-align: left; color: #000;">Date</th>
                                    <th style="padding: 8px; text-align: left; color: #000;">Reference</th>
                                    <th style="padding: 8px; text-align: left; color: #000;">Description</th>
                                    <th style="padding: 8px; text-align: right; color: #000;">Charges (USD)</th>
                                    <th style="padding: 8px; text-align: right; color: #000;">Credits (USD)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formattedCheckInDate}</td>
                                    <td style="padding: 8px; color: #000;">RT${roomNumber}</td>
                                    <td style="padding: 8px; color: #000;">Room Chrg - Standard Retail</td>
                                    <td style="padding: 8px; text-align: right; color: #000;">${roomCharge.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formattedCheckInDate}</td>
                                    <td style="padding: 8px; color: #000;">RT${roomNumber}</td>
                                    <td style="padding: 8px; color: #000;">State Tax</td>
                                    <td style="padding: 8px; text-align: right; color: #000;">${stateTax.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formattedCheckInDate}</td>
                                    <td style="padding: 8px; color: #000;">RT${roomNumber}</td>
                                    <td style="padding: 8px; color: #000;">City/Local Tax</td>
                                    <td style="padding: 8px; text-align: right; color: #000;">${cityTax.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formattedCheckInDate}</td>
                                    <td style="padding: 8px; color: #000;">RT${roomNumber}</td>
                                    <td style="padding: 8px; color: #000;">Occupancy/Tourism</td>
                                    <td style="padding: 8px; text-align: right; color: #000;">${tourismFee.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formattedCheckInDate}</td>
                                    <td style="padding: 8px; color: #000;">RT${roomNumber}</td>
                                    <td style="padding: 8px; color: #000;">Javits Center Tax</td>
                                    <td style="padding: 8px; text-align: right; color: #000;">${javitsFee.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formattedCheckOutDate}</td>
                                    <td style="padding: 8px; color: #000;">VI</td>
                                    <td style="padding: 8px; color: #000;">${policy.paymentMethod.includes('VISA') ? 'Visa' : policy.paymentMethod.includes('AMEX') ? 'American Express' : policy.paymentMethod.includes('MC') ? 'MasterCard' : policy.paymentMethod.includes('DISC') ? 'Discover' : 'Credit Card'}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                    <td style="padding: 8px; text-align: right; color: #000;">-${amount.toFixed(2)}</td>
                                </tr>
                                <tr style="border-top: 1px solid #ccc;">
                                    <td colspan="3" style="padding: 8px; text-align: right; font-weight: bold; color: #000;">** Total</td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold; color: #000;">${amount.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold; color: #000;">-${amount.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 8px; text-align: right; font-weight: bold; color: #000;">*** Balance</td>
                                    <td colspan="2" style="padding: 8px; text-align: right; font-weight: bold; color: #000;">0.00</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; text-align: left; color: #666; font-size: 11px;">
                            <p style="margin: 0;">I agreed to pay all room & incidental charges.</p>
                        </div>
                        
                        ${isProQuality ? `
                        <div style="margin-top: 50px; border-top: 1px solid #ccc; padding-top: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #000;">EXPENSE SUMMARY REPORT</h3>
                            <p style="margin: 0 0 10px 0; font-size: 12px; color: #000;">Currency: USD</p>
                            
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px; color: #000;">
                                <thead>
                                    <tr style="border-bottom: 1px solid #ccc; color: #000;">
                                        <th style="padding: 5px; text-align: left; color: #000;">Date</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Room & Tax</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Food & Bev</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Telecomm</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Parking</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Misc</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Other</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Total</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Payment</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 5px; color: #000;">${formatDate(checkInDate, 'MM-DD-YYYY')}</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">${amount.toFixed(2)}</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">${amount.toFixed(2)}</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                    </tr>
                                    <tr style="border-top: 1px solid #ccc;">
                                        <td style="padding: 5px; color: #000;">Total</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">${amount.toFixed(2)}</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">${amount.toFixed(2)}</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 30px; text-align: center; color: #666; font-size: 11px;">
                            <p style="margin: 5px 0;">Tell us about your stay. www.${hotelBrand.toLowerCase()}hotels.com/reviews</p>
                        </div>
                    </div>
                `;
                
                return receiptHTML;
            }
            
            // Generate Car Rental Receipt (Avis/Hertz style)
            function generateCarRentalReceipt(expense, policy, isProQuality) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                let date;
                if (typeof expense.date === 'string') {
                    if (expense.date.includes('/')) {
                        const parts = expense.date.split('/');
                        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                    } else {
                        date = new Date(expense.date);
                    }
                } else {
                    date = expense.date || new Date();
                }
                
                const days = expense.days || 1;
                
                // Calculate pickup date (return date - days)
                const pickupDate = new Date(date);
                pickupDate.setDate(pickupDate.getDate() - days);
                
                // Format dates properly
                const formattedPickupDate = formatDate(pickupDate);
                const formattedReturnDate = formatDate(date);
                
                // Random time generation
                const pickupHours = Math.floor(Math.random() * 12) + 1;
                const pickupMinutes = Math.floor(Math.random() * 60);
                const pickupAMPM = Math.random() > 0.5 ? 'AM' : 'PM';
                const pickupTime = `${pickupHours}:${pickupMinutes.toString().padStart(2, '0')}${pickupAMPM}`;
                
                const returnHours = Math.floor(Math.random() * 12) + 1;
                const returnMinutes = Math.floor(Math.random() * 60);
                const returnAMPM = Math.random() > 0.5 ? 'AM' : 'PM';
                const returnTime = `${returnHours}:${returnMinutes.toString().padStart(2, '0')}${returnAMPM}`;
                
                // Create agreement number and other identifiers
                const agreementNumber = Math.floor(100000000 + Math.random() * 900000000);
                const wizardNumber = Math.floor(1000 + Math.random() * 9000);
                const vehicleNumber = Math.floor(50000000 + Math.random() * 10000000);
                
                // Calculate charges
                const baseRate = parseFloat((amount * 0.70).toFixed(2));
                const dailyRate = parseFloat((baseRate / days).toFixed(2));
                const concessionFee = parseFloat((amount * 0.11).toFixed(2));
                const facilityCharge = parseFloat((6.00 * days).toFixed(2));
                const licenseFee = parseFloat((1.40 * days).toFixed(2));
                const countySurcharge = parseFloat((amount * 0.02).toFixed(2));
                const energyFee = parseFloat((0.79 * days).toFixed(2));
                const tax = parseFloat((amount * 0.06).toFixed(2));
                
                // Random vehicle details
                const vehicles = [
                    { make: 'JEEP', model: 'GCL4 4WD', plate: 'ILFP256758', color: 'WHI' },
                    { make: 'CHEV', model: 'MALIBU', plate: 'IL9873492', color: 'BLK' },
                    { make: 'FORD', model: 'EXPRER', plate: 'ILRT45623', color: 'SIL' },
                    { make: 'TOYT', model: 'CAMRY', plate: 'MI874521', color: 'BLU' }
                ];
                const vehicle = expense.vehicle && expense.licensePlate ? 
                    { make: expense.vehicle.split(' ')[0], model: expense.vehicle.split(' ').slice(1).join(' '), plate: expense.licensePlate, color: 'WHI' } : 
                    vehicles[Math.floor(Math.random() * vehicles.length)];
                
                // Generate odometer readings
                const odometerOut = Math.floor(10000 + Math.random() * 40000);
                const milesDriven = Math.floor(50 + Math.random() * 500);
                const odometerIn = odometerOut + milesDriven;
                
                // Fuel levels
                const fuelOut = parseFloat((Math.random() * 5 + 20).toFixed(1)); // 20-25 gallons
                const fuelConsumed = parseFloat((Math.random() * 8 + 2).toFixed(1)); // 2-10 gallons
                const fuelIn = parseFloat((fuelOut - fuelConsumed).toFixed(1));
                
                // Pickup and return locations
                const pickupLocation = expense.pickupLocation || 'DETROIT METROPOLITAN AIRPORT';
                const returnLocation = expense.returnLocation || pickupLocation;
                
                // Generate HTML for receipt
                let receiptHTML = `
                    <div data-quality="${policy.receiptQuality}" class="avis-receipt receipt-text" style="font-family: 'Helvetica', sans-serif; max-width: 680px; margin: 0 auto; padding: 20px; color: #000;">
                        <div style="border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px;">
                            <div style="text-align: center;">
                                <h2 style="margin: 0; font-size: 18px; font-weight: bold; color: #000;">RENTAL AGREEMENT NUMBER: ${agreementNumber} RECEIPT</h2>
                                ${isProQuality ? `<p style="margin: 10px 0 0 0; font-size: 13px; color: #333;">We are proud to feature a 100% smoke-free fleet!</p>` : ''}
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #000;">Your Information</h3>
                                <table style="width: 100%; font-size: 13px; color: #000;">
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; width: 150px; color: #000;">Customer Name:</td>
                                        <td style="padding: 2px 0; color: #000;">${policy.customerName.toUpperCase()}</td>
                                    </tr>
                                    ${isProQuality ? `
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Wizard Number:</td>
                                        <td style="padding: 2px 0; color: #000;">***${wizardNumber}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Discount:</td>
                                        <td style="padding: 2px 0; color: #000;">UP TO 5K OFFER</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Customer Status:</td>
                                        <td style="padding: 2px 0; color: #000;">PREFERRED</td>
                                    </tr>
                                    ` : ''}
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Method of Payment:</td>
                                        <td style="padding: 2px 0; color: #000;">${policy.paymentMethod}</td>
                                    </tr>
                                    ${isProQuality && policy.loyaltyNumber ? `
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Frequent Traveler Number:</td>
                                        <td style="padding: 2px 0; color: #000;">${policy.loyaltyNumber}</td>
                                    </tr>
                                    ` : ''}
                                </table>
                            </div>
                            
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #000;">Your Vehicle Information</h3>
                                <table style="width: 100%; font-size: 13px; color: #000;">
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; width: 150px; color: #000;">Vehicle Number:</td>
                                        <td style="padding: 2px 0; color: #000;">${vehicleNumber}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Vehicle Group Rented:</td>
                                        <td style="padding: 2px 0; color: #000;">Standard SUV-7 Pass</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Vehicle Group Charged:</td>
                                        <td style="padding: 2px 0; color: #000;">Luxury</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Vehicle Description:</td>
                                        <td style="padding: 2px 0; color: #000;">${vehicle.color} ${vehicle.make} ${vehicle.model}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">License Plate Number:</td>
                                        <td style="padding: 2px 0; color: #000;">${vehicle.plate}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Odometer Out/In:</td>
                                        <td style="padding: 2px 0; color: #000;">${odometerOut} / ${odometerIn}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Total Driven:</td>
                                        <td style="padding: 2px 0; color: #000;">${milesDriven}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Fuel Reading:</td>
                                        <td style="padding: 2px 0; color: #000;">Out ${fuelOut} Gal | In ${fuelIn} Gal</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #000;">Your Rental</h3>
                            <table style="width: 100%; font-size: 13px; color: #000;">
                                <tr>
                                    <td style="padding: 2px 0; vertical-align: top; width: 150px; color: #000;">Pickup Date/Time:</td>
                                    <td style="padding: 2px 0; color: #000;">${formattedPickupDate}@${pickupTime}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; vertical-align: top; color: #000;">Pickup Location:</td>
                                    <td style="padding: 2px 0; color: #000;">${pickupLocation}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; vertical-align: top; color: #000;">Return Date/Time:</td>
                                    <td style="padding: 2px 0; color: #000;">${formattedReturnDate}@${returnTime}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; vertical-align: top; color: #000;">Return Location:</td>
                                    <td style="padding: 2px 0; color: #000;">${returnLocation}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #000;">Your Vehicle Charges (MIN 1 DAY / MAX ${days * 24} HRS)</h3>
                            
                            <table style="width: 100%; font-size: 13px; color: #000; margin-bottom: 10px;">
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Rate Chart:</td>
                                    <td style="padding: 2px 0; color: #000;">Free Miles:</td>
                                    <td style="padding: 2px 0; color: #000;">Time and Mileage:</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Miles: UNLIMITED</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Hourly: 20.01</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Daily: ${dailyRate.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Ad'l day: 89.99</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Weekly: 419.93</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Monthly: 1799.70</td>
                                </tr>
                            </table>
                            
                            <table style="width: 100%; font-size: 13px; color: #000;">
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Your Discount:</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">${days} Ad'l Day @ ${dailyRate.toFixed(2)} = ${baseRate.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Less 10.00% Discount = (-)${(baseRate * 0.1).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Time and Mileage: ${baseRate.toFixed(2)}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #000;">Your Taxable Fees</h3>
                            <table style="width: 100%; font-size: 13px; color: #000;">
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">11.11% Concession Recovery Fee</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${concessionFee.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Fuel Service = (${fuelOut} Gal Out - ${fuelIn} Gal In) 3.401/GAL</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${(fuelConsumed * 3.401).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">FTP SR$ 1.00DY</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${days.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">CUST FACILITY CHARGE 6.00/DY</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${facilityCharge.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">2.00 2.00 COUNTY SURCHARGE</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${countySurcharge.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">VEH LICENSE RECOUP 1.40/DY</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${licenseFee.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">ENERGY RECOVERY FEE 0.79/DY</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${energyFee.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                    <td style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Sub-total-Charges:</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${(amount - tax).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">TAX 6.000%</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${tax.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                    <td style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Your Total Charges:</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">USD ${amount.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Prepayment</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">0.00</td>
                                </tr>
                                ${isProQuality ? `
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Estimated Travel Partner Points Earned*:</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${Math.floor(amount * 20)}</td>
                                </tr>
                                ` : ''}
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Net Charges:</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">USD ${amount.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; font-weight: bold; color: #000;">Your Total Due:</td>
                                    <td style="padding: 2px 0; text-align: right; font-weight: bold; color: #000;">0.00</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-top: 30px; text-align: center; color: #666; font-size: 11px;">
                            <p style="margin: 0;">Thank you for renting with Avis.</p>
                            <p style="margin: 5px 0;">For all other inquiries, please contact us at 1-800-352-7900 or www.Avis.com.</p>
                            ${isProQuality ? `
                            <p style="margin: 10px 0;">*Subject to audit process, the points will be awarded according to the Terms and Conditions in place.</p>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                return receiptHTML;
            }
            
            // Generate Generic receipt
            function generateGenericReceipt(expense, policy, isProQuality) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                let date;
                if (typeof expense.date === 'string') {
                    if (expense.date.includes('/')) {
                        const parts = expense.date.split('/');
                        date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                    } else {
                        date = new Date(expense.date);
                    }
                } else {
                    date = expense.date || new Date();
                }
                
                // Format date properly
                const formattedDate = formatDate(date);
                
                // Generate random time
                const hours = Math.floor(Math.random() * 12) + 1;
                const minutes = Math.floor(Math.random() * 60);
                const ampm = Math.random() > 0.5 ? 'AM' : 'PM';
                const formattedTime = `${hours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
                
                // Calculate receipt components based on tax rate
                const taxRate = policy.taxRate;
                const subtotal = parseFloat((amount / (1 + taxRate / 100)).toFixed(2));
                const tax = parseFloat((amount - subtotal).toFixed(2));
                
                // Generate random receipt details
                const receiptNumber = generateRandomReceiptNumber();
                
                // Generate receipt items
                let receiptItems = [];
                
                // Generate menu items based on receipt quality
                if (isProQuality) {
                    // More detailed for premium receipts
                    const numItems = Math.floor(Math.random() * 3) + 2; // 2-4 items
                    let remainingSubtotal = subtotal;
                    
                    for (let i = 0; i < numItems; i++) {
                        let itemPrice;
                        
                        if (i === numItems - 1) {
                            // Last item gets remainder
                            itemPrice = parseFloat(remainingSubtotal.toFixed(2));
                        } else {
                            // Random portion of remaining subtotal
                            const portion = 0.3 + Math.random() * 0.4; // 30-70% of remaining
                            itemPrice = parseFloat((remainingSubtotal * portion).toFixed(2));
                            remainingSubtotal -= itemPrice;
                        }
                        
                        receiptItems.push({
                            name: `Item ${i+1}`,
                            quantity: i === 1 ? 2 : 1, // Make one item have quantity 2
                            price: itemPrice
                        });
                    }
                } else {
                    // Simpler for basic receipts
                    receiptItems.push({
                        name: "Item 1",
                        quantity: 1,
                        price: parseFloat((subtotal * 0.7).toFixed(2))
                    });
                    
                    receiptItems.push({
                        name: "Item 2",
                        quantity: 1,
                        price: parseFloat((subtotal * 0.3).toFixed(2))
                    });
                }
                
                // Generate HTML for receipt items
                const itemsHTML = receiptItems.map(item => `
                    <tr>
                        <td style="text-align: left; padding: 4px 5px; color: #000;">${item.quantity}x</td>
                        <td style="text-align: left; padding: 4px 5px; color: #000;">${item.name}</td>
                        <td style="text-align: right; padding: 4px 5px; color: #000;">$${(item.price * item.quantity).toFixed(2)}</td>
                    </tr>
                `).join('');
                
                // Generate HTML for generic receipt
                let receiptHTML = `
                    <div data-quality="${policy.receiptQuality}" class="generic-receipt receipt-text" style="font-family: Arial, sans-serif; max-width: 400px; margin: 0 auto; padding: 20px; color: #000;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; font-size: 24px; color: #333;">${expense.vendor}</h2>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">${expense.location}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">Receipt</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Date:</strong> ${formattedDate}</p>
                            <p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Time:</strong> ${formattedTime}</p>
                            <p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Receipt #:</strong> ${receiptNumber}</p>
                            ${policy.customerName !== 'Guest' ? `<p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Customer:</strong> ${policy.customerName}</p>` : ''}
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; color: #000;">
                            <thead>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <th style="padding: 8px 5px; text-align: left; color: #000;">Qty</th>
                                    <th style="padding: 8px 5px; text-align: left; color: #000;">Item</th>
                                    <th style="padding: 8px 5px; text-align: right; color: #000;">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                        </table>
                        
                        <div style="border-top: 1px solid #eee; padding-top: 10px;">
                            <table style="width: 100%; font-size: 14px; color: #000;">
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Subtotal</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${subtotal.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Tax (${taxRate}%)</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${tax.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; font-weight: bold; color: #000;"><strong>Total</strong></td>
                                    <td style="text-align: right; padding: 4px 0; font-weight: bold; color: #000;"><strong>$${amount.toFixed(2)}</strong></td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Payment Method</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">${policy.paymentMethod}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-top: 30px; text-align: center; color: #999; font-size: 12px;">
                            <p style="margin: 0 0 5px 0; color: #666;">Thank you for your business!</p>
                            ${isProQuality ? `<p style="margin: 0; color: #666;">Please come again soon!</p>` : ''}
                        </div>
                    </div>
                `;
                
                return receiptHTML;
            }

            // Helper functions for generating realistic receipt details
            function generateRandomReceiptNumber() {
                return `INV-${Math.floor(10000 + Math.random() * 90000)}`;
            }

            function generateRandomFoodItem(mealType, isSide = false) {
                const breakfastItems = [
                    'Eggs Benedict', 'Avocado Toast', 'Pancakes', 'Belgian Waffle', 
                    'Breakfast Burrito', 'Omelette', 'French Toast'
                ];
                
                const breakfastSides = [
                    'Hash Browns', 'Fresh Fruit', 'Bacon', 'Sausage Links', 
                    'Toast', 'Small Orange Juice', 'Coffee'
                ];
                
                const lunchItems = [
                    'Chicken Caesar Salad', 'Turkey Club Sandwich', 'Veggie Burger', 
                    'Grilled Chicken Wrap', 'Cobb Salad', 'Tuna Melt', 'Quinoa Bowl'
                ];
                
                const lunchSides = [
                    'French Fries', 'Side Salad', 'Cup of Soup', 'Potato Chips', 
                    'Coleslaw', 'Onion Rings', 'Iced Tea'
                ];
                
                const dinnerItems = [
                    'Grilled Salmon', 'Filet Mignon', 'Chicken Parmesan', 'Vegetable Curry', 
                    'Pasta Primavera', 'Ribeye Steak', 'Shrimp Scampi', 'Lobster Ravioli'
                ];
                
                const dinnerSides = [
                    'Garlic Mashed Potatoes', 'Roasted Vegetables', 'Caesar Salad', 
                    'Rice Pilaf', 'Asparagus', 'Truffle Mac & Cheese', 'Sparkling Water'
                ];
                
                if (mealType === 'Breakfast') {
                    return isSide ? 
                        breakfastSides[Math.floor(Math.random() * breakfastSides.length)] : 
                        breakfastItems[Math.floor(Math.random() * breakfastItems.length)];
                } else if (mealType === 'Lunch') {
                    return isSide ? 
                        lunchSides[Math.floor(Math.random() * lunchSides.length)] : 
                        lunchItems[Math.floor(Math.random() * lunchItems.length)];
                } else {
                    return isSide ? 
                        dinnerSides[Math.floor(Math.random() * dinnerSides.length)] : 
                        dinnerItems[Math.floor(Math.random() * dinnerItems.length)];
                }
            }

            function generateRandomAlcoholItem() {
                const alcoholItems = [
                    'Glass of Cabernet', 'House White Wine', 'Craft Beer', 'Imported Beer',
                    'Vodka Martini', 'Gin & Tonic', 'Whiskey Neat', 'Margarita'
                ];
                
                return alcoholItems[Math.floor(Math.random() * alcoholItems.length)];
            }
        });
    </script>
</body>
</html>
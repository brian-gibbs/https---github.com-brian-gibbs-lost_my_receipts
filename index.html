<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Receipt Recreator | Lost Receipts Instantly Generated</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/marked@4.0.2/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4F4FBD',
                        dark: '#1a1b23',
                        darker: '#13141a',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #1a1b23;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .price-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .price-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .receipt-preview {
            position: relative;
        }
        .receipt-preview.basic::after {
            content: "PREVIEW";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 4rem;
            font-weight: bold;
            color: rgba(255, 0, 0, 0.2);
            pointer-events: none;
        }
        .step-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 24px;
        }
        .btn-primary {
            background-color: #5D5CDE;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: #4F4FBD;
        }
        .gradient-bg {
            background: linear-gradient(to bottom, rgba(26,27,35,0.9) 0%, rgba(26,27,35,1) 100%);
        }
        .receipt-text {
            color: #000 !important;
            font-weight: normal !important;
        }
        
        .download-receipt img, .download-receipt canvas {
            color: #000 !important;
        }
        
        /* Premium receipt styles */
        .uber-receipt {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .hilton-receipt {
            font-family: 'Georgia', serif;
        }
        
        .marriott-receipt {
            font-family: 'Arial', sans-serif;
        }
        
        .avis-receipt {
            font-family: 'Helvetica', sans-serif;
        }
    </style>
</head>
<body>
    <!-- Header/Nav -->
    <header class="border-b border-gray-800 bg-dark sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="#" class="text-primary font-bold text-2xl">Receipt Recreator</a>
            <div class="flex items-center space-x-4">
                <span id="creditDisplay" class="text-sm">Credits: <span id="creditCount">0</span></span>
                <button id="buyCreditsButton" class="bg-primary hover:bg-secondary text-white px-4 py-2 rounded-md text-sm">Buy Credits</button>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="py-16 gradient-bg">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Lost a Receipt? Recreate It Instantly.</h1>
            <p class="text-xl md:text-2xl mb-8 max-w-3xl mx-auto text-gray-300">Perfect for expense reports (Concur, etc.), tax deductions (IRS), or personal records. Fast, simple, and accurate.</p>
            <a href="#generator" class="btn-primary font-bold py-3 px-8 rounded-md text-lg inline-block transition">Get Started Now</a>
            <p class="mt-4 text-sm text-gray-400">Your first receipt is free!</p>
        </div>
    </section>

    <!-- How It Works Section -->
    <section class="py-16 bg-gray-900">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">Simple Receipt Generation</h2>
            
            <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                <div class="text-center">
                    <div class="step-icon bg-primary rounded-full">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">1. Input Data</h3>
                    <p class="text-gray-400">Paste details from Concur/notes OR use our manual entry form.</p>
                </div>
                
                <div class="text-center">
                    <div class="step-icon bg-primary rounded-full">
                        <i class="fas fa-cog"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">2. Set Defaults</h3>
                    <p class="text-gray-400">Configure optional allowances and a default tax rate.</p>
                </div>
                
                <div class="text-center">
                    <div class="step-icon bg-primary rounded-full">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">3. Generate</h3>
                    <p class="text-gray-400">Create realistic receipts and download as PNG or PDF.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Generator Tool Section -->
    <section id="generator" class="py-12 bg-dark">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8">Receipt Generator Tool</h2>
            <p id="creditInfo" class="text-center mb-6">You have <span id="availableCredits">0</span> credit(s) remaining. 1 credit is used per basic receipt, 2 credits for premium receipts.</p>
            
            <div class="grid md:grid-cols-5 gap-6 max-w-6xl mx-auto">
                <!-- Left Panel (20%) -->
                <div class="md:col-span-1 bg-gray-800 rounded-lg shadow-md p-4">
                    <h3 class="font-semibold text-lg border-b border-gray-700 pb-2 mb-4">Optional Defaults & Settings</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Default Name</label>
                            <input type="text" id="customerName" placeholder="Your name" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Default Tax Location</label>
                            <select id="stateSelect" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm mb-2">
                                <option value="">Select State</option>
                                <option value="CA">California</option>
                                <option value="TX">Texas</option>
                                <option value="NY">New York</option>
                                <option value="FL">Florida</option>
                                <option value="IL">Illinois</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="OH">Ohio</option>
                                <option value="GA">Georgia</option>
                                <option value="NC">North Carolina</option>
                                <option value="MI">Michigan</option>
                                <option value="MO">Missouri</option>
                                <option value="KS">Kansas</option>
                            </select>
                            
                            <select id="citySelect" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm">
                                <option value="">Select City</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Tax Rate (%)</label>
                            <input type="number" id="taxRate" value="8.25" min="0" max="20" step="0.01" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Payment Method</label>
                            <select id="paymentCardType" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm mb-2">
                                <option value="AMEX">American Express</option>
                                <option value="VISA">Visa</option>
                                <option value="MC">MasterCard</option>
                                <option value="DISC">Discover</option>
                                <option value="Apple Pay">Apple Pay</option>
                                <option value="Corporate Card">Corporate Card</option>
                                <option value="Cash">Cash</option>
                            </select>
                            <div class="flex items-center">
                                <input type="text" id="paymentLastFour" placeholder="Last 4 digits" maxlength="4" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm" 
                                       pattern="[0-9]{4}" title="Please enter 4 digits only">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Loyalty Number (Optional)</label>
                            <input type="text" id="loyaltyNumber" placeholder="Rewards/Loyalty #" class="w-full rounded-md border-gray-600 bg-gray-700 text-sm">
                        </div>
                        
                        <div class="space-y-2 pt-2 border-t border-gray-700">
                            <details>
                                <summary class="text-sm font-medium cursor-pointer">Trip & Vehicle Details (For Rentals)</summary>
                                <div class="pt-2 space-y-2">
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs">Pickup Location</label>
                                            <input type="text" id="pickupLocation" class="w-full text-xs rounded-md border-gray-600 bg-gray-700">
                                        </div>
                                        <div>
                                            <label class="block text-xs">Return Location</label>
                                            <input type="text" id="returnLocation" class="w-full text-xs rounded-md border-gray-600 bg-gray-700">
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="block text-xs">Vehicle</label>
                                            <input type="text" id="vehicleModel" placeholder="e.g. JEEP GCL4 4WD" class="w-full text-xs rounded-md border-gray-600 bg-gray-700">
                                        </div>
                                        <div>
                                            <label class="block text-xs">License Plate</label>
                                            <input type="text" id="licensePlate" class="w-full text-xs rounded-md border-gray-600 bg-gray-700">
                                        </div>
                                    </div>
                                </div>
                            </details>
                            
                            <details class="pt-1">
                                <summary class="text-sm font-medium cursor-pointer">Receipt Quality</summary>
                                <div class="pt-2 space-y-2">
                                    <div class="flex items-center">
                                        <input type="radio" name="receiptQuality" id="basicQuality" value="basic" checked class="h-4 w-4 text-primary">
                                        <label for="basicQuality" class="ml-2 text-xs">Basic (1 credit)</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="radio" name="receiptQuality" id="proQuality" value="pro" class="h-4 w-4 text-primary">
                                        <label for="proQuality" class="ml-2 text-xs">Premium (2 credits)</label>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">Premium quality offers enhanced details and branded receipt templates</p>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
                
                <!-- Right Panel (80%) -->
                <div class="md:col-span-4 bg-gray-800 rounded-lg shadow-md p-4">
                    <div>
                        <ul class="flex border-b border-gray-700">
                            <li class="mr-1">
                                <a href="#" id="pasteTabLink" class="inline-block px-4 py-2 border-l border-t border-r rounded-t font-medium text-primary bg-gray-800">Paste Data</a>
                            </li>
                            <li class="mr-1">
                                <a href="#" id="manualTabLink" class="inline-block px-4 py-2 border-l border-t border-r rounded-t text-gray-400 hover:text-primary">Manual Entry</a>
                            </li>
                        </ul>
                        
                        <!-- Paste Tab Content -->
                        <div id="pasteTabContent" class="mt-4">
                            <div class="mb-4">
                                <label for="expenseInput" class="block mb-1 font-medium">Paste Concur Expense Data</label>
                                <textarea id="expenseInput" rows="8" placeholder="Paste your Concur expense data here..." class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary"></textarea>
                            </div>
                            
                            <div class="mb-4">
                                <button id="parseButton" class="bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded">
                                    Parse Expenses
                                </button>
                            </div>
                        </div>
                        
                        <!-- Manual Entry Tab Content -->
                        <div id="manualTabContent" class="mt-4 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="manualVendor" class="block mb-1 font-medium">Vendor/Merchant</label>
                                    <input type="text" id="manualVendor" placeholder="e.g., Uber, Hilton, Avis" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label for="manualLocation" class="block mb-1 font-medium">Location</label>
                                    <input type="text" id="manualLocation" placeholder="e.g., Kansas City, Missouri" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label for="manualDate" class="block mb-1 font-medium">Date</label>
                                    <input type="date" id="manualDate" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                                
                                <div>
                                    <label for="manualAmount" class="block mb-1 font-medium">Amount</label>
                                    <div class="relative">
                                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                            <span class="text-gray-400">$</span>
                                        </div>
                                        <input type="number" id="manualAmount" placeholder="0.00" step="0.01" min="0" class="w-full pl-7 px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                    </div>
                                </div>
                                
                                <div>
                                    <label for="manualType" class="block mb-1 font-medium">Expense Type</label>
                                    <select id="manualType" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                        <option value="Individual- Dinner">Dinner</option>
                                        <option value="Individual- Lunch">Lunch</option>
                                        <option value="Individual- Breakfast">Breakfast</option>
                                        <option value="Taxi / Car Service">Uber/Lyft/Taxi</option>
                                        <option value="Accommodation">Hotel</option>
                                        <option value="Car Rental">Car Rental</option>
                                        <option value="Airfare">Airfare</option>
                                        <option value="Undefined">Other</option>
                                    </select>
                                </div>
                                
                                <div id="hotelNightsContainer">
                                    <label for="hotelNights" class="block mb-1 font-medium">Number of Nights</label>
                                    <input type="number" id="hotelNights" value="1" min="1" class="w-full px-3 py-2 border border-gray-600 bg-gray-700 rounded-md focus:outline-none focus:ring-primary focus:border-primary">
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <button id="addManualExpenseButton" class="bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded">
                                    Add Expense
                                </button>
                            </div>
                        </div>
                        
                        <!-- Parsed Expenses Table -->
                        <div id="parsedExpenses" class="hidden mt-6">
                            <h3 class="font-semibold text-lg mb-2">Expense List</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-700">
                                    <thead class="bg-gray-700">
                                        <tr>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                                <div class="flex items-center">
                                                    <input type="checkbox" id="selectAll" class="h-4 w-4 text-primary border-gray-600 rounded mr-2">
                                                    <span>Select</span>
                                                </div>
                                            </th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Type</th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Vendor</th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Location</th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Date</th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Amount</th>
                                            <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expenseTableBody" class="bg-gray-800 divide-y divide-gray-700">
                                        <!-- Parsed expenses will go here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-4 flex flex-wrap gap-2">
                                <button id="generateReceiptButton" class="bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded">
                                    Generate Receipt(s)
                                </button>
                                <button id="generateAllReceiptsButton" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded">
                                    Generate All as ZIP
                                </button>
                                <button id="clearExpensesButton" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded">
                                    Clear All
                                </button>
                            </div>
                            
                            <!-- Batch Processing Status -->
                            <div id="batchProcessingStatus" class="hidden mt-4 p-4 bg-gray-700 rounded-lg">
                                <h3 class="font-semibold text-lg mb-2">Batch Processing</h3>
                                <div class="mb-3">
                                    <div class="w-full bg-gray-600 rounded-full h-4">
                                        <div id="batchProgress" class="bg-primary h-4 rounded-full" style="width: 0%"></div>
                                    </div>
                                    <p id="batchStatusText" class="mt-1 text-sm">Processing 0 of 0 expenses...</p>
                                </div>
                                <div id="skippedExpensesList" class="hidden">
                                    <h4 class="font-medium mb-1">Skipped Expenses:</h4>
                                    <ul id="skippedList" class="list-disc list-inside text-sm"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Pricing Section -->
    <section class="py-16 bg-gray-900">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-4">Flexible Pricing</h2>
            <p class="text-center max-w-2xl mx-auto mb-12 text-gray-400">Your first receipt is free! After that, buy credits as you need them. 1 Credit = 1 Basic Receipt, 2 Credits = 1 Premium Receipt.</p>
            
            <div class="flex flex-wrap justify-center gap-8">
                <!-- Starter Pack -->
                <div class="price-card bg-dark rounded-xl shadow-lg overflow-hidden max-w-xs w-full">
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-1">Starter Pack</h3>
                        <p class="text-gray-400 text-sm mb-4">Perfect for occasional use</p>
                        
                        <div class="mb-4">
                            <span class="text-4xl font-bold">$4.99</span>
                            <span class="text-gray-400 text-sm ml-1">5 Credits</span>
                        </div>
                        
                        <p class="text-sm text-gray-400 mb-6">($1.00 / receipt)</p>
                        
                        <button class="buy-credits-btn w-full bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded-md" data-plan="starter" data-credits="5" data-price="4.99">
                            Buy 5 Credits
                        </button>
                    </div>
                </div>
                
                <!-- Value Pack -->
                <div class="price-card bg-dark rounded-xl shadow-lg overflow-hidden max-w-xs w-full border-2 border-primary relative">
                    <div class="bg-primary text-white py-1 text-center text-sm font-semibold">
                        POPULAR
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-1">Value Pack</h3>
                        <p class="text-gray-400 text-sm mb-4">Best value for regular users</p>
                        
                        <div class="mb-4">
                            <span class="text-4xl font-bold">$9.99</span>
                            <span class="text-gray-400 text-sm ml-1">15 Credits</span>
                        </div>
                        
                        <p class="text-sm text-gray-400 mb-6">($0.67 / receipt)</p>
                        
                        <button class="buy-credits-btn w-full bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded-md" data-plan="value" data-credits="15" data-price="9.99">
                            Buy 15 Credits
                        </button>
                    </div>
                </div>
                
                <!-- Bulk Pack -->
                <div class="price-card bg-dark rounded-xl shadow-lg overflow-hidden max-w-xs w-full">
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-1">Bulk Pack</h3>
                        <p class="text-gray-400 text-sm mb-4">Ideal for frequent travelers</p>
                        
                        <div class="mb-4">
                            <span class="text-4xl font-bold">$19.99</span>
                            <span class="text-gray-400 text-sm ml-1">50 Credits</span>
                        </div>
                        
                        <p class="text-sm text-gray-400 mb-6">($0.40 / receipt)</p>
                        
                        <button class="buy-credits-btn w-full bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded-md" data-plan="bulk" data-credits="50" data-price="19.99">
                            Buy 50 Credits
                        </button>
                    </div>
                </div>
            </div>
            
            <p class="text-center mt-8 text-sm text-gray-400">All transactions are secure and no account is needed. Credits are stored locally in your browser.</p>
        </div>
    </section>

    <!-- Receipt Viewer Modal -->
    <div id="receiptModal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto relative">
            <!-- Close button -->
            <button id="closeModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <!-- Modal header -->
            <div class="mb-4">
                <h2 class="text-xl font-bold text-primary">Generated Receipt</h2>
                <p id="receiptCounter" class="text-sm text-gray-400">Receipt 1 of 1</p>
            </div>
            
            <!-- Receipt content -->
            <div id="receiptContent" class="bg-white p-4 border border-gray-200 mb-4 text-gray-800 receipt-preview receipt-text">
                <!-- Receipt will be generated here -->
            </div>
            
            <!-- Navigation buttons -->
            <div class="flex justify-between items-center mb-4">
                <button id="prevReceiptBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md">
                    Previous
                </button>
                <button id="nextReceiptBtn" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md">
                    Next
                </button>
            </div>
            
            <!-- Download buttons -->
            <div class="flex justify-end gap-2">
                <button id="downloadPdf" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded">
                    Download PDF
                </button>
                <button id="downloadPng" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded">
                    Download PNG
                </button>
            </div>
        </div>
    </div>
    
    <!-- Buy Credits Modal -->
    <div id="buyCreditsModal" class="fixed inset-0 bg-black bg-opacity-75 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-primary">Purchase Credits</h2>
                <button id="closeBuyModal" class="text-gray-400 hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <p class="mb-4">For testing purposes, we've added 999 credits to your account.</p>
            
            <div class="flex justify-end">
                <button id="confirmAddCredits" class="bg-primary hover:bg-secondary text-white font-semibold py-2 px-4 rounded">
                    Got it!
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-darker py-8">
        <div class="container mx-auto px-4">
            <div class="text-center mb-4">
                <h3 class="text-lg font-semibold mb-2">Important Disclaimer</h3>
                <p class="text-sm text-gray-400 max-w-3xl mx-auto">This tool is intended to help recreate documentation for legitimate, actual expenses where the original receipt was lost/damaged. Users are solely responsible for accuracy and compliance with company policy & tax regulations.</p>
                <p class="text-sm font-semibold text-red-400 mt-2">Fraudulent use is strictly prohibited and may have legal consequences.</p>
            </div>
            
            <div class="border-t border-gray-800 pt-4 flex flex-col md:flex-row justify-between items-center">
                <p class="text-sm text-gray-500">Â© 2024 Receipt Recreator - Use Responsibly</p>
                <div class="flex space-x-4 mt-2 md:mt-0">
                    <a href="#" class="text-sm text-gray-500 hover:text-white">Privacy Policy</a>
                    <a href="#" class="text-sm text-gray-500 hover:text-white">Terms of Service</a>
                    <a href="#" class="text-sm text-gray-500 hover:text-white">Support</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Main app logic
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize credits from localStorage or set default
            let credits = localStorage.getItem('receiptCredits') ? parseInt(localStorage.getItem('receiptCredits')) : 999;
            updateCreditDisplay();
            
            // Elements
            const tabElements = {
                pasteTabLink: document.getElementById('pasteTabLink'),
                manualTabLink: document.getElementById('manualTabLink'),
                pasteTabContent: document.getElementById('pasteTabContent'),
                manualTabContent: document.getElementById('manualTabContent')
            };
            
            const expenseInput = document.getElementById('expenseInput');
            const parseButton = document.getElementById('parseButton');
            const parsedExpenses = document.getElementById('parsedExpenses');
            const expenseTableBody = document.getElementById('expenseTableBody');
            const selectAllCheckbox = document.getElementById('selectAll');
            const generateReceiptButton = document.getElementById('generateReceiptButton');
            const generateAllReceiptsButton = document.getElementById('generateAllReceiptsButton');
            const clearExpensesButton = document.getElementById('clearExpensesButton');
            const receiptModal = document.getElementById('receiptModal');
            const closeModal = document.getElementById('closeModal');
            const receiptContent = document.getElementById('receiptContent');
            const receiptCounter = document.getElementById('receiptCounter');
            const prevReceiptBtn = document.getElementById('prevReceiptBtn');
            const nextReceiptBtn = document.getElementById('nextReceiptBtn');
            const downloadPdf = document.getElementById('downloadPdf');
            const downloadPng = document.getElementById('downloadPng');
            
            // Manual entry elements
            const manualVendor = document.getElementById('manualVendor');
            const manualLocation = document.getElementById('manualLocation');
            const manualDate = document.getElementById('manualDate');
            const manualAmount = document.getElementById('manualAmount');
            const manualType = document.getElementById('manualType');
            const hotelNights = document.getElementById('hotelNights');
            const hotelNightsContainer = document.getElementById('hotelNightsContainer');
            const addManualExpenseButton = document.getElementById('addManualExpenseButton');
            
            // Show/hide hotel nights field based on expense type
            manualType.addEventListener('change', function() {
                if (this.value === 'Accommodation' || this.value === 'Car Rental') {
                    hotelNightsContainer.classList.remove('hidden');
                    document.querySelector('label[for="hotelNights"]').textContent = 
                        this.value === 'Accommodation' ? 'Number of Nights' : 'Number of Days';
                } else {
                    hotelNightsContainer.classList.add('hidden');
                }
            });
            
            // Credit system elements
            const buyCreditsButton = document.getElementById('buyCreditsButton');
            const buyCreditsModal = document.getElementById('buyCreditsModal');
            const closeBuyModal = document.getElementById('closeBuyModal');
            const confirmAddCredits = document.getElementById('confirmAddCredits');
            const buyCreditsButtons = document.querySelectorAll('.buy-credits-btn');
            
            // Batch processing elements
            const batchProcessingStatus = document.getElementById('batchProcessingStatus');
            const batchProgress = document.getElementById('batchProgress');
            const batchStatusText = document.getElementById('batchStatusText');
            const skippedExpensesList = document.getElementById('skippedExpensesList');
            const skippedList = document.getElementById('skippedList');
            
            // Receipt quality elements
            const basicQuality = document.getElementById('basicQuality');
            const proQuality = document.getElementById('proQuality');
            
            // Sample expense data for testing
            const sampleData = `Available Expenses
Drag and drop files to upload a new receipt. Valid file types for upload are .png, .jpg, .jpeg, .pdf, .tif or .tiff.
View:
All Expenses
Skip to available receipts
Available Expenses
Multiple rows can be selected using checkboxes in the first column.
Select all rows
Receipt
Expense Source
Select row		
NAM AMEX C-CARD IBCP US HQ
Corporate Card
Individual- Dinner
UBER EATS
San Francisco, California	04/05/2025	
$35.93
Select row		
NAM AMEX C-CARD IBCP US HQ
Corporate Card
Taxi / Car Service
UBER
San Francisco, California	04/04/2025	
$21.70`;

            // Fill with sample data if empty (for testing)
            if (expenseInput.value.trim() === '') {
                expenseInput.value = sampleData;
            }
            
            // Set default date for manual entry to today
            const today = new Date();
            const formattedDate = today.toISOString().substr(0, 10);
            manualDate.value = formattedDate;
            
            // Store parsed expenses
            let expenses = [];
            
            // Store generated receipts for navigation
            let generatedReceipts = [];
            let currentReceiptIndex = 0;
            
            // Select All checkbox functionality
            selectAllCheckbox.addEventListener('change', function() {
                const checkboxes = document.querySelectorAll('input[name="expenseCheck"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                });
            });
            
            // Tab switching logic
            tabElements.pasteTabLink.addEventListener('click', function(e) {
                e.preventDefault();
                setActiveTab('paste');
            });
            
            tabElements.manualTabLink.addEventListener('click', function(e) {
                e.preventDefault();
                setActiveTab('manual');
            });
            
            function setActiveTab(tabName) {
                // Reset all tabs
                tabElements.pasteTabLink.classList.remove('text-primary', 'bg-gray-800', 'font-medium');
                tabElements.pasteTabLink.classList.add('text-gray-400', 'hover:text-primary');
                
                tabElements.manualTabLink.classList.remove('text-primary', 'bg-gray-800', 'font-medium');
                tabElements.manualTabLink.classList.add('text-gray-400', 'hover:text-primary');
                
                tabElements.pasteTabContent.classList.add('hidden');
                tabElements.manualTabContent.classList.add('hidden');
                
                // Set active tab
                if (tabName === 'paste') {
                    tabElements.pasteTabLink.classList.remove('text-gray-400', 'hover:text-primary');
                    tabElements.pasteTabLink.classList.add('text-primary', 'bg-gray-800', 'font-medium');
                    tabElements.pasteTabContent.classList.remove('hidden');
                } else {
                    tabElements.manualTabLink.classList.remove('text-gray-400', 'hover:text-primary');
                    tabElements.manualTabLink.classList.add('text-primary', 'bg-gray-800', 'font-medium');
                    tabElements.manualTabContent.classList.remove('hidden');
                }
            }
            
            // State and city tax rate data
            const taxRates = {
                'CA': {
                    'default': 7.25,
                    'San Francisco': 8.625,
                    'Los Angeles': 9.5,
                    'San Diego': 7.75,
                    'Oakland': 9.25
                },
                'TX': {
                    'default': 6.25,
                    'Houston': 8.25,
                    'Dallas': 8.25,
                    'Austin': 8.25,
                    'San Antonio': 8.25,
                    'Spring': 8.25
                },
                'NY': {
                    'default': 4.0,
                    'New York City': 8.875,
                    'Buffalo': 8.75,
                    'Syracuse': 8.0,
                    'LaGuardia Airport': 8.875,
                    'East Elmhurst': 8.875
                },
                'FL': {
                    'default': 6.0,
                    'Miami': 7.0,
                    'Orlando': 6.5,
                    'Tampa': 7.5
                },
                'IL': {
                    'default': 6.25,
                    'Chicago': 10.25,
                    'Springfield': 9.0
                },
                'PA': {
                    'default': 6.0,
                    'Philadelphia': 8.0,
                    'Pittsburgh': 7.0,
                    'Norristown': 6.0,
                    'Conshohocken': 6.0,
                    'Plymouth Meeting': 6.0
                },
                'OH': {
                    'default': 5.75,
                    'Cleveland': 8.0,
                    'Columbus': 7.5,
                    'Cincinnati': 7.8
                },
                'GA': {
                    'default': 4.0,
                    'Atlanta': 8.9,
                    'Savannah': 7.0
                },
                'NC': {
                    'default': 4.75,
                    'Charlotte': 7.25,
                    'Raleigh': 7.25
                },
                'MI': {
                    'default': 6.0,
                    'Detroit': 6.0,
                    'Grand Rapids': 6.0
                },
                'MO': {
                    'default': 4.225,
                    'Kansas City': 10.6,
                    'St. Louis': 8.679
                },
                'KS': {
                    'default': 6.5,
                    'Kansas City': 9.5,
                    'Topeka': 9.15
                }
            };
            
            // State and city selection handling
            const stateSelect = document.getElementById('stateSelect');
            const citySelect = document.getElementById('citySelect');
            const taxRateInput = document.getElementById('taxRate');
            
            stateSelect.addEventListener('change', function() {
                const selectedState = this.value;
                citySelect.innerHTML = '<option value="">Select City</option>';
                
                if (selectedState && taxRates[selectedState]) {
                    // Set default tax rate for state
                    taxRateInput.value = taxRates[selectedState].default;
                    
                    // Add cities for the selected state
                    Object.keys(taxRates[selectedState]).forEach(city => {
                        if (city !== 'default') {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            citySelect.appendChild(option);
                        }
                    });
                }
            });
            
            citySelect.addEventListener('change', function() {
                const selectedState = stateSelect.value;
                const selectedCity = this.value;
                
                if (selectedState && selectedCity && taxRates[selectedState][selectedCity]) {
                    taxRateInput.value = taxRates[selectedState][selectedCity];
                } else if (selectedState && taxRates[selectedState]) {
                    taxRateInput.value = taxRates[selectedState].default;
                }
            });
            
            // Credit system functions
            function updateCreditDisplay() {
                document.getElementById('creditCount').textContent = credits;
                document.getElementById('availableCredits').textContent = credits;
            }
            
            function addCredits(amount) {
                credits += amount;
                localStorage.setItem('receiptCredits', credits);
                updateCreditDisplay();
            }
            
            function useCredits(amount) {
                if (credits >= amount) {
                    credits -= amount;
                    localStorage.setItem('receiptCredits', credits);
                    updateCreditDisplay();
                    return true;
                }
                return false;
            }
            
            // Buy credits button handlers
            buyCreditsButton.addEventListener('click', function() {
                buyCreditsModal.classList.remove('hidden');
            });
            
            closeBuyModal.addEventListener('click', function() {
                buyCreditsModal.classList.add('hidden');
            });
            
            confirmAddCredits.addEventListener('click', function() {
                addCredits(999); // For testing
                buyCreditsModal.classList.add('hidden');
            });
            
            buyCreditsButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const creditsToAdd = parseInt(this.dataset.credits);
                    addCredits(creditsToAdd);
                    alert(`Added ${creditsToAdd} credits to your account!`);
                });
            });
            
            // Check if location tax information is available and prompt if needed
            function checkLocationTaxInfo(expense) {
                // Reset tax information fields
                stateSelect.value = '';
                citySelect.innerHTML = '<option value="">Select City</option>';
                taxRateInput.value = '8.25'; // Default
                
                // Try to extract location info from the expense
                let hasTaxInfo = false;
                
                if (expense.location) {
                    const locationParts = expense.location.split(',');
                    if (locationParts.length >= 2) {
                        const city = locationParts[0].trim();
                        const state = locationParts[1].trim();
                        
                        // Try to match state name to our database
                        let stateAbbr = '';
                        Object.keys(taxRates).forEach(abbr => {
                            if (state.includes(abbr) || 
                                (abbr === 'CA' && state.includes('California')) ||
                                (abbr === 'TX' && state.includes('Texas')) ||
                                (abbr === 'NY' && state.includes('New York')) ||
                                (abbr === 'FL' && state.includes('Florida')) ||
                                (abbr === 'IL' && state.includes('Illinois')) ||
                                (abbr === 'PA' && state.includes('Pennsylvania')) ||
                                (abbr === 'OH' && state.includes('Ohio')) ||
                                (abbr === 'GA' && state.includes('Georgia')) ||
                                (abbr === 'NC' && state.includes('North Carolina')) ||
                                (abbr === 'MI' && state.includes('Michigan')) ||
                                (abbr === 'MO' && state.includes('Missouri')) ||
                                (abbr === 'KS' && state.includes('Kansas'))) {
                                stateAbbr = abbr;
                            }
                        });
                        
                        if (stateAbbr) {
                            // Set the state
                            stateSelect.value = stateAbbr;
                            
                            // Trigger change event to populate cities
                            const event = new Event('change');
                            stateSelect.dispatchEvent(event);
                            
                            // Try to match city
                            if (taxRates[stateAbbr]) {
                                let cityMatch = false;
                                Object.keys(taxRates[stateAbbr]).forEach(taxCity => {
                                    if (taxCity !== 'default' && city.includes(taxCity)) {
                                        citySelect.value = taxCity;
                                        
                                        // Set tax rate based on city
                                        taxRateInput.value = taxRates[stateAbbr][taxCity];
                                        cityMatch = true;
                                    }
                                });
                                
                                if (!cityMatch) {
                                    // Use state default if city not found
                                    taxRateInput.value = taxRates[stateAbbr].default;
                                }
                                
                                hasTaxInfo = true;
                            }
                        }
                    }
                }
                
                return hasTaxInfo;
            }

            // Parse expense data from Concur format
            parseButton.addEventListener('click', function() {
                const data = expenseInput.value.trim();
                if (!data) {
                    alert('Please paste expense data first.');
                    return;
                }

                try {
                    const newExpenses = parseExpenseData(data);
                    expenses = [...expenses, ...newExpenses];
                    displayParsedExpenses(expenses);
                    parsedExpenses.classList.remove('hidden');
                } catch (e) {
                    console.error('Error parsing data:', e);
                    alert('Error parsing data. Please check the format and try again.');
                }
            });
            
            // Add expense from manual entry
            addManualExpenseButton.addEventListener('click', function() {
                // Validate inputs
                if (!manualVendor.value || !manualLocation.value || !manualDate.value || !manualAmount.value) {
                    alert('Please fill out all required fields.');
                    return;
                }
                
                // Get name from input or use default
                const customerName = document.getElementById('customerName').value || '';
                
                // Get payment method info
                const paymentCardType = document.getElementById('paymentCardType').value;
                const lastFour = document.getElementById('paymentLastFour').value || '0000';
                const paymentMethod = lastFour ? `${paymentCardType}â¢â¢â¢${lastFour}` : paymentCardType;
                
                // Create expense object
                const expense = {
                    type: manualType.value,
                    vendor: manualVendor.value,
                    location: manualLocation.value,
                    date: manualDate.value,
                    amount: '$' + parseFloat(manualAmount.value).toFixed(2),
                    cardType: paymentMethod,
                    customerName: customerName,
                    loyaltyNumber: document.getElementById('loyaltyNumber').value || '',
                    // Add the nights property for hotel/car rental expenses
                    ...(manualType.value === 'Accommodation' && {nights: parseInt(hotelNights.value)}),
                    ...(manualType.value === 'Car Rental' && {days: parseInt(hotelNights.value)}),
                    // Add travel details for certain expense types
                    ...(manualType.value === 'Taxi / Car Service' && {
                        pickupLocation: document.getElementById('pickupLocation').value || '',
                        dropoffLocation: document.getElementById('returnLocation').value || '',
                    }),
                    ...(manualType.value === 'Car Rental' && {
                        pickupLocation: document.getElementById('pickupLocation').value || '',
                        returnLocation: document.getElementById('returnLocation').value || '',
                        vehicle: document.getElementById('vehicleModel').value || '',
                        licensePlate: document.getElementById('licensePlate').value || ''
                    }),
                };
                
                // Add to expenses array
                expenses.push(expense);
                
                // Display expenses
                displayParsedExpenses(expenses);
                parsedExpenses.classList.remove('hidden');
                
                // Clear form
                manualVendor.value = '';
                manualAmount.value = '';
                
                // Show success message
                alert('Expense added successfully!');
            });
            
            // Generate receipt for selected expense
            generateReceiptButton.addEventListener('click', function() {
                const selectedCheckboxes = document.querySelectorAll('input[name="expenseCheck"]:checked');
                if (selectedCheckboxes.length === 0) {
                    alert('Please select at least one expense.');
                    return;
                }
                
                // Calculate required credits
                const creditsNeeded = proQuality.checked ? selectedCheckboxes.length * 2 : selectedCheckboxes.length;
                
                // Check if enough credits
                if (!useCredits(creditsNeeded)) {
                    alert(`Not enough credits. You need ${creditsNeeded} credits to generate ${selectedCheckboxes.length} receipt(s).`);
                    return;
                }
                
                // Generate receipts for selected expenses
                generatedReceipts = [];
                
                for (const checkbox of selectedCheckboxes) {
                    const selectedIndex = parseInt(checkbox.value);
                    const selectedExpense = expenses[selectedIndex];
                    
                    // Check tax information
                    const hasTaxInfo = checkLocationTaxInfo(selectedExpense);
                    
                    // If no tax information could be determined, prompt the user
                    if (!hasTaxInfo && !confirm(`Location tax information couldn't be determined for ${selectedExpense.vendor} in "${selectedExpense.location}". Use default tax rate of 8.25%?`)) {
                        // User wants to set tax manually - already prompted
                        alert('Please set the state, city, and tax rate in the left panel before generating the receipt.');
                    }
                    
                    // Get customer name (use default if not provided)
                    const customerName = selectedExpense.customerName || document.getElementById('customerName').value || 'Guest';
                    
                    // Get payment method info if not already set
                    let paymentMethod = selectedExpense.cardType;
                    if (!paymentMethod) {
                        const paymentCardType = document.getElementById('paymentCardType').value;
                        const lastFour = document.getElementById('paymentLastFour').value || '0000';
                        paymentMethod = lastFour ? `${paymentCardType}â¢â¢â¢${lastFour}` : paymentCardType;
                    }
                    
                    // Loyalty number
                    const loyaltyNumber = selectedExpense.loyaltyNumber || document.getElementById('loyaltyNumber').value || '';
                    
                    // Get company policy values
                    const policy = {
                        customerName: customerName,
                        paymentMethod: paymentMethod,
                        loyaltyNumber: loyaltyNumber,
                        taxRate: parseFloat(document.getElementById('taxRate').value) || 8.25,
                        receiptQuality: proQuality.checked ? 'pro' : 'basic'
                    };
                    
                    // Generate receipt HTML
                    const receiptHTML = generateReceipt(selectedExpense, policy);
                    generatedReceipts.push(receiptHTML);
                }
                
                // Display the first receipt
                currentReceiptIndex = 0;
                showCurrentReceipt();
                receiptModal.classList.remove('hidden');
            });
            
            // Navigate between receipts
            prevReceiptBtn.addEventListener('click', function() {
                if (currentReceiptIndex > 0) {
                    currentReceiptIndex--;
                    showCurrentReceipt();
                }
            });
            
            nextReceiptBtn.addEventListener('click', function() {
                if (currentReceiptIndex < generatedReceipts.length - 1) {
                    currentReceiptIndex++;
                    showCurrentReceipt();
                }
            });
            
            function showCurrentReceipt() {
                receiptContent.innerHTML = generatedReceipts[currentReceiptIndex];
                receiptCounter.textContent = `Receipt ${currentReceiptIndex + 1} of ${generatedReceipts.length}`;
                
                // Update navigation buttons
                prevReceiptBtn.disabled = currentReceiptIndex === 0;
                prevReceiptBtn.classList.toggle('opacity-50', currentReceiptIndex === 0);
                
                nextReceiptBtn.disabled = currentReceiptIndex === generatedReceipts.length - 1;
                nextReceiptBtn.classList.toggle('opacity-50', currentReceiptIndex === generatedReceipts.length - 1);
                
                // Add watermark for basic quality
                if (generatedReceipts[currentReceiptIndex].includes('data-quality="basic"')) {
                    receiptContent.classList.add('basic');
                } else {
                    receiptContent.classList.remove('basic');
                }
            }
            
            // Batch process all receipts
            generateAllReceiptsButton.addEventListener('click', async function() {
                if (expenses.length === 0) {
                    alert('No expenses found to process.');
                    return;
                }
                
                // Calculate required credits
                const creditsNeeded = proQuality.checked ? expenses.length * 2 : expenses.length;
                
                // Check if enough credits
                if (!useCredits(creditsNeeded)) {
                    alert(`Not enough credits. You need ${creditsNeeded} credits to generate all ${expenses.length} receipts.`);
                    return;
                }
                
                // Show batch processing UI
                batchProcessingStatus.classList.remove('hidden');
                skippedExpensesList.classList.add('hidden');
                skippedList.innerHTML = '';
                
                // Create array for receipts
                let allReceipts = [];
                let skippedExpenses = [];
                let processedCount = 0;
                let totalSuccessCount = 0;
                
                // Get customer name
                const customerName = document.getElementById('customerName').value || 'Guest';
                
                // Get payment method info
                const paymentCardType = document.getElementById('paymentCardType').value;
                const lastFour = document.getElementById('paymentLastFour').value || '0000';
                const paymentMethod = lastFour ? `${paymentCardType}â¢â¢â¢${lastFour}` : paymentCardType;
                
                // Start batch processing
                for (let i = 0; i < expenses.length; i++) {
                    const expense = expenses[i];
                    
                    // Update progress
                    const progress = Math.round((i / expenses.length) * 100);
                    batchProgress.style.width = `${progress}%`;
                    batchStatusText.textContent = `Processing ${i + 1} of ${expenses.length} expenses...`;
                    
                    // Check tax information
                    const hasTaxInfo = checkLocationTaxInfo(expense);
                    
                    // If no tax information, skip this expense
                    if (!hasTaxInfo) {
                        skippedExpenses.push({
                            vendor: expense.vendor,
                            location: expense.location,
                            amount: expense.amount,
                            date: expense.date,
                            reason: "Missing tax information"
                        });
                        
                        // Add small delay to allow UI to update
                        await new Promise(resolve => setTimeout(resolve, 50));
                        continue;
                    }
                    
                    // Get company policy values
                    const policy = {
                        customerName: expense.customerName || customerName,
                        paymentMethod: expense.cardType || paymentMethod,
                        loyaltyNumber: expense.loyaltyNumber || document.getElementById('loyaltyNumber').value || '',
                        taxRate: parseFloat(document.getElementById('taxRate').value) || 8.25,
                        receiptQuality: proQuality.checked ? 'pro' : 'basic'
                    };
                    
                    // Generate receipt
                    const receiptHTML = generateReceipt(expense, policy);
                    allReceipts.push(receiptHTML);
                    
                    try {
                        // Create a temporary container for the receipt
                        const tempContainer = document.createElement('div');
                        tempContainer.innerHTML = receiptHTML;
                        tempContainer.classList.add('receipt-container', 'download-receipt');
                        tempContainer.style.backgroundColor = '#ffffff';
                        tempContainer.style.color = '#000000';
                        tempContainer.style.padding = '20px';
                        document.body.appendChild(tempContainer);
                        
                        // Remove watermark for download
                        tempContainer.classList.remove('receipt-preview', 'basic');
                        
                        // Apply dark text for download
                        const allElements = tempContainer.querySelectorAll('*');
                        allElements.forEach(el => {
                            el.style.color = '#000000';
                        });
                        
                        // Generate PDF
                        const canvas = await html2canvas(tempContainer, {
                            scale: 2,
                            backgroundColor: '#ffffff',
                            useCORS: true
                        });
                        
                        // Create and download pdf
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        
                        const imgData = canvas.toDataURL('image/png');
                        const imgWidth = 210 - 20;
                        const pageHeight = 297;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        
                        pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                        
                        // Save the PDF
                        const sanitizedVendor = expense.vendor.replace(/[^a-z0-9]/gi, '_').substring(0, 10);
                        const dateStr = expense.date.replace(/\//g, '-');
                        pdf.save(`receipt_${sanitizedVendor}_${dateStr}_${expense.amount.replace('$', '')}.pdf`);
                        
                        // Clean up
                        document.body.removeChild(tempContainer);
                        totalSuccessCount++;
                        
                        // Small delay to avoid overwhelming the browser
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } catch (error) {
                        console.error('Error generating receipt:', error);
                        skippedExpenses.push({
                            vendor: expense.vendor,
                            location: expense.location,
                            amount: expense.amount,
                            date: expense.date,
                            reason: 'PDF generation failed'
                        });
                    }
                    
                    processedCount++;
                }
                
                // Update final status
                batchProgress.style.width = '100%';
                batchStatusText.textContent = `Completed: Generated ${totalSuccessCount} of ${expenses.length} receipts.`;
                
                // Show skipped expenses if any
                if (skippedExpenses.length > 0) {
                    skippedExpensesList.classList.remove('hidden');
                    skippedExpenses.forEach(expense => {
                        const li = document.createElement('li');
                        li.textContent = `${expense.vendor} (${expense.date}) - ${expense.amount} - ${expense.location} - Reason: ${expense.reason}`;
                        skippedList.appendChild(li);
                    });
                }
                
                // Update generated receipts for viewing
                generatedReceipts = allReceipts;
                
                // Alert completion
                alert(`Receipt generation complete!\n${totalSuccessCount} receipts created.\n${skippedExpenses.length} receipts skipped due to issues.`);
            });
            
            // Clear all expenses
            clearExpensesButton.addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all expenses?')) {
                    expenses = [];
                    displayParsedExpenses(expenses);
                }
            });

            // Close modal
            closeModal.addEventListener('click', function() {
                receiptModal.classList.add('hidden');
            });

            // Close modal when clicking outside
            receiptModal.addEventListener('click', function(e) {
                if (e.target === receiptModal) {
                    receiptModal.classList.add('hidden');
                }
            });

            // Download as PDF
            downloadPdf.addEventListener('click', async function() {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                try {
                    // Create a clone of the receipt container without watermark
                    const tempContainer = document.createElement('div');
                    tempContainer.innerHTML = receiptContent.innerHTML;
                    tempContainer.classList.add('download-receipt');
                    tempContainer.style.backgroundColor = '#ffffff';
                    tempContainer.style.padding = '20px';
                    document.body.appendChild(tempContainer);
                    
                    // Apply dark text for download
                    const allElements = tempContainer.querySelectorAll('*');
                    allElements.forEach(el => {
                        el.style.color = '#000000';
                    });
                    
                    const canvas = await html2canvas(tempContainer, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        useCORS: true
                    });
                    
                    document.body.removeChild(tempContainer);
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210 - 20; // A4 width minus margins
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 10; // Top margin
                    
                    pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight - 20;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight + 10;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight - 20;
                    }
                    
                    const fileName = `receipt_${generateRandomReceiptNumber()}.pdf`;
                    pdf.save(fileName);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error generating PDF. Please try again.');
                }
            });

            // Download as PNG
            downloadPng.addEventListener('click', async function() {
                try {
                    // Create a clone of the receipt container without watermark
                    const tempContainer = document.createElement('div');
                    tempContainer.innerHTML = receiptContent.innerHTML;
                    tempContainer.classList.add('download-receipt');
                    tempContainer.style.backgroundColor = '#ffffff';
                    tempContainer.style.padding = '20px';
                    document.body.appendChild(tempContainer);
                    
                    // Apply dark text for download
                    const allElements = tempContainer.querySelectorAll('*');
                    allElements.forEach(el => {
                        el.style.color = '#000000';
                    });
                    
                    const canvas = await html2canvas(tempContainer, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        useCORS: true
                    });
                    
                    document.body.removeChild(tempContainer);
                    
                    const link = document.createElement('a');
                    link.download = `receipt_${generateRandomReceiptNumber()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (error) {
                    console.error('Error generating PNG:', error);
                    alert('Error generating PNG. Please try again.');
                }
            });

            // Parse expense data from Concur format
            function parseExpenseData(data) {
                const lines = data.split('\n');
                const expenses = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Look for expense type indicators
                    if (line.includes('Individual-') || 
                        line.includes('Taxi / Car Service') || 
                        line.includes('Accommodation') ||
                        line.includes('Car Rental') ||
                        line.includes('Airfare') ||
                        line.includes('Undefined')) {
                        
                        const type = line;
                        let vendor = '';
                        let location = '';
                        let date = '';
                        let amount = '';
                        
                        // Get vendor from next line
                        if (i + 1 < lines.length) {
                            vendor = lines[i + 1].trim();
                        }
                        
                        // Get location and date
                        if (i + 2 < lines.length) {
                            const locDateLine = lines[i + 2].trim();
                            const dateMatch = locDateLine.match(/(\d{2}\/\d{2}\/\d{4})/);
                            
                            if (dateMatch) {
                                date = dateMatch[0];
                                location = locDateLine.replace(date, '').trim();
                            } else {
                                location = locDateLine;
                            }
                        }
                        
                        // Get amount
                        if (i + 3 < lines.length) {
                            const amountLine = lines[i + 3].trim();
                            const amountMatch = amountLine.match(/\$([0-9,]+\.\d{2})/);
                            
                            if (amountMatch) {
                                amount = amountMatch[0];
                            } else if (amountLine.startsWith('$')) {
                                amount = amountLine;
                            }
                        }
                        
                        // Get customer name if available (from form)
                        const customerName = document.getElementById('customerName').value || '';
                        
                        // Get payment method
                        const paymentCardType = document.getElementById('paymentCardType').value;
                        const lastFour = document.getElementById('paymentLastFour').value || '0000';
                        const paymentMethod = lastFour ? `${paymentCardType}â¢â¢â¢${lastFour}` : paymentCardType;
                        
                        // Only add if we have an amount
                        if (amount) {
                            expenses.push({
                                type,
                                vendor,
                                location,
                                date,
                                amount,
                                cardType: paymentMethod,
                                customerName: customerName,
                                loyaltyNumber: document.getElementById('loyaltyNumber').value || '',
                                // For hotels, default to 1 night
                                ...(type.includes('Accommodation') && {nights: 1}),
                                // For car rentals, default to 1 day
                                ...(type.includes('Car Rental') && {days: 1})
                            });
                        }
                    }
                }
                
                return expenses;
            }

            // Display parsed expenses in the table
            function displayParsedExpenses(expenses) {
                expenseTableBody.innerHTML = '';
                
                if (expenses.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="7" class="px-3 py-4 text-center text-gray-400">
                            No expenses added yet. Paste data or use manual entry.
                        </td>
                    `;
                    expenseTableBody.appendChild(row);
                    return;
                }
                
                expenses.forEach((expense, index) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-700';
                    
                    row.innerHTML = `
                        <td class="px-3 py-4">
                            <input type="checkbox" name="expenseCheck" value="${index}" class="h-4 w-4 text-primary border-gray-600 rounded">
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            ${expense.type}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            ${expense.vendor}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            ${expense.location}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            ${expense.date}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">
                            ${expense.amount}
                        </td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm">
                            <button class="text-primary hover:text-blue-400 mr-2 delete-expense-btn" data-index="${index}">
                                Delete
                            </button>
                            <button class="text-green-500 hover:text-green-400 generate-single-btn" data-index="${index}">
                                Generate
                            </button>
                        </td>
                    `;
                    
                    expenseTableBody.appendChild(row);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-expense-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        expenses.splice(index, 1);
                        displayParsedExpenses(expenses);
                    });
                });
                
                // Add event listeners to generate single receipt buttons
                document.querySelectorAll('.generate-single-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.dataset.index);
                        const expense = expenses[index];
                        
                        // Calculate required credits
                        const creditsNeeded = proQuality.checked ? 2 : 1;
                        
                        // Check if enough credits
                        if (!useCredits(creditsNeeded)) {
                            alert(`Not enough credits. You need ${creditsNeeded} credits to generate this receipt.`);
                            return;
                        }
                        
                        // Check tax information
                        const hasTaxInfo = checkLocationTaxInfo(expense);
                        
                        // If no tax information could be determined, prompt the user
                        if (!hasTaxInfo) {
                            if (!confirm(`Location tax information couldn't be determined for ${expense.vendor} in "${expense.location}". Use default tax rate of 8.25%?`)) {
                                // User wants to set tax manually
                                alert('Please set the state, city, and tax rate in the left panel before generating the receipt.');
                                return;
                            }
                        }
                        
                        // Get customer name
                        const customerName = expense.customerName || document.getElementById('customerName').value || 'Guest';
                        
                        // Get payment method info if not already set
                        let paymentMethod = expense.cardType;
                        if (!paymentMethod) {
                            const paymentCardType = document.getElementById('paymentCardType').value;
                            const lastFour = document.getElementById('paymentLastFour').value || '0000';
                            paymentMethod = lastFour ? `${paymentCardType}â¢â¢â¢${lastFour}` : paymentCardType;
                        }
                        
                        // Get company policy values
                        const policy = {
                            customerName: customerName,
                            paymentMethod: paymentMethod,
                            loyaltyNumber: expense.loyaltyNumber || document.getElementById('loyaltyNumber').value || '',
                            taxRate: parseFloat(document.getElementById('taxRate').value) || 8.25,
                            receiptQuality: proQuality.checked ? 'pro' : 'basic'
                        };
                        
                        // Generate receipt
                        const receiptHTML = generateReceipt(expense, policy);
                        
                        // Set up for display
                        generatedReceipts = [receiptHTML];
                        currentReceiptIndex = 0;
                        showCurrentReceipt();
                        receiptModal.classList.remove('hidden');
                    });
                });
            }

            // Generate a receipt for a given expense
            function generateReceipt(expense, policy) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                const date = new Date(expense.date);
                const formattedDate = formatDate(date);
                const formattedTime = formatTime(date);
                
                // Determine if receipt is basic or pro quality
                const isProQuality = policy.receiptQuality === 'pro';
                
                // Determine receipt type based on vendor and expense type
                // This helps us select the appropriate template
                let receiptType = 'generic';
                
                if (expense.vendor.includes('UBER') || expense.vendor.includes('LYFT') || 
                    expense.type.includes('Taxi / Car Service')) {
                    receiptType = 'rideshare';
                } else if (expense.vendor.includes('HILTON') || 
                          expense.type.includes('Accommodation')) {
                    receiptType = 'hotel';
                    
                    // Specific hotel brands
                    if (expense.vendor.includes('MARRIOTT') || expense.vendor.includes('ALOFT')) {
                        receiptType = 'marriott';
                    } else if (expense.vendor.includes('HILTON')) {
                        receiptType = 'hilton';
                    }
                } else if (expense.type.includes('Car Rental') || expense.vendor.includes('AVIS') || 
                          expense.vendor.includes('HERTZ') || expense.vendor.includes('ENTERPRISE')) {
                    receiptType = 'carrental';
                }
                
                // Select the receipt template based on type and quality
                if (receiptType === 'rideshare') {
                    return generateRideshareReceipt(expense, policy, isProQuality);
                } else if (receiptType === 'hotel') {
                    return generateHotelReceipt(expense, policy, isProQuality);
                } else if (receiptType === 'marriott') {
                    return generateMarriottReceipt(expense, policy, isProQuality);
                } else if (receiptType === 'hilton') {
                    return generateHiltonReceipt(expense, policy, isProQuality);
                } else if (receiptType === 'carrental') {
                    return generateCarRentalReceipt(expense, policy, isProQuality);
                } else {
                    return generateGenericReceipt(expense, policy, isProQuality);
                }
            }
            
            // Generate Uber/Lyft style receipt
            function generateRideshareReceipt(expense, policy, isProQuality) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                const date = new Date(expense.date);
                const formattedDate = formatDate(date);
                const formattedTime = formatTime(date);
                
                // Calculate components
                const subtotal = parseFloat((amount * 0.70).toFixed(2));
                const bookingFee = parseFloat((amount * 0.05).toFixed(2));
                const surcharges = parseFloat((amount * 0.10).toFixed(2));
                const tip = parseFloat((amount * 0.15).toFixed(2));
                
                // Generate random ride details
                const durationMinutes = Math.floor(Math.random() * 35) + 10; // 10-45 minutes
                const distanceMiles = parseFloat((Math.random() * 20 + 2).toFixed(2)); // 2-22 miles
                
                // Pickup and dropoff locations
                const pickupLocation = expense.pickupLocation || "Main St & 1st Ave";
                const dropoffLocation = expense.dropoffLocation || "Airport Terminal 1";
                
                // Determine if it's Uber or Lyft
                const isUber = expense.vendor.includes('UBER');
                const serviceName = isUber ? "UBER" : "LYFT";
                const serviceColor = isUber ? "#000000" : "#FF00BF";
                
                // Random driver name
                const driverNames = ["Michael", "David", "Jennifer", "Maria", "John", "Robert", "Francisco", "Sarah", "James"];
                const driverName = driverNames[Math.floor(Math.random() * driverNames.length)];
                
                // Generate HTML for receipt
                let receiptHTML = `
                    <div data-quality="${policy.receiptQuality}" class="uber-receipt receipt-text" style="font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif; max-width: 400px; margin: 0 auto; padding: 20px; color: #000;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            ${isProQuality ? `<div style="margin-bottom: 10px;"><i class="fas fa-${isUber ? 'car' : 'car-side'}" style="font-size: 28px; color: ${serviceColor};"></i></div>` : ''}
                            <h2 style="margin: 0; font-size: 24px; color: ${serviceColor};">${serviceName}</h2>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">Receipt</p>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Date:</strong> ${formattedDate}</p>
                            <p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Time:</strong> ${formattedTime}</p>
                        </div>
                        
                        <div style="margin-bottom: 20px; border: 1px solid #eee; border-radius: 8px; padding: 12px;">
                            <p style="margin: 0 0 8px 0; font-size: 13px; color: #666;">${formatTime(new Date(date.getTime() - durationMinutes * 60000))} | ${pickupLocation}</p>
                            <p style="margin: 0; font-size: 13px; color: #666;">${formattedTime} | ${dropoffLocation}</p>
                            <div style="margin-top: 12px; font-size: 14px; color: #000;">
                                <span>${isUber ? 'UberX' : 'Lyft'}</span>
                                <span style="margin-left: 10px;">${distanceMiles} miles</span>
                                <span style="margin-left: 10px;">| ${durationMinutes} min</span>
                            </div>
                        </div>
                        
                        ${isProQuality ? `
                        <div style="margin-bottom: 15px; border-top: 1px solid #eee; padding-top: 12px;">
                            <p style="margin: 3px 0; font-size: 14px; color: #000;">Thanks for riding${policy.customerName !== 'Guest' ? ', ' + policy.customerName.split(' ')[0] : ''}!</p>
                            <p style="margin: 3px 0; font-size: 14px; color: #000;">You rode with ${driverName}</p>
                        </div>
                        ` : ''}
                        
                        <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 5px;">
                            <table style="width: 100%; border-collapse: collapse; color: #000;">
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Trip fare</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${subtotal.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Booking Fee</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${bookingFee.toFixed(2)}</td>
                                </tr>
                                ${isProQuality && (expense.location.toLowerCase().includes('airport') || dropoffLocation.toLowerCase().includes('airport')) ? `
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Airport Surcharge</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${surcharges.toFixed(2)}</td>
                                </tr>
                                ` : `
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Service Fee</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${surcharges.toFixed(2)}</td>
                                </tr>
                                `}
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Tip</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${tip.toFixed(2)}</td>
                                </tr>
                                <tr style="font-weight: bold;">
                                    <td style="text-align: left; padding: 8px 0; border-top: 2px solid #eee; color: #000;">Total</td>
                                    <td style="text-align: right; padding: 8px 0; border-top: 2px solid #eee; color: #000;">$${amount.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Payment</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">${policy.paymentMethod}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-top: 25px; text-align: center; color: #999; font-size: 12px;">
                            <p>Visit the trip page for more information, including invoices (where available)</p>
                        </div>
                    </div>
                `;
                
                return receiptHTML;
            }
            
            // Generate Hilton receipt
            function generateHiltonReceipt(expense, policy, isProQuality) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                const date = new Date(expense.date);
                const nights = expense.nights || 1;
                
                // Calculate check-in date (checkout date - nights)
                const checkInDate = new Date(date);
                checkInDate.setDate(checkInDate.getDate() - nights);
                
                // Generate folio number
                const folioNumber = Math.floor(1000000000 + Math.random() * 9000000000);
                const confirmationNumber = Math.floor(3000000000 + Math.random() * 9000000000);
                
                // Calculate room rate and taxes
                const roomRate = parseFloat((amount * 0.85 / nights).toFixed(2));
                const stateTax = parseFloat((roomRate * 0.10).toFixed(2));
                const cityTax = parseFloat((roomRate * 0.075).toFixed(2));
                const occupancyTax = parseFloat((roomRate * 0.01).toFixed(2));
                const additionalTax = parseFloat((roomRate * 0.005).toFixed(2));
                
                // Room number (random 3-digit number)
                const roomNumber = Math.floor(100 + Math.random() * 900);
                
                // Generate HTML for receipt
                let receiptHTML = `
                    <div data-quality="${policy.receiptQuality}" class="hilton-receipt receipt-text" style="font-family: 'Georgia', serif; max-width: 680px; margin: 0 auto; padding: 20px; color: #000;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <div>
                                <h2 style="margin: 0; font-size: 22px; color: #00538A;">Hilton ${expense.location.split(',')[0]}</h2>
                                <p style="margin: 4px 0; font-size: 13px; color: #555;">${expense.location}</p>
                                ${isProQuality ? `<p style="margin: 2px 0; font-size: 12px; color: #555;">Tel: (XXX) XXX-XXXX | Email: XXXX_GM@hilton.com</p>` : ''}
                            </div>
                            ${isProQuality ? `
                            <div>
                                <img src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/html5/html5-plain.svg" alt="Hilton Logo" style="width: 100px; opacity: 0.0;">
                            </div>
                            ` : ''}
                        </div>
                        
                        <div style="border-bottom: 1px solid #ddd; margin-bottom: 15px; padding-bottom: 10px;">
                            <h3 style="margin: 0; font-size: 18px; color: #00538A;">Guest Folio</h3>
                            <p style="margin: 4px 0; font-size: 13px; color: #555;">Confirmation Number - ${confirmationNumber}</p>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #00538A;">Primary Guest</h4>
                                <p style="margin: 2px 0; font-size: 13px; color: #333;"><strong>${policy.customerName.toUpperCase()}</strong></p>
                                ${isProQuality ? `
                                <p style="margin: 2px 0; font-size: 13px; color: #555;">718 EVLEN RD</p>
                                <p style="margin: 2px 0; font-size: 13px; color: #555;">PLYMOUTH MEETING PA 19462</p>
                                ` : ''}
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #00538A;">Stay Details</h4>
                                <table style="font-size: 13px; color: #333; width: 100%;">
                                    <tr>
                                        <td style="padding: 2px 10px 2px 0; color: #333;">Check In Date</td>
                                        <td style="padding: 2px 0; color: #333;">${formatDate(checkInDate, 'MMM DD, YYYY')}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 10px 2px 0; color: #333;">Check Out Date</td>
                                        <td style="padding: 2px 0; color: #333;">${formatDate(date, 'MMM DD, YYYY')}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 10px 2px 0; color: #333;">Room</td>
                                        <td style="padding: 2px 0; color: #333;">KING - ${roomNumber}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 10px 2px 0; color: #333;">Guests</td>
                                        <td style="padding: 2px 0; color: #333;">1/0</td>
                                    </tr>
                                </table>
                            </div>
                            
                            ${policy.loyaltyNumber ? `
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #00538A;">Hilton Honors</h4>
                                <p style="margin: 2px 0; font-size: 13px; color: #333;">${policy.loyaltyNumber}</p>
                                <p style="margin: 2px 0; font-size: 13px; color: #333;">Gold</p>
                            </div>
                            ` : ''}
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; color: #000;">
                            <thead>
                                <tr style="background-color: #f5f5f5; color: #333;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #333;">Date</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #333;">Type</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd; color: #333;">Description</th>
                                    <th style="padding: 8px; text-align: right; border-bottom: 1px solid #ddd; color: #333;">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Generate entries for each night
                for (let i = 0; i < nights; i++) {
                    const currentDate = new Date(checkInDate);
                    currentDate.setDate(currentDate.getDate() + i);
                    const formattedCurrentDate = formatDate(currentDate, 'MMM DD, YYYY');
                    
                    receiptHTML += `
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Charge</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">GUEST ROOM</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${roomRate.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Tax</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">RM SALES TAX</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${stateTax.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Tax</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">RM CITY OCCUPANCY TAX</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${cityTax.toFixed(2)}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Tax</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">RM CITY ARENA FEE</td>
                            <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${occupancyTax.toFixed(2)}</td>
                        </tr>
                    `;
                    
                    // Add food charges for pro quality
                    if (isProQuality && i < nights - 1) {
                        const foodCharge = parseFloat((Math.random() * 15 + 10).toFixed(2));
                        const foodTax = parseFloat((foodCharge * 0.0825).toFixed(2));
                        const tipAmount = parseFloat((foodCharge * 0.18).toFixed(2));
                        
                        receiptHTML += `
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Charge</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">GALLERY BFAST - POS #${Math.floor(1000 + Math.random() * 9000)}</td>
                                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${foodCharge.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Tax</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">FB SALES TAX</td>
                                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${foodTax.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formattedCurrentDate}</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Charge</td>
                                <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">GALLERY TIPS - POS #${Math.floor(1000 + Math.random() * 9000)}</td>
                                <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">$${tipAmount.toFixed(2)}</td>
                            </tr>
                        `;
                    }
                }
                
                // Payment line
                receiptHTML += `
                    <tr>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${formatDate(date, 'MMM DD, YYYY')}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">Payments</td>
                        <td style="padding: 8px; border-bottom: 1px solid #eee; color: #333;">${policy.paymentMethod}</td>
                        <td style="padding: 8px; text-align: right; border-bottom: 1px solid #eee; color: #333;">($${amount.toFixed(2)})</td>
                    </tr>
                `;
                
                // Complete the receipt
                receiptHTML += `
                            </tbody>
                        </table>
                        
                        <div style="border-top: 1px solid #ddd; padding-top: 15px; text-align: right;">
                            <table style="margin-left: auto; width: auto; color: #000;">
                                <tr>
                                    <td style="padding: 4px 15px 4px 0; font-weight: bold; color: #333;">Folio Balance</td>
                                    <td style="padding: 4px 0; font-weight: bold; color: #333;">$0.00</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center; color: #666; font-size: 11px;">
                            <p style="margin: 0;">Check In Time: 03:00 PM | Check Out Time: 12:00 PM</p>
                            <p style="margin: 5px 0;">Reservations: hiltonhotels.com or +1-800-HILTONS</p>
                        </div>
                    </div>
                `;
                
                return receiptHTML;
            }
            
            // Generate Marriott/Aloft receipt
            function generateMarriottReceipt(expense, policy, isProQuality) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                const date = new Date(expense.date);
                const nights = expense.nights || 1;
                
                // Calculate check-in date (checkout date - nights)
                const checkInDate = new Date(date);
                checkInDate.setDate(checkInDate.getDate() - nights);
                
                // Format dates in the style used by Marriott
                const checkInFormatted = formatDate(checkInDate, 'DD-MMM-YY HH:MM');
                const checkOutFormatted = formatDate(date, 'DD-MMM-YY');
                
                // Generate guest number and other identifiers
                const guestNumber = Math.floor(100000 + Math.random() * 900000);
                const roomNumber = Math.floor(100 + Math.random() * 900);
                const folioID = String.fromCharCode(65 + Math.floor(Math.random() * 26)); // Random letter A-Z
                
                // Calculate room rate and taxes
                const roomCharge = parseFloat((amount * 0.86).toFixed(2));
                const stateTax = parseFloat((roomCharge * 0.09).toFixed(2));
                const cityTax = parseFloat((roomCharge * 0.05).toFixed(2));
                const tourismFee = parseFloat(2.00);
                const javitsFee = parseFloat(1.50);
                
                // Build branded hotel name
                const hotelBrand = expense.vendor.includes('ALOFT') ? 'Aloft' : 
                                  expense.vendor.includes('MARRIOTT') ? 'Marriott' : 
                                  expense.vendor.includes('WESTIN') ? 'Westin' : 
                                  expense.vendor.includes('SHERATON') ? 'Sheraton' : 'Marriott';
                
                const cityName = expense.location.split(',')[0].trim();
                const hotelName = `${hotelBrand} ${cityName}`;
                
                // Generate HTML for receipt
                let receiptHTML = `
                    <div data-quality="${policy.receiptQuality}" class="marriott-receipt receipt-text" style="font-family: Arial, sans-serif; max-width: 680px; margin: 0 auto; padding: 20px; color: #000;">
                        <div style="margin-bottom: 15px;">
                            <h2 style="margin: 0; font-size: 18px; color: #000;">${hotelName}</h2>
                            <p style="margin: 4px 0; font-size: 13px; color: #333;">100-15 Ditmars Blvd</p>
                            <p style="margin: 4px 0; font-size: 13px; color: #333;">${expense.location}</p>
                            <p style="margin: 4px 0; font-size: 13px; color: #333;">United States</p>
                            ${isProQuality ? `<p style="margin: 4px 0; font-size: 13px; color: #333;">Tel: XXX-XXX-XXXX Fax: XXX-XXX-XXXX</p>` : ''}
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div style="flex: 1;">
                                <table style="width: 100%; font-size: 13px; color: #000;">
                                    <tr>
                                        <td style="padding: 3px; width: 120px; color: #000;">Guest Name</td>
                                        <td style="padding: 3px; color: #000;">${policy.customerName.toUpperCase()}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Guest Number</td>
                                        <td style="padding: 3px; color: #000;">${guestNumber}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Folio ID</td>
                                        <td style="padding: 3px; color: #000;">${folioID}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Arrive Date</td>
                                        <td style="padding: 3px; color: #000;">${checkInFormatted}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Depart Date</td>
                                        <td style="padding: 3px; color: #000;">${checkOutFormatted}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">No. Of Guest</td>
                                        <td style="padding: 3px; color: #000;">1</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Room Number</td>
                                        <td style="padding: 3px; color: #000;">${roomNumber}</td>
                                    </tr>
                                    ${policy.loyaltyNumber ? `
                                    <tr>
                                        <td style="padding: 3px; color: #000;">Marriott Bonvoy Number</td>
                                        <td style="padding: 3px; color: #000;">${policy.loyaltyNumber}</td>
                                    </tr>
                                    ` : ''}
                                </table>
                            </div>
                            
                            ${isProQuality ? `
                            <div style="flex: 0 0 100px; text-align: right;">
                                <div style="background-color: #000; color: #fff; display: inline-block; padding: 3px 10px; margin-bottom: 10px; font-weight: bold;">
                                    Page 1
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; color: #000;">
                            <thead>
                                <tr style="border-bottom: 1px solid #ccc; color: #000;">
                                    <th style="padding: 8px; text-align: left; color: #000;">Date</th>
                                    <th style="padding: 8px; text-align: left; color: #000;">Reference</th>
                                    <th style="padding: 8px; text-align: left; color: #000;">Description</th>
                                    <th style="padding: 8px; text-align: right; color: #000;">Charges (USD)</th>
                                    <th style="padding: 8px; text-align: right; color: #000;">Credits (USD)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formatDate(checkInDate, 'DD-MMM-YY')}</td>
                                    <td style="padding: 8px; color: #000;">RT${roomNumber}</td>
                                    <td style="padding: 8px; color: #000;">Room Chrg - Standard Retail</td>
                                    <td style="padding: 8px; text-align: right; color: #000;">${roomCharge.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formatDate(checkInDate, 'DD-MMM-YY')}</td>
                                    <td style="padding: 8px; color: #000;">RT${roomNumber}</td>
                                    <td style="padding: 8px; color: #000;">State Tax</td>
                                    <td style="padding: 8px; text-align: right; color: #000;">${stateTax.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formatDate(checkInDate, 'DD-MMM-YY')}</td>
                                    <td style="padding: 8px; color: #000;">RT${roomNumber}</td>
                                    <td style="padding: 8px; color: #000;">City/Local Tax</td>
                                    <td style="padding: 8px; text-align: right; color: #000;">${cityTax.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formatDate(checkInDate, 'DD-MMM-YY')}</td>
                                    <td style="padding: 8px; color: #000;">RT${roomNumber}</td>
                                    <td style="padding: 8px; color: #000;">Occupancy/Tourism</td>
                                    <td style="padding: 8px; text-align: right; color: #000;">${tourismFee.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formatDate(checkInDate, 'DD-MMM-YY')}</td>
                                    <td style="padding: 8px; color: #000;">RT${roomNumber}</td>
                                    <td style="padding: 8px; color: #000;">Javits Center Tax</td>
                                    <td style="padding: 8px; text-align: right; color: #000;">${javitsFee.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 8px; color: #000;">${formatDate(date, 'DD-MMM-YYYY')}</td>
                                    <td style="padding: 8px; color: #000;">VI</td>
                                    <td style="padding: 8px; color: #000;">${policy.paymentMethod.includes('VISA') ? 'Visa' : policy.paymentMethod.includes('AMEX') ? 'American Express' : policy.paymentMethod.includes('MC') ? 'MasterCard' : policy.paymentMethod.includes('DISC') ? 'Discover' : 'Credit Card'}</td>
                                    <td style="padding: 8px; text-align: right; color: #000;"></td>
                                    <td style="padding: 8px; text-align: right; color: #000;">-${amount.toFixed(2)}</td>
                                </tr>
                                <tr style="border-top: 1px solid #ccc;">
                                    <td colspan="3" style="padding: 8px; text-align: right; font-weight: bold; color: #000;">** Total</td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold; color: #000;">${amount.toFixed(2)}</td>
                                    <td style="padding: 8px; text-align: right; font-weight: bold; color: #000;">-${amount.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 8px; text-align: right; font-weight: bold; color: #000;">*** Balance</td>
                                    <td colspan="2" style="padding: 8px; text-align: right; font-weight: bold; color: #000;">0.00</td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div style="margin-top: 20px; text-align: left; color: #666; font-size: 11px;">
                            <p style="margin: 0;">I agreed to pay all room & incidental charges.</p>
                        </div>
                        
                        ${isProQuality ? `
                        <div style="margin-top: 50px; border-top: 1px solid #ccc; padding-top: 15px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 14px; color: #000;">EXPENSE SUMMARY REPORT</h3>
                            <p style="margin: 0 0 10px 0; font-size: 12px; color: #000;">Currency: USD</p>
                            
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px; color: #000;">
                                <thead>
                                    <tr style="border-bottom: 1px solid #ccc; color: #000;">
                                        <th style="padding: 5px; text-align: left; color: #000;">Date</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Room & Tax</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Food & Bev</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Telecomm</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Parking</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Misc</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Other</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Total</th>
                                        <th style="padding: 5px; text-align: right; color: #000;">Payment</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="padding: 5px; color: #000;">${formatDate(checkInDate, 'MM-DD-YYYY')}</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">${amount.toFixed(2)}</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">${amount.toFixed(2)}</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                    </tr>
                                    <tr style="border-top: 1px solid #ccc;">
                                        <td style="padding: 5px; color: #000;">Total</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">${amount.toFixed(2)}</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">${amount.toFixed(2)}</td>
                                        <td style="padding: 5px; text-align: right; color: #000;">0.00</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 30px; text-align: center; color: #666; font-size: 11px;">
                            <p style="margin: 5px 0;">Tell us about your stay. www.${hotelBrand.toLowerCase()}hotels.com/reviews</p>
                        </div>
                    </div>
                `;
                
                return receiptHTML;
            }
            
            // Generate Car Rental Receipt (Avis/Hertz style)
            function generateCarRentalReceipt(expense, policy, isProQuality) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                const date = new Date(expense.date);
                const days = expense.days || 1;
                
                // Calculate pickup date (return date - days)
                const pickupDate = new Date(date);
                pickupDate.setDate(pickupDate.getDate() - days);
                
                // Format dates
                const pickupFormatted = formatDate(pickupDate, 'MMM DD, YYYY');
                const pickupTimeFormatted = formatTime(pickupDate);
                const returnFormatted = formatDate(date, 'MMM DD, YYYY');
                const returnTimeFormatted = formatTime(date);
                
                // Create agreement number and other identifiers
                const agreementNumber = Math.floor(100000000 + Math.random() * 900000000);
                const wizardNumber = Math.floor(1000 + Math.random() * 9000);
                const vehicleNumber = Math.floor(50000000 + Math.random() * 10000000);
                
                // Calculate charges
                const baseRate = parseFloat((amount * 0.70).toFixed(2));
                const dailyRate = parseFloat((baseRate / days).toFixed(2));
                const concessionFee = parseFloat((amount * 0.11).toFixed(2));
                const facilityCharge = parseFloat((6.00 * days).toFixed(2));
                const licenseFee = parseFloat((1.40 * days).toFixed(2));
                const countySurcharge = parseFloat((amount * 0.02).toFixed(2));
                const energyFee = parseFloat((0.79 * days).toFixed(2));
                const tax = parseFloat((amount * 0.06).toFixed(2));
                
                // Random vehicle details
                const vehicles = [
                    { make: 'JEEP', model: 'GCL4 4WD', plate: 'ILFP256758', color: 'WHI' },
                    { make: 'CHEV', model: 'MALIBU', plate: 'IL9873492', color: 'BLK' },
                    { make: 'FORD', model: 'EXPRER', plate: 'ILRT45623', color: 'SIL' },
                    { make: 'TOYT', model: 'CAMRY', plate: 'MI874521', color: 'BLU' }
                ];
                const vehicle = expense.vehicle && expense.licensePlate ? 
                    { make: expense.vehicle.split(' ')[0], model: expense.vehicle.split(' ').slice(1).join(' '), plate: expense.licensePlate, color: 'WHI' } : 
                    vehicles[Math.floor(Math.random() * vehicles.length)];
                
                // Generate odometer readings
                const odometerOut = Math.floor(10000 + Math.random() * 40000);
                const milesDriven = Math.floor(50 + Math.random() * 500);
                const odometerIn = odometerOut + milesDriven;
                
                // Fuel levels
                const fuelOut = parseFloat((Math.random() * 5 + 20).toFixed(1)); // 20-25 gallons
                const fuelConsumed = parseFloat((Math.random() * 8 + 2).toFixed(1)); // 2-10 gallons
                const fuelIn = parseFloat((fuelOut - fuelConsumed).toFixed(1));
                
                // Pickup and return locations
                const pickupLocation = expense.pickupLocation || 'DETROIT METROPOLITAN AIRPORT';
                const returnLocation = expense.returnLocation || pickupLocation;
                
                // Generate HTML for receipt
                let receiptHTML = `
                    <div data-quality="${policy.receiptQuality}" class="avis-receipt receipt-text" style="font-family: 'Helvetica', sans-serif; max-width: 680px; margin: 0 auto; padding: 20px; color: #000;">
                        <div style="border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px;">
                            <div style="text-align: center;">
                                <h2 style="margin: 0; font-size: 18px; font-weight: bold; color: #000;">RENTAL AGREEMENT NUMBER: ${agreementNumber} RECEIPT</h2>
                                ${isProQuality ? `<p style="margin: 10px 0 0 0; font-size: 13px; color: #333;">We are proud to feature a 100% smoke-free fleet!</p>` : ''}
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #000;">Your Information</h3>
                                <table style="width: 100%; font-size: 13px; color: #000;">
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; width: 150px; color: #000;">Customer Name:</td>
                                        <td style="padding: 2px 0; color: #000;">${policy.customerName.toUpperCase()}</td>
                                    </tr>
                                    ${isProQuality ? `
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Wizard Number:</td>
                                        <td style="padding: 2px 0; color: #000;">***${wizardNumber}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Discount:</td>
                                        <td style="padding: 2px 0; color: #000;">UP TO 5K OFFER</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Customer Status:</td>
                                        <td style="padding: 2px 0; color: #000;">PREFERRED</td>
                                    </tr>
                                    ` : ''}
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Method of Payment:</td>
                                        <td style="padding: 2px 0; color: #000;">${policy.paymentMethod}</td>
                                    </tr>
                                    ${isProQuality && policy.loyaltyNumber ? `
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Frequent Traveler Number:</td>
                                        <td style="padding: 2px 0; color: #000;">${policy.loyaltyNumber}</td>
                                    </tr>
                                    ` : ''}
                                </table>
                            </div>
                            
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #000;">Your Vehicle Information</h3>
                                <table style="width: 100%; font-size: 13px; color: #000;">
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; width: 150px; color: #000;">Vehicle Number:</td>
                                        <td style="padding: 2px 0; color: #000;">${vehicleNumber}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Vehicle Group Rented:</td>
                                        <td style="padding: 2px 0; color: #000;">Standard SUV-7 Pass</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Vehicle Group Charged:</td>
                                        <td style="padding: 2px 0; color: #000;">Luxury</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Vehicle Description:</td>
                                        <td style="padding: 2px 0; color: #000;">${vehicle.color} ${vehicle.make} ${vehicle.model}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">License Plate Number:</td>
                                        <td style="padding: 2px 0; color: #000;">${vehicle.plate}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Odometer Out/In:</td>
                                        <td style="padding: 2px 0; color: #000;">${odometerOut} / ${odometerIn}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Total Driven:</td>
                                        <td style="padding: 2px 0; color: #000;">${milesDriven}</td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px 0; vertical-align: top; color: #000;">Fuel Reading:</td>
                                        <td style="padding: 2px 0; color: #000;">Out ${fuelOut} Gal | In ${fuelIn} Gal</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #000;">Your Rental</h3>
                            <table style="width: 100%; font-size: 13px; color: #000;">
                                <tr>
                                    <td style="padding: 2px 0; vertical-align: top; width: 150px; color: #000;">Pickup Date/Time:</td>
                                    <td style="padding: 2px 0; color: #000;">${pickupFormatted}@${pickupTimeFormatted}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; vertical-align: top; color: #000;">Pickup Location:</td>
                                    <td style="padding: 2px 0; color: #000;">${pickupLocation}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; vertical-align: top; color: #000;">Return Date/Time:</td>
                                    <td style="padding: 2px 0; color: #000;">${returnFormatted}@${returnTimeFormatted}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; vertical-align: top; color: #000;">Return Location:</td>
                                    <td style="padding: 2px 0; color: #000;">${returnLocation}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #000;">Your Vehicle Charges (MIN 1 DAY / MAX ${days * 24} HRS)</h3>
                            
                            <table style="width: 100%; font-size: 13px; color: #000; margin-bottom: 10px;">
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Rate Chart:</td>
                                    <td style="padding: 2px 0; color: #000;">Free Miles:</td>
                                    <td style="padding: 2px 0; color: #000;">Time and Mileage:</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Miles: UNLIMITED</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Hourly: 20.01</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Daily: ${dailyRate.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Ad'l day: 89.99</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Weekly: 419.93</td>
                                </tr>
                                <tr>
                                    <td colspan="3" style="padding: 2px 0; color: #000;">Monthly: 1799.70</td>
                                </tr>
                            </table>
                            
                            <table style="width: 100%; font-size: 13px; color: #000;">
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Your Discount:</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">${days} Ad'l Day @ ${dailyRate.toFixed(2)} = ${baseRate.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Less 10.00% Discount = (-)${(baseRate * 0.1).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Time and Mileage: ${baseRate.toFixed(2)}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 10px 0; font-size: 14px; text-transform: uppercase; color: #000;">Your Taxable Fees</h3>
                            <table style="width: 100%; font-size: 13px; color: #000;">
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">11.11% Concession Recovery Fee</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${concessionFee.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Fuel Service = (${fuelOut} Gal Out - ${fuelIn} Gal In) 3.401/GAL</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${(fuelConsumed * 3.401).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">FTP SR$ 1.00DY</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${days.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">CUST FACILITY CHARGE 6.00/DY</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${facilityCharge.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">2.00 2.00 COUNTY SURCHARGE</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${countySurcharge.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">VEH LICENSE RECOUP 1.40/DY</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${licenseFee.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">ENERGY RECOVERY FEE 0.79/DY</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${energyFee.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                    <td style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Sub-total-Charges:</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${(amount - tax).toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">TAX 6.000%</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${tax.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                    <td style="padding: 2px 0; border-top: 1px solid #ccc; color: #000;"></td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Your Total Charges:</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">USD ${amount.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Prepayment</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">0.00</td>
                                </tr>
                                ${isProQuality ? `
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Estimated Travel Partner Points Earned*:</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">${Math.floor(amount * 20)}</td>
                                </tr>
                                ` : ''}
                                <tr>
                                    <td style="padding: 2px 0; color: #000;">Net Charges:</td>
                                    <td style="padding: 2px 0; text-align: right; color: #000;">USD ${amount.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 2px 0; font-weight: bold; color: #000;">Your Total Due:</td>
                                    <td style="padding: 2px 0; text-align: right; font-weight: bold; color: #000;">0.00</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-top: 30px; text-align: center; color: #666; font-size: 11px;">
                            <p style="margin: 0;">Thank you for renting with Avis.</p>
                            <p style="margin: 5px 0;">For all other inquiries, please contact us at 1-800-352-7900 or www.Avis.com.</p>
                            ${isProQuality ? `
                            <p style="margin: 10px 0;">*Subject to audit process, the points will be awarded according to the Terms and Conditions in place.</p>
                            ` : ''}
                        </div>
                    </div>
                `;
                
                return receiptHTML;
            }
            
            // Generate Generic receipt
            function generateGenericReceipt(expense, policy, isProQuality) {
                const amount = parseFloat(expense.amount.replace('$', '').replace(',', ''));
                const date = new Date(expense.date);
                const formattedDate = formatDate(date);
                const formattedTime = formatTime(date);
                
                // Calculate receipt components based on tax rate
                const subtotal = parseFloat((amount / (1 + policy.taxRate / 100)).toFixed(2));
                const tax = parseFloat((amount - subtotal).toFixed(2));
                
                // Generate random receipt details
                const receiptNumber = generateRandomReceiptNumber();
                
                // Check if it's a food/meal receipt
                const isMeal = expense.type.includes('Dinner') || expense.type.includes('Lunch') || expense.type.includes('Breakfast');
                
                // Generate receipt items
                let receiptItems = [];
                
                if (isMeal) {
                    // Food receipt
                    const mealType = expense.type.includes('Dinner') ? 'Dinner' : 
                                   expense.type.includes('Lunch') ? 'Lunch' : 'Breakfast';
                    
                    // Generate menu items based on meal type and receipt quality
                    if (isProQuality) {
                        // More detailed for premium receipts
                        const mainDishPrice = parseFloat((subtotal * 0.6).toFixed(2));
                        const sideDishPrice = parseFloat((subtotal * 0.2).toFixed(2));
                        const beveragePrice = parseFloat((subtotal * 0.15).toFixed(2));
                        const extraPrice = parseFloat((subtotal - mainDishPrice - sideDishPrice - beveragePrice).toFixed(2));
                        
                        receiptItems.push({
                            name: generateRandomFoodItem(mealType),
                            quantity: 1,
                            price: mainDishPrice
                        });
                        
                        receiptItems.push({
                            name: generateRandomFoodItem(mealType, true),
                            quantity: 1,
                            price: sideDishPrice
                        });
                        
                        receiptItems.push({
                            name: mealType === 'Breakfast' ? 'Coffee/Tea' : 'Beverage',
                            quantity: 1,
                            price: beveragePrice
                        });
                        
                        // Add optional alcohol for dinner if appropriate
                        if (mealType === 'Dinner' && policy.allowAlcohol && amount > 30) {
                            receiptItems.push({
                                name: generateRandomAlcoholItem(),
                                quantity: 1,
                                price: extraPrice
                            });
                        } else {
                            // Add an extra if not alcohol
                            receiptItems.push({
                                name: mealType === 'Breakfast' ? 'Fresh Fruit' : 'Dessert',
                                quantity: 1,
                                price: extraPrice
                            });
                        }
                    } else {
                        // Simpler for basic receipts
                        receiptItems.push({
                            name: generateRandomFoodItem(mealType),
                            quantity: 1,
                            price: parseFloat((subtotal * 0.7).toFixed(2))
                        });
                        
                        receiptItems.push({
                            name: generateRandomFoodItem(mealType, true),
                            quantity: 1,
                            price: parseFloat((subtotal * 0.3).toFixed(2))
                        });
                    }
                } else {
                    // Generic receipt items
                    if (isProQuality) {
                        // More detailed breakdown for premium
                        for (let i = 0; i < 3; i++) {
                            receiptItems.push({
                                name: `Item ${i+1}`,
                                quantity: i === 1 ? 2 : 1, // Make one item have quantity 2
                                price: parseFloat((subtotal / (i === 1 ? 4 : 2)).toFixed(2))
                            });
                        }
                    } else {
                        // Basic receipt
                        receiptItems.push({
                            name: "Item 1",
                            quantity: 1,
                            price: parseFloat((subtotal * 0.7).toFixed(2))
                        });
                        
                        receiptItems.push({
                            name: "Item 2",
                            quantity: 1,
                            price: parseFloat((subtotal * 0.3).toFixed(2))
                        });
                    }
                }
                
                // Generate HTML for receipt items
                const itemsHTML = receiptItems.map(item => `
                    <tr>
                        <td style="text-align: left; padding: 4px 5px; color: #000;">${item.quantity}x</td>
                        <td style="text-align: left; padding: 4px 5px; color: #000;">${item.name}</td>
                        <td style="text-align: right; padding: 4px 5px; color: #000;">$${(item.price * item.quantity).toFixed(2)}</td>
                    </tr>
                `).join('');
                
                // Generate HTML for generic receipt
                let receiptHTML = `
                    <div data-quality="${policy.receiptQuality}" class="generic-receipt receipt-text" style="font-family: Arial, sans-serif; max-width: 400px; margin: 0 auto; padding: 20px; color: #000;">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; font-size: 24px; color: #333;">${expense.vendor}</h2>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">${expense.location}</p>
                            <p style="margin: 5px 0; color: #666; font-size: 14px;">Receipt</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Date:</strong> ${formattedDate}</p>
                            <p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Time:</strong> ${formattedTime}</p>
                            <p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Receipt #:</strong> ${receiptNumber}</p>
                            ${policy.customerName !== 'Guest' ? `<p style="margin: 3px 0; font-size: 14px; color: #000;"><strong>Customer:</strong> ${policy.customerName}</p>` : ''}
                        </div>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; color: #000;">
                            <thead>
                                <tr style="border-bottom: 1px solid #eee;">
                                    <th style="padding: 8px 5px; text-align: left; color: #000;">Qty</th>
                                    <th style="padding: 8px 5px; text-align: left; color: #000;">Item</th>
                                    <th style="padding: 8px 5px; text-align: right; color: #000;">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                        </table>
                        
                        <div style="border-top: 1px solid #eee; padding-top: 10px;">
                            <table style="width: 100%; font-size: 14px; color: #000;">
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Subtotal</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${subtotal.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Tax (${policy.taxRate}%)</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">$${tax.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; font-weight: bold; color: #000;"><strong>Total</strong></td>
                                    <td style="text-align: right; padding: 4px 0; font-weight: bold; color: #000;"><strong>$${amount.toFixed(2)}</strong></td>
                                </tr>
                                <tr>
                                    <td style="text-align: left; padding: 4px 0; color: #000;">Payment Method</td>
                                    <td style="text-align: right; padding: 4px 0; color: #000;">${policy.paymentMethod}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="margin-top: 30px; text-align: center; color: #999; font-size: 12px;">
                            <p style="margin: 0 0 5px 0; color: #666;">Thank you for your business!</p>
                            ${isProQuality ? `<p style="margin: 0; color: #666;">Please come again soon!</p>` : ''}
                        </div>
                    </div>
                `;
                
                return receiptHTML;
            }

            // Helper functions for generating realistic receipt details
            function generateRandomReceiptNumber() {
                return `INV-${Math.floor(10000 + Math.random() * 90000)}`;
            }

            function formatDate(date, format = 'MMM DD, YYYY') {
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const monthsLong = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                
                const day = date.getDate();
                const month = date.getMonth();
                const year = date.getFullYear();
                const hours = date.getHours();
                const minutes = date.getMinutes();
                
                let result = format;
                
                // Replace patterns
                result = result.replace('YYYY', year);
                result = result.replace('YY', String(year).slice(-2));
                result = result.replace('MMMM', monthsLong[month]);
                result = result.replace('MMM', months[month]);
                result = result.replace('MM', String(month + 1).padStart(2, '0'));
                result = result.replace('M', month + 1);
                result = result.replace('DD', String(day).padStart(2, '0'));
                result = result.replace('D', day);
                result = result.replace('HH', String(hours).padStart(2, '0'));
                result = result.replace('H', hours);
                result = result.replace('MM', String(minutes).padStart(2, '0'));
                result = result.replace('M', minutes);
                
                return result;
            }

            function formatTime(date) {
                // Generate a random time appropriate for the expense type
                let hours = Math.floor(Math.random() * 12) + 7; // 7am to 7pm
                const minutes = Math.floor(Math.random() * 60);
                const ampm = hours >= 12 ? 'PM' : 'AM';
                
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                
                return `${hours}:${minutes.toString().padStart(2, '0')} ${ampm}`;
            }

            function generateRandomFoodItem(mealType, isSide = false) {
                const breakfastItems = [
                    'Eggs Benedict', 'Avocado Toast', 'Pancakes', 'Belgian Waffle', 
                    'Breakfast Burrito', 'Omelette', 'French Toast'
                ];
                
                const breakfastSides = [
                    'Hash Browns', 'Fresh Fruit', 'Bacon', 'Sausage Links', 
                    'Toast', 'Small Orange Juice', 'Coffee'
                ];
                
                const lunchItems = [
                    'Chicken Caesar Salad', 'Turkey Club Sandwich', 'Veggie Burger', 
                    'Grilled Chicken Wrap', 'Cobb Salad', 'Tuna Melt', 'Quinoa Bowl'
                ];
                
                const lunchSides = [
                    'French Fries', 'Side Salad', 'Cup of Soup', 'Potato Chips', 
                    'Coleslaw', 'Onion Rings', 'Iced Tea'
                ];
                
                const dinnerItems = [
                    'Grilled Salmon', 'Filet Mignon', 'Chicken Parmesan', 'Vegetable Curry', 
                    'Pasta Primavera', 'Ribeye Steak', 'Shrimp Scampi', 'Lobster Ravioli'
                ];
                
                const dinnerSides = [
                    'Garlic Mashed Potatoes', 'Roasted Vegetables', 'Caesar Salad', 
                    'Rice Pilaf', 'Asparagus', 'Truffle Mac & Cheese', 'Sparkling Water'
                ];
                
                if (mealType === 'Breakfast') {
                    return isSide ? 
                        breakfastSides[Math.floor(Math.random() * breakfastSides.length)] : 
                        breakfastItems[Math.floor(Math.random() * breakfastItems.length)];
                } else if (mealType === 'Lunch') {
                    return isSide ? 
                        lunchSides[Math.floor(Math.random() * lunchSides.length)] : 
                        lunchItems[Math.floor(Math.random() * lunchItems.length)];
                } else {
                    return isSide ? 
                        dinnerSides[Math.floor(Math.random() * dinnerSides.length)] : 
                        dinnerItems[Math.floor(Math.random() * dinnerItems.length)];
                }
            }

            function generateRandomAlcoholItem() {
                const alcoholItems = [
                    'Glass of Cabernet', 'House White Wine', 'Craft Beer', 'Imported Beer',
                    'Vodka Martini', 'Gin & Tonic', 'Whiskey Neat', 'Margarita'
                ];
                
                return alcoholItems[Math.floor(Math.random() * alcoholItems.length)];
            }
        });
    </script>
</body>
</html>